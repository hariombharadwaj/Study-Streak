<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="CHAIN">
  <meta name="theme-color" content="#f0fdf4">
  <title>CHAIN</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Space+Mono:wght@400;700&family=Nunito:wght@400;600;700;900&display=swap" rel="stylesheet">
  <style>
    :root {
      --green: #22c55e;
      --dark-green: #16a34a;
      --light-green: #86efac;
      --xlight-green: #dcfce7;
      --red: #ef4444;
      --dark-red: #dc2626;
      --bg: #f0fdf4;
      --card: #ffffff;
      --text: #14532d;
      --muted: #6b7280;
      --border: #d1fae5;
      --accent: #4ade80;
    }
    * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
    html, body { width:100%; min-height:100%; background:var(--bg); color:var(--text); font-family:'Nunito',sans-serif; overscroll-behavior:none; }

    /* ===== FIRE INTRO ===== */
    #fire-intro {
      position:fixed; inset:0; z-index:9999;
      background:linear-gradient(160deg,#f0fdf4 0%,#dcfce7 60%,#bbf7d0 100%);
      display:flex; flex-direction:column;
      align-items:center; justify-content:flex-end; overflow:hidden;
    }
    #fire-intro .title-wrap {
      position:absolute; top:30%; left:50%;
      transform:translateX(-50%); text-align:center; z-index:2;
    }
    #fire-intro .title-wrap h1 {
      font-family:'Bebas Neue',sans-serif;
      font-size:clamp(64px,18vw,120px); letter-spacing:8px; color:#14532d;
      opacity:0; animation:fadeUp .8s 1s forwards;
    }
    #fire-intro .title-wrap p {
      font-family:'Space Mono',monospace; font-size:12px;
      letter-spacing:5px; color:var(--dark-green); opacity:0;
      animation:fadeUp .8s 1.4s forwards; margin-top:6px;
    }
    @keyframes fadeUp { from{opacity:0;transform:translateY(14px)} to{opacity:1;transform:translateY(0)} }
    .fire-container { position:relative; width:100%; height:280px; }
    .flame {
      position:absolute; bottom:0; border-radius:50% 50% 20% 20%;
      transform-origin:bottom center;
      animation:flk var(--dur,1.2s) ease-in-out infinite alternate;
      filter:blur(var(--blur,2px));
    }
    @keyframes flk {
      0%   { transform:scaleX(1) scaleY(1) rotate(var(--r1,-2deg)); opacity:var(--o1,.9); }
      100% { transform:scaleX(var(--sx,.9)) scaleY(var(--sy,1.1)) rotate(var(--r2,2deg)); opacity:var(--o2,1); }
    }
    #fire-intro.fade-out { animation:fadeOutI .5s 3.2s forwards; }
    @keyframes fadeOutI { to{opacity:0;pointer-events:none} }
    #fire-intro.gone { display:none; }

    /* ===== APP ===== */
    #app { display:none; }
    #app.visible { display:block; }

    /* ===== BOTTOM NAV ===== */
    .bottom-nav {
      position:fixed; bottom:0; left:0; right:0;
      background:linear-gradient(135deg,#14532d,#166534);
      display:flex; align-items:center; justify-content:space-around;
      padding:10px 0 env(safe-area-inset-bottom,10px); z-index:100;
      box-shadow:0 -2px 20px rgba(20,83,45,.2);
    }
    .nav-btn {
      display:flex; flex-direction:column; align-items:center; gap:3px;
      background:none; border:none; cursor:pointer; color:#6ee7b7;
      font-family:'Nunito',sans-serif; font-size:9px; font-weight:700;
      letter-spacing:1px; padding:6px 10px; border-radius:10px; transition:color .2s;
    }
    .nav-btn.active { color:#4ade80; }
    .nav-btn svg { width:22px; height:22px; }

    /* ===== PAGES ===== */
    .page { display:none; padding-bottom:90px; }
    .page.active { display:block; }

    /* ===== TOP BAR ===== */
    .app-topbar {
      display:flex; align-items:center; justify-content:space-between;
      padding:14px 16px 10px;
      background:linear-gradient(135deg,#f0fdf4,#dcfce7);
      border-bottom:1px solid var(--border);
    }
    .app-name {
      font-family:'Bebas Neue',sans-serif;
      font-size:26px; letter-spacing:6px; color:#14532d;
    }

    /* ===== STREAK HERO ===== */
    .streak-hero {
      background:linear-gradient(135deg,#14532d 0%,#166534 50%,#15803d 100%);
      padding:22px 16px 18px; text-align:center; position:relative; overflow:hidden;
    }
    .streak-hero::before {
      content:''; position:absolute; inset:0;
      background:radial-gradient(circle at 30% 50%,rgba(74,222,128,.15) 0%,transparent 60%),
                 radial-gradient(circle at 80% 20%,rgba(134,239,172,.1) 0%,transparent 50%);
    }
    .streak-num-big {
      font-family:'Bebas Neue',sans-serif;
      font-size:clamp(80px,22vw,130px); line-height:1;
      color:#4ade80; position:relative;
      text-shadow:0 0 40px rgba(74,222,128,.4);
    }
    .streak-label {
      font-family:'Space Mono',monospace; font-size:11px;
      letter-spacing:5px; color:#86efac; margin-top:-4px;
    }
    .streak-badge-name {
      font-family:'Bebas Neue',sans-serif; font-size:22px;
      letter-spacing:4px; color:#fff; margin-top:8px;
    }

    /* ===== CURRENT BADGE HERO ===== */
    .current-badge-hero {
      background:var(--card); padding:16px 16px 12px;
      border-bottom:1px solid var(--border);
      text-align:center;
    }
    .badge-label-top {
      font-family:'Space Mono',monospace; font-size:11px;
      letter-spacing:4px; color:var(--muted); margin-bottom:6px;
    }
    .badge-hero-name {
      font-family:'Bebas Neue',sans-serif; font-size:34px;
      letter-spacing:4px; color:#14532d; margin-bottom:2px;
    }
    .badge-hero-day {
      font-family:'Space Mono',monospace; font-size:12px;
      letter-spacing:3px; color:var(--muted); margin-bottom:12px;
    }
    .badge-gif-area {
      width:100%; max-width:500px; margin:0 auto;
      height:200px; border-radius:16px; overflow:hidden;
      background:var(--xlight-green); position:relative; cursor:pointer;
      transition:transform .2s; border:2px solid var(--border);
    }
    .badge-gif-area:active { transform:scale(.98); }
    .badge-gif-area img { width:100%; height:100%; object-fit:cover; }
    .badge-gif-tap {
      width:100%; height:100%;
      display:flex; align-items:center; justify-content:center;
      font-family:'Space Mono',monospace; font-size:13px;
      color:#6b7280; background:var(--xlight-green);
    }

    /* Progress bar section */
    .progress-section {
      background:linear-gradient(135deg,#14532d,#166534);
      margin:12px 16px; border-radius:14px; padding:16px; color:#fff;
    }
    .progress-days-row {
      font-family:'Space Mono',monospace; font-size:13px;
      color:#86efac; margin-bottom:4px;
    }
    .progress-target-row {
      font-family:'Space Mono',monospace; font-size:11px;
      color:#4ade80; margin-bottom:12px;
      display:flex; align-items:center; gap:6px;
    }
    .progress-bar-track {
      height:26px; background:rgba(255,255,255,.15); border-radius:13px;
      overflow:hidden; position:relative;
    }
    .progress-bar-fill {
      height:100%; background:linear-gradient(90deg,#4ade80,#22c55e);
      border-radius:13px;
      transition:width .8s cubic-bezier(.4,0,.2,1);
      min-width:4px; position:relative;
    }
    .progress-bar-fill::after {
      content:''; position:absolute; right:0; top:0; bottom:0; width:20px;
      background:rgba(255,255,255,.3); border-radius:0 13px 13px 0;
    }
    .progress-pct {
      font-family:'Space Mono',monospace; font-size:12px;
      color:#86efac; text-align:center; margin-top:8px; letter-spacing:2px;
    }

    /* Check-in button */
    .checkin-wrap { padding:12px 16px; background:var(--card); border-bottom:1px solid var(--border); }
    .checkin-btn {
      width:100%; padding:16px; border:none; border-radius:14px;
      font-family:'Bebas Neue',sans-serif; font-size:22px;
      letter-spacing:3px; cursor:pointer; transition:all .2s;
    }
    .checkin-btn.available {
      background:linear-gradient(135deg,#22c55e,#16a34a); color:#fff;
      box-shadow:0 4px 20px rgba(34,197,94,.35);
    }
    .checkin-btn.available:active { transform:scale(.98); }
    .checkin-btn.done {
      background:var(--xlight-green); color:var(--dark-green);
      border:2px solid var(--green);
    }
    .timer-sm {
      text-align:center; margin-top:7px;
      font-family:'Space Mono',monospace; font-size:11px; color:var(--muted);
    }
    .timer-sm span { color:var(--red); font-weight:700; }

    /* ALL BADGES section */
    .all-badges-header {
      text-align:center; padding:16px 0 8px;
      font-family:'Space Mono',monospace; font-size:12px;
      letter-spacing:4px; color:var(--dark-green);
    }
    .all-badges-arrow {
      text-align:center; color:var(--green); font-size:20px; margin-bottom:8px;
    }

    /* Badge cards */
    .badges-list { padding:0 16px 20px; }
    .badge-card {
      border-radius:16px; margin-bottom:10px;
      display:flex; align-items:center;
      overflow:hidden; transition:transform .15s; cursor:pointer;
    }
    .badge-card:active { transform:scale(.99); }

    /* CURRENT = green gradient */
    .badge-card.state-current {
      background:linear-gradient(135deg,#16a34a,#15803d);
      box-shadow:0 4px 20px rgba(34,197,94,.3);
    }
    .badge-card.state-current .bc-left-text { color:#fff; }
    .badge-card.state-current .bc-day { color:rgba(255,255,255,.75); }

    /* PAST = dark green */
    .badge-card.state-past { background:linear-gradient(135deg,#14532d,#166534); }
    .badge-card.state-past .bc-left-text { color:#86efac; }
    .badge-card.state-past .bc-day { color:#4ade80; }

    /* FUTURE = smoky white / light green */
    .badge-card.state-future { background:#f9fffe; border:1px solid #d1fae5; }
    .badge-card.state-future .bc-left-text { color:#6b7280; }
    .badge-card.state-future .bc-day { color:#9ca3af; }

    .bc-left { flex:1; padding:18px 16px; }
    .bc-day { font-family:'Space Mono',monospace; font-size:10px; letter-spacing:2px; margin-bottom:4px; }
    .bc-left-text { font-family:'Bebas Neue',sans-serif; font-size:22px; letter-spacing:3px; }

    .bc-right { width:110px; height:74px; flex-shrink:0; position:relative; background:#e8f5e9; overflow:hidden; }
    .bc-right img { width:100%; height:100%; object-fit:cover; }
    .bc-right-tap { width:100%; height:100%; display:flex; align-items:center; justify-content:center; font-size:11px; color:#6b7280; font-family:'Space Mono',monospace; background:#f0fdf4; cursor:pointer; }
    .bc-right-locked { width:100%; height:100%; display:flex; align-items:center; justify-content:center; font-size:22px; background:#f9fffe; }

    /* ===== GRID PAGE ===== */
    .grid-page-header {
      padding:14px 16px 10px;
      background:linear-gradient(135deg,#f0fdf4,#dcfce7);
      border-bottom:1px solid var(--border);
    }
    .grid-tabs-row { display:flex; gap:8px; align-items:center; margin-top:10px; }
    .grid-tab {
      padding:7px 14px; border-radius:20px;
      border:2px solid #86efac; background:#f0fdf4;
      cursor:pointer; font-family:'Bebas Neue',sans-serif;
      font-size:15px; letter-spacing:2px; color:#6b7280;
      transition:all .2s;
    }
    .grid-tab.active { background:var(--green); border-color:var(--green); color:#fff; }
    .share-icon-btn { margin-left:auto; background:none; border:none; cursor:pointer; color:#16a34a; }

    .achieved-banner {
      margin:12px 16px; border-radius:14px; padding:18px;
      text-align:center; display:none;
      background:linear-gradient(135deg,var(--dark-green),var(--green));
      box-shadow:0 4px 20px rgba(34,197,94,.25);
    }
    .achieved-banner.show { display:block; }
    .achieved-banner h2 { font-family:'Bebas Neue',sans-serif; font-size:34px; letter-spacing:4px; color:#fff; }
    .achieved-banner p { font-size:13px; color:rgba(255,255,255,.85); margin-top:4px; }

    .grid-scroll-area { overflow-x:auto; padding:16px; -webkit-overflow-scrolling:touch; }
    .grid-scroll-area::-webkit-scrollbar { display:none; }
    .number-grid-wrapper { display:inline-flex; gap:14px; min-width:max-content; }
    .grid-table { border-collapse:collapse; }
    .gc { border:1px solid #ccc; font-family:'Space Mono',monospace; text-align:center; vertical-align:middle; background:#fff; transition:background .3s; color:#bbb; }
    .gc.filled { background:var(--green) !important; color:#fff !important; border-color:var(--dark-green) !important; font-weight:700; }
    .gc.today-cell { border:2px solid var(--red) !important; color:var(--red) !important; font-weight:700; }
    .gc.empty { background:#f8f8f8; border-color:#f0f0f0; color:transparent; pointer-events:none; }
    .grid-block { border:3px solid #14532d; display:inline-block; }

    /* ===== CHECK-IN LOG MODAL ===== */
    .modal-overlay { position:fixed; inset:0; background:rgba(0,0,0,.45); display:flex; align-items:flex-end; justify-content:center; z-index:9000; }
    .modal-sheet { background:#fff; border-radius:24px 24px 0 0; padding:24px 20px; width:100%; max-width:480px; max-height:80vh; overflow-y:auto; }
    .modal-title { font-family:'Bebas Neue',sans-serif; font-size:22px; letter-spacing:4px; color:#14532d; margin-bottom:16px; }
    .study-form label { font-family:'Space Mono',monospace; font-size:11px; letter-spacing:2px; color:var(--muted); display:block; margin-bottom:6px; margin-top:14px; }
    .study-form input, .study-form select {
      width:100%; padding:12px 14px; border:2px solid var(--border); border-radius:10px;
      font-family:'Nunito',sans-serif; font-size:14px; color:#111; background:#f9fafb; outline:none;
    }
    .study-form input:focus, .study-form select:focus { border-color:var(--green); }
    .study-form .time-row { display:flex; gap:10px; }
    .study-form .time-row > * { flex:1; }
    .study-form-btn {
      margin-top:18px; width:100%; padding:14px; background:linear-gradient(135deg,#22c55e,#16a34a);
      border:none; border-radius:12px; color:#fff;
      font-family:'Bebas Neue',sans-serif; font-size:20px; letter-spacing:3px; cursor:pointer;
    }

    /* ===== ANALYTICS PAGE ===== */
    .analytics-wrap { padding:0 0 20px; }
    /* Forest garden hero */
    .forest-hero {
      background:linear-gradient(180deg,#1a5c38 0%,#1e7a40 60%,#2d9e58 100%);
      padding:18px 16px 24px; position:relative; overflow:hidden;
    }
    .forest-period-bar {
      display:flex; background:rgba(0,0,0,.25); border-radius:20px; padding:3px;
      margin-bottom:14px; gap:2px;
    }
    .forest-period-btn {
      flex:1; padding:7px 4px; border-radius:18px; border:none; cursor:pointer;
      font-family:'Nunito',sans-serif; font-size:12px; font-weight:700;
      color:rgba(255,255,255,.6); background:transparent; transition:all .2s;
    }
    .forest-period-btn.active { background:#fff; color:#14532d; }
    .forest-date-nav { display:flex; align-items:center; justify-content:center; gap:12px; margin-bottom:14px; }
    .forest-date-nav span { font-family:'Nunito',sans-serif; font-size:14px; font-weight:700; color:#fff; }
    .forest-date-nav button { background:rgba(255,255,255,.15); border:none; color:#fff; width:28px; height:28px; border-radius:50%; cursor:pointer; font-size:16px; }
    /* SVG isometric forest */
    .forest-scene { width:100%; height:180px; display:block; margin:0 auto; }
    .forest-stats-row { display:flex; justify-content:flex-end; gap:14px; margin-top:8px; }
    .forest-stat { display:flex; align-items:center; gap:5px; font-family:'Nunito',sans-serif; font-size:13px; font-weight:700; color:#fff; }

    .analytics-card { background:#fff; border:1px solid var(--border); border-radius:0; padding:18px 16px; margin-bottom:1px; }
    .analytics-card:last-child { border-radius:0 0 16px 16px; }
    .analytics-title-lg { font-size:18px; font-weight:900; color:#111; margin-bottom:4px; font-family:'Nunito',sans-serif; }
    .analytics-sub { font-size:13px; color:#6b7280; margin-bottom:14px; }
    .analytics-sub span { color:var(--green); font-weight:700; }

    /* Bar chart */
    .bar-chart { display:flex; align-items:flex-end; gap:4px; height:200px; margin-bottom:6px; position:relative; padding-left:28px; }
    .bar-chart-grid { position:absolute; left:28px;right:0;top:0;bottom:0; display:flex; flex-direction:column; justify-content:space-between; pointer-events:none; }
    .bar-chart-line { border-top:1px solid #f0f0f0; width:100%; display:flex; align-items:center; }
    .bar-chart-line span { font-family:'Space Mono',monospace; font-size:8px; color:#bbb; margin-left:2px; position:absolute; left:0; white-space:nowrap; }
    .bar-item { flex:1; display:flex; flex-direction:column; align-items:center; gap:2px; position:relative; z-index:1; height:100%; justify-content:flex-end; }
    .bar-fill { width:75%; background:linear-gradient(180deg,#86efac,#22c55e,#16a34a); border-radius:6px 6px 0 0; min-height:4px; transition:height .7s cubic-bezier(.4,0,.2,1); box-shadow:0 2px 8px rgba(34,197,94,.3); }
    .bar-fill.today { background:linear-gradient(180deg,#bbf7d0,#4ade80,#22c55e); box-shadow:0 2px 12px rgba(74,222,128,.5); }
    .bar-label { font-family:'Space Mono',monospace; font-size:8px; color:var(--muted); text-align:center; }
    .bar-val { font-family:'Space Mono',monospace; font-size:8px; color:var(--dark-green); font-weight:700; }

    /* Line chart for "Most Focused Period" */
    .line-chart-wrap { width:100%; height:90px; position:relative; margin-bottom:6px; }
    .line-chart-wrap svg { width:100%; height:100%; }
    .chart-axis-label { display:flex; justify-content:space-between; font-family:'Space Mono',monospace; font-size:8px; color:#ccc; }

    /* Focus trend comparison bars */
    .trend-row { margin-bottom:12px; }
    .trend-row-label { font-size:12px; color:#6b7280; margin-bottom:4px; display:flex; justify-content:space-between; }
    .trend-row-label span { font-weight:700; color:#111; }
    .trend-bar-track { height:8px; background:#f0fdf4; border-radius:4px; overflow:hidden; }
    .trend-bar-fill { height:100%; background:linear-gradient(90deg,#4ade80,#22c55e); border-radius:4px; transition:width .8s; }
    .trend-compare { font-size:11px; color:var(--green); font-weight:700; margin-top:2px; }

    /* Donut chart */
    .donut-wrap { display:flex; align-items:center; gap:16px; }
    .donut-svg-wrap { position:relative; flex-shrink:0; }
    .donut-center-text { position:absolute; inset:0; display:flex; flex-direction:column; align-items:center; justify-content:center; }
    .donut-pct { font-family:'Bebas Neue',sans-serif; font-size:22px; color:#14532d; line-height:1; }
    .donut-lbl { font-family:'Space Mono',monospace; font-size:8px; color:#9ca3af; }
    .donut-legend { flex:1; }
    .donut-leg-row { display:flex; align-items:center; gap:8px; padding:5px 0; border-bottom:1px solid #f5f5f5; }
    .donut-leg-row:last-child { border-bottom:none; }
    .donut-dot { width:10px; height:10px; border-radius:50%; flex-shrink:0; }
    .donut-leg-name { flex:1; font-size:12px; font-weight:700; color:#333; }
    .donut-leg-pct { font-family:'Space Mono',monospace; font-size:10px; color:#6b7280; }
    .donut-leg-mins { font-family:'Space Mono',monospace; font-size:10px; color:var(--dark-green); font-weight:700; }

    /* Subject rows */
    .subject-row { display:flex; align-items:center; gap:10px; padding:8px 0; border-bottom:1px solid var(--border); }
    .subject-row:last-child { border-bottom:none; }
    .subject-dot { width:10px; height:10px; border-radius:50%; flex-shrink:0; }
    .subject-name { flex:1; font-size:13px; font-weight:700; color:#14532d; }
    .subject-hours { font-family:'Space Mono',monospace; font-size:11px; color:var(--muted); }

    /* ===== JOURNAL PAGE ===== */
    .journal-wrap { padding:12px 16px 20px; }
    .journal-form-card { background:#fff; border:1px solid var(--border); border-radius:14px; padding:16px; margin-bottom:14px; }
    .journal-form-title { font-family:'Bebas Neue',sans-serif; font-size:16px; letter-spacing:3px; color:#14532d; margin-bottom:10px; }
    .journal-textarea {
      width:100%; min-height:90px; background:var(--xlight-green);
      border:1px solid var(--border); border-radius:10px;
      padding:12px; color:#111; font-family:'Nunito',sans-serif;
      font-size:14px; line-height:1.6; resize:none; outline:none;
    }
    .journal-textarea:focus { border-color:var(--green); }
    .journal-save-btn {
      margin-top:10px; width:100%; padding:12px; background:linear-gradient(135deg,#22c55e,#16a34a);
      border:none; border-radius:10px; color:#fff;
      font-family:'Bebas Neue',sans-serif; font-size:18px; letter-spacing:3px; cursor:pointer;
    }
    /* Daily quote card */
    .quote-card {
      background:linear-gradient(135deg,#14532d,#166534);
      border-radius:14px; padding:20px 18px; margin-bottom:14px;
      position:relative; overflow:hidden;
    }
    .quote-card::before {
      content:'"'; position:absolute; top:-10px; left:10px;
      font-size:80px; color:rgba(74,222,128,.15);
      font-family:'Bebas Neue',sans-serif; line-height:1;
    }
    .quote-text { font-size:15px; line-height:1.7; color:#f0fdf4; font-weight:600; font-style:italic; position:relative; }
    .quote-author { font-family:'Space Mono',monospace; font-size:11px; color:#4ade80; margin-top:10px; letter-spacing:2px; }
    .quote-refresh-btn {
      position:absolute; top:12px; right:12px; background:rgba(255,255,255,.1);
      border:none; border-radius:8px; padding:6px 10px; color:#86efac;
      cursor:pointer; font-size:14px;
    }

    .journal-entry-card { background:#fff; border:1px solid var(--border); border-radius:12px; padding:14px; margin-bottom:10px; }
    .journal-entry-date { font-size:10px; color:var(--dark-green); font-family:'Space Mono',monospace; letter-spacing:2px; margin-bottom:4px; }
    .journal-entry-type { font-size:10px; color:#aaa; font-family:'Space Mono',monospace; letter-spacing:1px; margin-bottom:6px; }
    .journal-entry-text { font-size:14px; line-height:1.6; color:#333; }
    .journal-entry-streak { font-size:10px; color:var(--muted); margin-top:6px; }

    /* ===== SETTINGS PAGE ===== */
    .settings-wrap { padding:12px 16px 20px; }
    .settings-card { background:#fff; border:1px solid var(--border); border-radius:14px; padding:16px; margin-bottom:14px; }
    .settings-card-title { font-family:'Bebas Neue',sans-serif; font-size:14px; letter-spacing:4px; color:#14532d; margin-bottom:12px; }
    .setting-row { display:flex; align-items:center; justify-content:space-between; padding:11px 0; border-bottom:1px solid var(--border); }
    .setting-row:last-child { border-bottom:none; }
    .setting-label { font-size:14px; font-weight:700; }
    .setting-sub { font-size:10px; color:var(--muted); margin-top:2px; font-family:'Space Mono',monospace; }
    .toggle { width:44px; height:26px; background:#ddd; border-radius:13px; position:relative; cursor:pointer; transition:background .2s; flex-shrink:0; }
    .toggle.on { background:var(--green); }
    .toggle::after { content:''; position:absolute; width:20px; height:20px; border-radius:50%; background:#fff; top:3px; left:3px; transition:left .2s; box-shadow:0 1px 4px rgba(0,0,0,.2); }
    .toggle.on::after { left:21px; }
    .action-btn { padding:8px 14px; border-radius:8px; border:1px solid var(--border); background:#f9fafb; font-family:'Nunito',sans-serif; font-weight:700; font-size:12px; cursor:pointer; color:#333; }
    .action-btn.success { border-color:var(--green); color:var(--dark-green); }
    .action-btn.danger { border-color:var(--red); color:var(--red); }
    .reminder-tags { display:flex; flex-wrap:wrap; gap:6px; margin:8px 0; }
    .reminder-tag { display:inline-flex; align-items:center; gap:5px; padding:4px 10px; background:var(--xlight-green); border:1px solid var(--green); border-radius:8px; font-size:11px; font-family:'Space Mono',monospace; color:var(--dark-green); }
    .reminder-tag button { background:none; border:none; color:var(--red); cursor:pointer; font-size:14px; }
    .reminder-add-row { display:flex; gap:8px; margin-top:8px; }
    input[type="time"] { flex:1; padding:8px 12px; background:#f9fafb; border:1px solid var(--border); border-radius:8px; font-family:'Space Mono',monospace; font-size:12px; color:#111; outline:none; }
    .quotes-input { width:100%; padding:10px 12px; background:#f9fafb; border:1px solid var(--border); border-radius:8px; font-family:'Nunito',sans-serif; font-size:14px; color:#111; outline:none; margin-bottom:8px; }
    .quotes-input:focus { border-color:var(--green); }
    .quotes-author-row { display:flex; gap:8px; }
    .quotes-author-row input { flex:1; }
    .quotes-add-btn { padding:10px 16px; background:var(--green); border:none; border-radius:8px; color:#fff; font-family:'Bebas Neue',sans-serif; font-size:18px; cursor:pointer; }
    .custom-q-item { display:flex; align-items:center; gap:8px; padding:10px; background:var(--xlight-green); border-radius:8px; margin-bottom:6px; }
    .custom-q-text { flex:1; font-size:12px; color:#14532d; line-height:1.5; }
    .custom-q-del { background:none; border:none; color:var(--red); cursor:pointer; font-size:18px; }
    .gif-item { margin-bottom:10px; padding:10px; background:var(--xlight-green); border-radius:10px; border:1px solid var(--border); }
    .gif-label { font-family:'Bebas Neue',sans-serif; font-size:13px; letter-spacing:2px; color:#14532d; margin-bottom:6px; }
    .gif-input { width:100%; padding:8px; background:#fff; border:1px solid var(--border); border-radius:8px; font-size:12px; color:#111; outline:none; }
    .gif-input:focus { border-color:var(--green); }

    /* ===== TOAST ===== */
    .toast { position:fixed; top:20px; left:50%; transform:translateX(-50%); background:#14532d; color:#86efac; padding:12px 22px; border-radius:50px; font-weight:700; font-size:14px; z-index:9998; white-space:nowrap; box-shadow:0 4px 20px rgba(0,0,0,.15); animation:toastIn .35s cubic-bezier(.34,1.56,.64,1); }
    @keyframes toastIn { from{transform:translateX(-50%) translateY(-16px);opacity:0} to{transform:translateX(-50%) translateY(0);opacity:1} }

    /* ===== SUCCESS CARD ===== */
    .success-overlay { position:fixed; inset:0; background:rgba(0,0,0,.5); display:flex; align-items:center; justify-content:center; z-index:9997; }
    .success-card { background:#fff; border-radius:20px; padding:36px 28px; text-align:center; max-width:300px; width:90%; box-shadow:0 20px 60px rgba(0,0,0,.2); animation:popIn .4s cubic-bezier(.34,1.56,.64,1); }
    @keyframes popIn { from{transform:scale(.6);opacity:0} to{transform:scale(1);opacity:1} }
    .success-emoji-big { font-size:56px; }
    .success-title { font-family:'Bebas Neue',sans-serif; font-size:32px; color:var(--green); letter-spacing:3px; margin-top:8px; }
    .success-big-num { font-family:'Bebas Neue',sans-serif; font-size:72px; line-height:1; color:#14532d; }
    .success-sub { font-size:11px; letter-spacing:4px; color:var(--muted); }
    .success-badge { font-family:'Bebas Neue',sans-serif; font-size:20px; color:var(--dark-green); letter-spacing:2px; margin-top:8px; }
    .success-close-btn { margin-top:20px; width:100%; padding:14px; background:linear-gradient(135deg,#22c55e,#16a34a); border:none; border-radius:12px; color:#fff; font-family:'Bebas Neue',sans-serif; font-size:20px; letter-spacing:2px; cursor:pointer; }

    ::-webkit-scrollbar { width:3px; height:3px; }
    ::-webkit-scrollbar-track { background:transparent; }
    ::-webkit-scrollbar-thumb { background:#86efac; border-radius:3px; }

    /* Subject color dots */
    .c0{background:#22c55e} .c1{background:#3b82f6} .c2{background:#f59e0b} .c3{background:#ef4444} .c4{background:#8b5cf6} .c5{background:#ec4899} .c6{background:#14b8a6} .c7{background:#f97316}
  </style>
</head>
<body>

<!-- FIRE INTRO -->
<div id="fire-intro">
  <div class="title-wrap">
    <h1>CHAIN</h1>
    <p>DON'T BREAK THE CHAIN</p>
  </div>
  <div class="fire-container" id="fireContainer"></div>
</div>

<!-- MAIN APP -->
<div id="app">

  <!-- ===== BADGES PAGE (Tab 1) ===== -->
  <div class="page active" id="page-badges">
    <div class="app-topbar">
      <div class="app-name">CHAIN</div>
      <div style="font-family:'Bebas Neue',sans-serif;font-size:20px;color:var(--dark-green);" id="headerStreak">0 üî•</div>
    </div>

    <!-- BIG STREAK HERO (merged, no duplicate) -->
    <div class="streak-hero">
      <div class="streak-num-big" id="streakNumBig">0</div>
      <div class="streak-label">D A Y S &nbsp; S T R O N G</div>
      <div class="streak-badge-name" id="streakBadgeHero">üå± BELIEVER</div>
      <div class="badge-gif-area" id="heroBadgeGif" onclick="toggleHeroReveal()" style="max-width:340px;height:170px;margin:14px auto 0;border:2px solid rgba(255,255,255,.2);">
        <div class="badge-gif-tap" style="background:rgba(0,0,0,.2);color:rgba(255,255,255,.5);">No GIF ‚Äî add one in Settings</div>
      </div>
    </div>

    <!-- Progress section -->
    <div class="progress-section">
      <div class="progress-days-row" id="progressDaysRow">CURRENT DAYS: 0</div>
      <div class="progress-target-row">
        <span>NEXT TARGET</span>
        <span>‚Üí</span>
        <span id="progressTarget">1 DAYS</span>
      </div>
      <div class="progress-bar-track">
        <div class="progress-bar-fill" id="progressFill" style="width:0%"></div>
      </div>
      <div class="progress-pct" id="progressPct">0.0% COMPLETED</div>
    </div>

    <!-- Check-in button -->
    <div class="checkin-wrap">
      <button class="checkin-btn available" id="checkinBtn" onclick="handleCheckin()">‚úì CHECK IN TODAY</button>
      <div class="timer-sm">‚è∞ Resets at midnight ¬∑ <span id="timerDisplay">--:--:--</span> left</div>
    </div>

    <div class="all-badges-header">A L L &nbsp; B A D G E S</div>
    <div class="all-badges-arrow">‚Üì</div>
    <div class="badges-list" id="badgesList"></div>
  </div>

  <!-- ===== GRID PAGE (Tab 2) ===== -->
  <div class="page" id="page-grid">
    <div class="grid-page-header">
      <div class="app-name">CHAIN</div>
      <div class="grid-tabs-row">
        <button class="grid-tab active" onclick="setGridTab(90,this)">90 DAYS</button>
        <button class="grid-tab" onclick="setGridTab(180,this)">180 DAYS</button>
        <button class="grid-tab" onclick="setGridTab(365,this)">365 DAYS</button>
        <button class="share-icon-btn" onclick="shareApp()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="22" height="22"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/></svg>
        </button>
      </div>
    </div>
    <div class="achieved-banner" id="banner90"><h2>üèÜ 90 DAYS ACHIEVED!</h2><p>Incredible discipline. You've completed the 90-day challenge!</p></div>
    <div class="achieved-banner" id="banner180"><h2>ü•á 180 DAYS ACHIEVED!</h2><p>Half a year of pure commitment. You are unstoppable!</p></div>
    <div class="achieved-banner" id="banner365"><h2>üëë 365 DAYS ACHIEVED!</h2><p>ONE FULL YEAR! Legend status unlocked.</p></div>
    <div class="grid-scroll-area">
      <div class="number-grid-wrapper" id="gridWrapper"></div>
    </div>
  </div>

  <!-- ===== JOURNAL PAGE (Tab 3) ===== -->
  <div class="page" id="page-journal">
    <div class="app-topbar"><div class="app-name">JOURNAL</div></div>
    <div class="journal-wrap">
      <!-- Daily Motivation Quote -->
      <div class="quote-card" id="dailyQuoteCard">
        <button class="quote-refresh-btn" onclick="showNewQuote()">‚Üª</button>
        <div class="quote-text" id="quoteText">Loading inspiration...</div>
        <div class="quote-author" id="quoteAuthor">‚Äî CHAIN</div>
      </div>

      <div class="journal-form-card">
        <div class="journal-form-title">TODAY'S ENTRY</div>
        <textarea class="journal-textarea" id="journalInput" placeholder="Write your thoughts, struggles, wins..."></textarea>
        <button class="journal-save-btn" onclick="saveJournal()">SAVE ENTRY</button>
      </div>

      <!-- Sort / Filter bar -->
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px;flex-wrap:wrap;">
        <div style="font-family:'Bebas Neue',sans-serif;font-size:13px;letter-spacing:4px;color:#14532d;flex:1;">ALL ENTRIES</div>
        <select id="journalSort" onchange="renderJournal()" style="padding:5px 8px;border:1px solid var(--border);border-radius:8px;font-size:11px;font-family:'Space Mono',monospace;color:#14532d;background:#f0fdf4;outline:none;">
          <option value="newest">Newest first</option>
          <option value="oldest">Oldest first</option>
        </select>
        <input type="date" id="journalDateFilter" onchange="renderJournal()" style="padding:5px 8px;border:1px solid var(--border);border-radius:8px;font-size:11px;font-family:'Space Mono',monospace;color:#14532d;background:#f0fdf4;outline:none;">
        <button onclick="document.getElementById('journalDateFilter').value='';renderJournal();" style="padding:5px 8px;border:1px solid var(--border);border-radius:8px;font-size:11px;background:#f0fdf4;cursor:pointer;color:#6b7280;">Clear</button>
      </div>
      <div id="journalList"></div>
    </div>
  </div>

  <!-- Journal Entry Detail Modal -->
  <div id="journalDetailModal" class="modal-overlay" style="display:none;" onclick="if(event.target===this)closeJournalDetail()">
    <div class="modal-sheet" style="max-height:85vh;">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;">
        <div class="modal-title" style="margin-bottom:0;" id="journalDetailTitle">ENTRY</div>
        <button onclick="closeJournalDetail()" style="background:none;border:none;font-size:22px;cursor:pointer;color:#6b7280;">√ó</button>
      </div>
      <div id="journalDetailDate" style="font-family:'Space Mono',monospace;font-size:10px;color:var(--dark-green);letter-spacing:2px;margin-bottom:6px;"></div>
      <div id="journalDetailStreak" style="font-family:'Space Mono',monospace;font-size:10px;color:#6b7280;margin-bottom:14px;"></div>
      <div id="journalDetailText" style="font-size:15px;line-height:1.8;color:#333;white-space:pre-wrap;"></div>
    </div>
  </div>

  <!-- ===== ANALYTICS PAGE (Tab 4) ===== -->
  <div class="page" id="page-analytics">
    <div class="app-topbar" style="flex-wrap:wrap;gap:8px;">
      <div class="app-name">ANALYTICS</div>
      <button onclick="resetAnalytics()" style="padding:6px 12px;border:1px solid #ef4444;border-radius:8px;background:#fff5f5;color:#ef4444;font-family:'Space Mono',monospace;font-size:10px;cursor:pointer;font-weight:700;">RESET DATA</button>
    </div>
    <div class="analytics-wrap">
      <!-- Period Header -->
      <div class="forest-hero">
        <div class="forest-period-bar">
          <button class="forest-period-btn active" onclick="setForestPeriod('day',this)">Day</button>
          <button class="forest-period-btn" onclick="setForestPeriod('week',this)">Week</button>
          <button class="forest-period-btn" onclick="setForestPeriod('month',this)">Month</button>
          <button class="forest-period-btn" onclick="setForestPeriod('year',this)">Year</button>
        </div>
        <div class="forest-date-nav">
          <button onclick="shiftPeriod(-1)">‚Äπ</button>
          <span id="forestDateLabel">Today</span>
          <button onclick="shiftPeriod(1)">‚Ä∫</button>
        </div>
        <!-- Summary stats instead of forest -->
        <div style="display:flex;gap:10px;margin-top:8px;">
          <div style="flex:1;background:rgba(255,255,255,.15);border-radius:12px;padding:12px;text-align:center;">
            <div style="font-family:'Bebas Neue',sans-serif;font-size:28px;color:#fff;" id="statTotalHours">0h</div>
            <div style="font-family:'Space Mono',monospace;font-size:9px;color:#86efac;">TOTAL STUDY</div>
          </div>
          <div style="flex:1;background:rgba(255,255,255,.15);border-radius:12px;padding:12px;text-align:center;">
            <div style="font-family:'Bebas Neue',sans-serif;font-size:28px;color:#fff;" id="statSessions">0</div>
            <div style="font-family:'Space Mono',monospace;font-size:9px;color:#86efac;">SESSIONS</div>
          </div>
          <div style="flex:1;background:rgba(255,255,255,.15);border-radius:12px;padding:12px;text-align:center;">
            <div style="font-family:'Bebas Neue',sans-serif;font-size:28px;color:#fff;" id="statPeak">‚Äî</div>
            <div style="font-family:'Space Mono',monospace;font-size:9px;color:#86efac;">PEAK HOUR</div>
          </div>
        </div>
      </div>

      <!-- Focused Time Distribution -->
      <div class="analytics-card">
        <div class="analytics-title-lg">Focused Time Distribution</div>
        <div class="analytics-sub">Total: <span id="totalFocused">0</span></div>
        <div class="bar-chart" id="studyBarChart">
          <div class="bar-chart-grid" id="barChartGrid"></div>
        </div>
        <div class="chart-axis-label" id="barAxisLabels"></div>
      </div>

      <!-- Most Focused Period -->
      <div class="analytics-card">
        <div class="analytics-title-lg">Most Focused Period of The Day</div>
        <div class="analytics-sub">Most focused at <span id="peakHourLabel">‚Äî</span> every day in general</div>
        <div class="line-chart-wrap">
          <svg id="lineChartSvg" viewBox="0 0 300 80" xmlns="http://www.w3.org/2000/svg" style="width:100%;height:80px;"></svg>
        </div>
        <div class="chart-axis-label">
          <span>00:00</span><span>06:00</span><span>12:00</span><span>18:00</span><span>23:00</span>
        </div>
      </div>

      <!-- Focus Trend -->
      <div class="analytics-card">
        <div class="analytics-title-lg">Focus Trend</div>
        <div id="trendSection"></div>
      </div>

      <!-- Subject Distribution Donut -->
      <div class="analytics-card">
        <div class="analytics-title-lg">Subject Distribution</div>
        <div id="donutEmpty" style="display:none;text-align:center;color:#9ca3af;font-size:12px;padding:14px;">No data yet for this period</div>
        <div class="donut-wrap" style="margin-top:10px;" id="donutWrap">
          <div class="donut-svg-wrap">
            <svg id="donutSvg" viewBox="0 0 120 120" width="120" height="120"></svg>
            <div class="donut-center-text">
              <div class="donut-pct" id="donutTopPct">‚Äî</div>
              <div class="donut-lbl">TOP</div>
            </div>
          </div>
          <div class="donut-legend" id="donutLegend"></div>
        </div>
      </div>

      <!-- All Study Logs (permanent, only deleted on explicit user action) -->
      <div class="analytics-card" style="border-radius:0 0 16px 16px;">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;">
          <div class="analytics-title-lg" style="margin-bottom:0;">All Study Logs</div>
          <span style="font-family:'Space Mono',monospace;font-size:9px;color:#9ca3af;">KEPT FOREVER</span>
        </div>
        <div id="studyLogList"></div>
      </div>
    </div>
  </div>

  <!-- ===== SETTINGS PAGE (Tab 5) ===== -->
  <div class="page" id="page-settings">
    <div class="app-topbar"><div class="app-name">SETTINGS</div></div>
    <div class="settings-wrap">

      <div class="settings-card">
        <div class="settings-card-title">NOTIFICATIONS</div>
        <div class="setting-row">
          <div><div class="setting-label">Daily Reminders</div><div class="setting-sub">PUSH ALERTS</div></div>
          <div class="toggle" id="notifToggle" onclick="toggleNotifications()"></div>
        </div>
        <div id="reminderSection" style="display:none;margin-top:10px;">
          <div style="font-size:11px;color:var(--muted);font-family:'Space Mono',monospace;margin-bottom:6px;">REMINDER TIMES</div>
          <div class="reminder-tags" id="reminderTags"></div>
          <div class="reminder-add-row">
            <input type="time" id="newReminderTime" value="20:00">
            <button class="action-btn success" onclick="addReminder()">ADD</button>
          </div>
        </div>
      </div>

      <div class="settings-card">
        <div class="settings-card-title">MY QUOTES</div>
        <p style="font-size:11px;color:var(--muted);margin-bottom:10px;font-family:'Space Mono',monospace;">APPEAR IN JOURNAL DAILY INSPIRATION</p>
        <input type="text" class="quotes-input" id="quoteTextInput" placeholder="Enter your motivational quote...">
        <div class="quotes-author-row">
          <input type="text" class="quotes-input" id="quoteAuthorInput" placeholder="Author (optional)">
          <button class="quotes-add-btn" onclick="addCustomQuote()">ADD</button>
        </div>
        <div id="customQuotesList"></div>
      </div>

      <div class="settings-card">
        <div class="settings-card-title">DATA</div>
        <div class="setting-row">
          <div><div class="setting-label">Export Backup</div><div class="setting-sub">DOWNLOAD JSON</div></div>
          <button class="action-btn success" onclick="exportData()">EXPORT</button>
        </div>
        <div class="setting-row">
          <div><div class="setting-label">Import Backup</div><div class="setting-sub">RESTORE DATA</div></div>
          <button class="action-btn" onclick="document.getElementById('importFile').click()">IMPORT</button>
        </div>
        <input type="file" id="importFile" accept=".json" style="display:none" onchange="importData(event)">
        <div class="setting-row">
          <div><div class="setting-label">Reset Streak</div><div class="setting-sub">‚ö†Ô∏è IRREVERSIBLE</div></div>
          <button class="action-btn danger" onclick="resetStreak()">RESET</button>
        </div>
      </div>

      <div class="settings-card">
        <div class="settings-card-title">BADGE GIF URLS</div>
        <p style="font-size:11px;color:var(--muted);margin-bottom:12px;font-family:'Space Mono',monospace;">PASTE GIPHY / TENOR DIRECT GIF LINKS</p>
        <div id="gifSettings" style="max-height:320px;overflow-y:auto;"></div>
      </div>
    </div>
  </div>

  <!-- BOTTOM NAV -->
  <nav class="bottom-nav">
    <button class="nav-btn active" onclick="switchPage('badges',this)" id="nav-badges">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
      BADGES
    </button>
    <button class="nav-btn" onclick="switchPage('grid',this)" id="nav-grid">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
      CHECKIN
    </button>
    <button class="nav-btn" onclick="switchPage('journal',this)" id="nav-journal">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
      JOURNAL
    </button>
    <button class="nav-btn" onclick="switchPage('analytics',this)" id="nav-analytics">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
      ANALYTICS
    </button>
    <button class="nav-btn" onclick="switchPage('settings',this)" id="nav-settings">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/></svg>
      SETTINGS
    </button>
  </nav>
</div>

<!-- Study Log Modal -->
<div id="studyModal" class="modal-overlay" style="display:none;" onclick="if(event.target===this)closeStudyModal()">
  <div class="modal-sheet">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;">
      <div class="modal-title" style="margin-bottom:0;">üìö LOG TODAY'S STUDY</div>
      <button onclick="closeStudyModal()" style="background:none;border:none;font-size:22px;cursor:pointer;color:#6b7280;">√ó</button>
    </div>
    <div class="study-form">
      <label>SUBJECT</label>
      <input type="text" id="studySubject" placeholder="e.g. Math, Physics, English...">
      <label>START TIME</label>
      <input type="time" id="studyStartTime">
      <label>END TIME</label>
      <input type="time" id="studyEndTime" onchange="calcDuration()">
      <div id="durationDisplay" style="font-family:'Space Mono',monospace;font-size:12px;color:var(--dark-green);margin-top:6px;min-height:18px;"></div>
      <label>JOURNAL / NOTES <span style="font-size:9px;color:#9ca3af;">(synced to Journal)</span></label>
      <textarea id="studyNotes" style="width:100%;min-height:70px;padding:10px;border:2px solid var(--border);border-radius:10px;font-family:'Nunito',sans-serif;font-size:13px;resize:none;outline:none;background:#f9fafb;" placeholder="What did you study? How did it feel?"></textarea>
      <button class="study-form-btn" onclick="saveStudyLog()">SAVE & CHECK IN ‚úì</button>
    </div>
  </div>
</div>

<script>
// ===== STORAGE =====
const K={STREAK:'ch_streak',LAST:'ch_last',DATES:'ch_dates',JOURNAL:'ch_journal',GIFS:'ch_gifs',CQUOTES:'ch_cquotes',NOTIF:'ch_notif',RTIMES:'ch_rtimes',REVEALED:'ch_revealed',STUDYLOGS:'ch_studylogs'};
const sv=(k,v)=>{try{localStorage.setItem(k,JSON.stringify(v));}catch(e){}};
const ld=(k,d)=>{try{const v=localStorage.getItem(k);return v!==null?JSON.parse(v):d;}catch(e){return d;}};

// ===== INDEXEDDB BACKUP LAYER =====
// IDB acts as a secondary backup so data survives even if localStorage is cleared
let idb=null;
const IDB_NAME='chain_backup',IDB_STORE='kv',IDB_VER=1;
function openIDB(){
  return new Promise((res,rej)=>{
    const req=indexedDB.open(IDB_NAME,IDB_VER);
    req.onupgradeneeded=e=>{e.target.result.createObjectStore(IDB_STORE,{keyPath:'k'});};
    req.onsuccess=e=>{res(e.target.result);};
    req.onerror=()=>rej();
  });
}
async function idbSet(k,v){
  try{
    if(!idb)idb=await openIDB();
    const tx=idb.transaction(IDB_STORE,'readwrite');
    tx.objectStore(IDB_STORE).put({k,v:JSON.stringify(v)});
  }catch(e){}
}
async function idbGet(k,def){
  try{
    if(!idb)idb=await openIDB();
    return new Promise((res)=>{
      const tx=idb.transaction(IDB_STORE,'readonly');
      const req=tx.objectStore(IDB_STORE).get(k);
      req.onsuccess=()=>{
        if(req.result)res(JSON.parse(req.result.v));
        else res(def);
      };
      req.onerror=()=>res(def);
    });
  }catch(e){return def;}
}
// On load, if localStorage is empty but IDB has data, restore from IDB
async function restoreFromIDBIfNeeded(){
  const lsEmpty=!localStorage.getItem(K.STREAK)&&!localStorage.getItem(K.STUDYLOGS);
  if(!lsEmpty)return;
  const keys=Object.values(K);
  for(const k of keys){
    const v=await idbGet(k,null);
    if(v!==null){try{localStorage.setItem(k,JSON.stringify(v));}catch(e){}}
  }
}
// Sync ALL data to IDB whenever we save (call this after any sv() block)
function syncToIDB(){
  Object.values(K).forEach(k=>{
    const v=ld(k,null);
    if(v!==null)idbSet(k,v);
  });
}

// ===== AUTO-EXPORT REMINDER =====
const LAST_EXPORT_KEY='ch_last_export';
function checkExportReminder(){
  const last=localStorage.getItem(LAST_EXPORT_KEY);
  if(!last)return; // never exported, no reminder until they export once
  const daysSince=Math.floor((Date.now()-Number(last))/(1000*60*60*24));
  if(daysSince>=7&&S.studylogs.length>0){
    setTimeout(()=>{
      showToast('üíæ Reminder: Back up your data! (Settings ‚Üí Export)');
    },4000);
  }
}
function markExported(){localStorage.setItem(LAST_EXPORT_KEY,String(Date.now()));}

// ===== STATE =====
let S={
  streak:ld(K.STREAK,0), last:ld(K.LAST,null), dates:ld(K.DATES,[]),
  journal:ld(K.JOURNAL,[]), gifs:ld(K.GIFS,{}), cquotes:ld(K.CQUOTES,[]),
  notif:ld(K.NOTIF,false), rtimes:ld(K.RTIMES,['15:00','20:00','22:00']),
  revealed:ld(K.REVEALED,{}), studylogs:ld(K.STUDYLOGS,[]),
};

// ===== BUILT-IN MOTIVATIONAL QUOTES =====
const BUILTIN_QUOTES = [
  {text:"The secret of getting ahead is getting started.",author:"Mark Twain"},
  {text:"Don't watch the clock; do what it does. Keep going.",author:"Sam Levenson"},
  {text:"It always seems impossible until it's done.",author:"Nelson Mandela"},
  {text:"Success is the sum of small efforts, repeated day in and day out.",author:"Robert Collier"},
  {text:"The only way to do great work is to love what you do.",author:"Steve Jobs"},
  {text:"Discipline is the bridge between goals and accomplishment.",author:"Jim Rohn"},
  {text:"We are what we repeatedly do. Excellence is not an act, but a habit.",author:"Aristotle"},
  {text:"You don't have to be great to start, but you have to start to be great.",author:"Zig Ziglar"},
  {text:"Push yourself, because no one else is going to do it for you.",author:"Unknown"},
  {text:"Great things never come from comfort zones.",author:"Unknown"},
  {text:"Dream it. Wish it. Do it.",author:"Unknown"},
  {text:"Success doesn't just find you. You have to go out and get it.",author:"Unknown"},
  {text:"The harder you work for something, the greater you'll feel when you achieve it.",author:"Unknown"},
  {text:"Don't stop when you're tired. Stop when you're done.",author:"Unknown"},
  {text:"Wake up with determination. Go to bed with satisfaction.",author:"Unknown"},
  {text:"Do something today that your future self will thank you for.",author:"Unknown"},
  {text:"Little things make big days.",author:"Unknown"},
  {text:"It's going to be hard, but hard does not mean impossible.",author:"Unknown"},
  {text:"One day or day one. You decide.",author:"Unknown"},
  {text:"Keep your eyes on the stars, and your feet on the ground.",author:"Theodore Roosevelt"},
];
let curQuoteIdx = Math.floor(Math.random()*BUILTIN_QUOTES.length);

function getAllQuotes(){
  const custom = S.cquotes.map(q=>({text:q.text,author:q.author||'YOU'}));
  return [...BUILTIN_QUOTES,...custom];
}
function showNewQuote(){
  const all=getAllQuotes();
  curQuoteIdx=(curQuoteIdx+1)%all.length;
  const q=all[curQuoteIdx];
  document.getElementById('quoteText').textContent=q.text;
  document.getElementById('quoteAuthor').textContent='‚Äî '+q.author;
}
function renderDailyQuote(){
  const all=getAllQuotes();
  const q=all[curQuoteIdx%all.length];
  document.getElementById('quoteText').textContent=q.text;
  document.getElementById('quoteAuthor').textContent='‚Äî '+q.author;
}

// ===== BADGES =====
const BADGES=[
  {day:0,  name:'BELIEVER',      emoji:'üå±',desc:'Start of the journey'},
  {day:1,  name:'KID',           emoji:'üë∂',desc:'First day done!'},
  {day:2,  name:'COOL KID',      emoji:'üòé',desc:'Two days in'},
  {day:3,  name:'NEWBIE',        emoji:'üéØ',desc:'Three days strong'},
  {day:4,  name:'BEGINNER',      emoji:'üî•',desc:'Building habits'},
  {day:5,  name:'RECRUIT',       emoji:'‚ö°',desc:'Almost a week'},
  {day:6,  name:'MEMBER',        emoji:'üí™',desc:'Six days committed'},
  {day:7,  name:'WEEK WARRIOR',  emoji:'üèÜ',desc:'One full week!'},
  {day:8,  name:'ELITE MEMBER',  emoji:'ü¶Å',desc:'Elite status'},
  {day:9,  name:'SUPE',          emoji:'ü¶∏',desc:'Superhuman effort'},
  {day:10, name:'CAPTAIN',       emoji:'‚öì',desc:'Captain of destiny'},
  {day:11, name:'PERFECTIONIST', emoji:'üíé',desc:'Flawless streak'},
  {day:12, name:'SUPER SAIYAN',  emoji:'‚ö°',desc:'Power level rising'},
  {day:13, name:'INVINCIBLE',    emoji:'üõ°Ô∏è',desc:'Nothing stops you'},
  {day:14, name:'URGE SMASHER',  emoji:'üî®',desc:'Two full weeks!'},
  {day:15, name:'BADASS',        emoji:'üí•',desc:'15 days discipline'},
  {day:16, name:'WOLF',          emoji:'üê∫',desc:'Pack leader mentality'},
  {day:17, name:'LONE WOLF',     emoji:'üåï',desc:'Solo discipline king'},
  {day:18, name:'ALPHA',         emoji:'ü¶Ö',desc:'Alpha mindset unlocked'},
  {day:19, name:'PREDATOR',      emoji:'üêÜ',desc:'Relentless pursuit'},
  {day:20, name:'HUNTER',        emoji:'üèπ',desc:'On the hunt daily'},
  {day:21, name:'TITAN',         emoji:'‚öîÔ∏è',desc:'Three weeks done!'},
  {day:22, name:'BADASS MASTER', emoji:'üî±',desc:'Mastery begins here'},
  {day:30, name:'MONK',          emoji:'üßò',desc:'One full month!'},
  {day:31, name:'CHAMP',         emoji:'ü•á',desc:'Champion mindset'},
  {day:45, name:'IRON WILL',     emoji:'‚öôÔ∏è',desc:'Unbreakable will'},
  {day:46, name:'CONQUEROR',     emoji:'üè∞',desc:'Conquering fears'},
  {day:60, name:'GLADIATOR',     emoji:'üèõÔ∏è',desc:'Two months strong'},
  {day:66, name:'LEGEND',        emoji:'üåü',desc:'Legendary discipline'},
  {day:90, name:'IMMORTAL',      emoji:'üîÆ',desc:'90 days ‚Äî pure gold'},
  {day:91, name:'SENSEI',        emoji:'ü•ã',desc:'Teaching by example'},
  {day:120,name:'DEMIGOD',       emoji:'‚ö°',desc:'Beyond human limits'},
  {day:121,name:'KING',          emoji:'üëë',desc:'King of discipline'},
  {day:150,name:'GOD MODE',      emoji:'üåå',desc:'Operating in god mode'},
  {day:180,name:'HALF YEAR',     emoji:'üìÖ',desc:'Six months of glory'},
  {day:200,name:'OVERLORD',      emoji:'üåê',desc:'Overlord status'},
  {day:201,name:'KRATOS',        emoji:'‚öîÔ∏è',desc:'God of War energy'},
  {day:300,name:'MATRIX ESCAPEE',emoji:'üï¥Ô∏è',desc:'Escaped the matrix'},
  {day:365,name:'ONE YEAR KING', emoji:'üéñÔ∏è',desc:'One year. Respect.'},
];

function getCurBadge(){let b=BADGES[0];for(let x of BADGES){if(S.streak>=x.day)b=x;else break;}return b;}
function getNextBadge(){for(let x of BADGES){if(x.day>S.streak)return x;}return null;}

// ===== PROGRESS ‚Äî NEW LOGIC: progress is FROM prevBadge baseline =====
// The idea: once you hit badge X (e.g. day 7), you "own" those 7 days.
// Progress shows how far you've gone from X toward next badge Y.
// BUT we start the fill at e.g. 10% (visual motivator that you've already "owned" the prev badge).
// This is the "already completed = fills faster" pattern.
function getProgress(){
  const cur=getCurBadge(), nxt=getNextBadge();
  if(!nxt)return{pct:100,target:'MAX',prev:cur.day,curDay:cur.day,nextDay:null};
  const nextDay=nxt.day;
  // Logic: percentage = (current streak / next target) * 100
  // So if streak=1, target=2 ‚Üí 1/2 * 100 = 50% COMPLETED
  const pct=nextDay>0?Math.min(100,(S.streak/nextDay)*100):100;
  return{pct,target:nextDay,prev:cur.day,curDay:cur.day,nextDay};
}

function updateProgressUI(){
  const{pct,target}=getProgress();
  document.getElementById('progressDaysRow').textContent='CURRENT DAYS: '+S.streak;
  document.getElementById('progressTarget').textContent=(target==='MAX'?'MAX ACHIEVED':target+' DAYS');
  document.getElementById('progressFill').style.width=pct.toFixed(1)+'%';
  document.getElementById('progressPct').textContent=pct.toFixed(1)+'% COMPLETED';
}

// ===== HERO GIF REVEAL =====
let heroRevealed=false;
function toggleHeroReveal(){
  const cur=getCurBadge();
  if(!S.gifs[cur.day])return;
  heroRevealed=!heroRevealed;
  renderHeroGif();
}
function renderHeroGif(){
  const cur=getCurBadge();
  const area=document.getElementById('heroBadgeGif');
  if(S.gifs[cur.day]){
    if(heroRevealed){
      area.innerHTML='<img src="'+S.gifs[cur.day]+'" alt="'+cur.name+'">';
    } else {
      area.innerHTML='<div class="badge-gif-tap">Tap to Play</div>';
    }
  } else {
    area.innerHTML='<div class="badge-gif-tap">No GIF ‚Äî add one in Settings</div>';
  }
}

// ===== RENDER BADGES LIST =====
function renderBadges(){
  const list=document.getElementById('badgesList');
  list.innerHTML='';
  const cur=getCurBadge();

  BADGES.forEach(badge=>{
    const isPast=S.streak>badge.day;
    const isCurrent=badge.day===cur.day;
    const isFuture=badge.day>S.streak;

    const card=document.createElement('div');
    const state=isCurrent?'state-current':isPast?'state-past':'state-future';
    card.className='badge-card '+state;

    const left=document.createElement('div');
    left.className='bc-left';
    const dayLabel=isFuture?'UNLOCKS ON DAY '+badge.day:(isCurrent?'‚ñ∂ CURRENT ¬∑ DAY '+badge.day:'‚úì DAY '+badge.day);
    left.innerHTML=`<div class="bc-day">${dayLabel}</div><div class="bc-left-text">${badge.emoji} ${badge.name}</div>`;
    card.appendChild(left);

    const right=document.createElement('div');
    right.className='bc-right';
    const gifUrl=S.gifs[badge.day];
    const isRevealed=S.revealed[badge.day];

    if(isFuture){
      right.innerHTML='<div class="bc-right-locked">üîí</div>';
    } else if(gifUrl){
      if(isRevealed){
        right.innerHTML='<img src="'+gifUrl+'" alt="'+badge.name+'">';
        right.style.cursor='pointer';
        right.onclick=()=>toggleBadgeReveal(badge.day);
      } else {
        right.innerHTML='<div class="bc-right-tap" onclick="toggleBadgeReveal('+badge.day+')">Tap to Play</div>';
      }
    } else {
      right.innerHTML='<div class="bc-right-locked" style="font-size:13px;color:#6b7280;">No GIF</div>';
    }
    card.appendChild(right);
    list.appendChild(card);
  });
}

function toggleBadgeReveal(day){
  S.revealed[day]=!S.revealed[day];
  sv(K.REVEALED,S.revealed);
  renderBadges();
}

function updateHero(){
  const cur=getCurBadge();
  // Big streak display
  document.getElementById('streakNumBig').textContent=S.streak;
  document.getElementById('streakBadgeHero').textContent=cur.emoji+' '+cur.name;
  heroRevealed=false;
  renderHeroGif();
}

function updateAll(){
  const cur=getCurBadge();
  document.getElementById('headerStreak').textContent=S.streak+' üî•';
  updateHero();
  updateProgressUI();
  updateCheckinBtn();
  renderBadges();
  renderGrids();
  checkAchievedBanners();
}

// ===== CHECK IN =====
function isToday(){
  if(!S.last)return false;
  return new Date(S.last).toDateString()===new Date().toDateString();
}
function updateCheckinBtn(){
  const btn=document.getElementById('checkinBtn');
  if(isToday()){
    btn.className='checkin-btn done';
    btn.textContent='‚úì CHECKED IN ‚Äî TAP TO UNDO';
  } else {
    btn.className='checkin-btn available';
    btn.textContent='‚úì CHECK IN TODAY';
  }
}

function handleCheckin(){
  if(isToday()){
    if(!confirm('Undo today\'s check-in? Your study logs will be preserved.'))return;
    const t=new Date().toDateString();
    S.streak=Math.max(0,S.streak-1);S.last=null;
    S.dates=S.dates.filter(d=>d!==t);
    // NOTE: Study logs are preserved even when undoing check-in
    sv(K.STREAK,S.streak);sv(K.LAST,null);sv(K.DATES,S.dates);syncToIDB();
    updateAll();showToast('‚Ü©Ô∏è Check-in removed (study logs preserved)');return;
  }
  openStudyModal();
}

function calcDuration(){
  const start=document.getElementById('studyStartTime').value;
  const end=document.getElementById('studyEndTime').value;
  const el=document.getElementById('durationDisplay');
  if(!start||!end){el.textContent='';return;}
  const [sh,sm]=start.split(':').map(Number);
  const [eh,em]=end.split(':').map(Number);
  let totalMins=(eh*60+em)-(sh*60+sm);
  if(totalMins<0)totalMins+=1440;
  if(totalMins<=0){el.textContent='‚ö†Ô∏è End must be after start';el.style.color='#ef4444';return;}
  const hrs=Math.floor(totalMins/60),rm=totalMins%60;
  el.textContent=`‚è± Duration: ${hrs>0?hrs+'h ':''}${rm}m`;
  el.style.color='#16a34a';
}
function openStudyModal(){
  document.getElementById('studyModal').style.display='flex';
  const now=new Date();
  const hh=String(now.getHours()).padStart(2,'0');
  const mm=String(now.getMinutes()).padStart(2,'0');
  document.getElementById('studyStartTime').value=hh+':'+mm;
  document.getElementById('studyEndTime').value='';
  document.getElementById('durationDisplay').textContent='';
}
function closeStudyModal(){
  document.getElementById('studyModal').style.display='none';
}

function saveStudyLog(){
  const subject=document.getElementById('studySubject').value.trim()||'General';
  const startTime=document.getElementById('studyStartTime').value;
  const endTime=document.getElementById('studyEndTime').value;
  const notes=document.getElementById('studyNotes').value.trim();
  let totalMins=0;
  if(startTime&&endTime){
    const [sh,sm]=startTime.split(':').map(Number);
    const [eh,em]=endTime.split(':').map(Number);
    totalMins=(eh*60+em)-(sh*60+sm);
    if(totalMins<0)totalMins+=1440;
  }
  if(totalMins<=0){showToast('‚ö†Ô∏è Set valid start & end time');return;}
  const now=new Date();
  const log={
    id:Date.now(),
    date:now.toISOString(),
    dateStr:now.toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric'}),
    subject,totalMins,startTime,endTime,notes,
    streak:S.streak+1,dayOfWeek:now.getDay(),
    hour:startTime?parseInt(startTime.split(':')[0]):now.getHours()
  };
  S.studylogs.push(log);
  sv(K.STUDYLOGS,S.studylogs);
  // Sync notes to journal
  if(notes){
    const h=Math.floor(totalMins/60),m=totalMins%60;
    S.journal.push({
      id:Date.now()+1,
      date:now.toLocaleDateString('en-US',{weekday:'long',year:'numeric',month:'long',day:'numeric'}),
      dateISO:now.toISOString().split('T')[0],
      text:`[${subject} ¬∑ ${h>0?h+'h ':''}${m}m ¬∑ ${startTime}‚Äì${endTime}]\n${notes}`,
      streak:S.streak+1,ts:Date.now(),type:'study',subject,startTime,endTime
    });
    sv(K.JOURNAL,S.journal);
  }
  S.streak++;
  const n=new Date();S.last=n.toISOString();
  const t=n.toDateString();
  if(!S.dates.includes(t))S.dates.push(t);
  sv(K.STREAK,S.streak);sv(K.LAST,S.last);sv(K.DATES,S.dates);
  closeStudyModal();
  document.getElementById('studySubject').value='';
  document.getElementById('studyNotes').value='';
  document.getElementById('studyEndTime').value='';
  document.getElementById('durationDisplay').textContent='';
  syncToIDB();
  updateAll();showSuccessCard();playSuccess();
  if(S.notif&&Notification.permission==='granted')new Notification('CHAIN üîó',{body:'Day '+S.streak+' done!'});
}

// ===== TIMER =====
function updateTimer(){
  const now=new Date(),midnight=new Date();midnight.setHours(24,0,0,0);
  const diff=midnight-now;
  const h=String(Math.floor(diff/3600000)).padStart(2,'0');
  const m=String(Math.floor((diff%3600000)/60000)).padStart(2,'0');
  const s=String(Math.floor((diff%60000)/1000)).padStart(2,'0');
  document.getElementById('timerDisplay').textContent=h+':'+m+':'+s;
}

// ===== ANALYTICS (Forest Style) =====
let curPeriod='day';
let periodOffset=0; // how many periods back we are
const SUBJECT_COLORS=['#22c55e','#3b82f6','#f59e0b','#ef4444','#8b5cf6','#ec4899','#14b8a6','#f97316'];

function setForestPeriod(period, btn){
  curPeriod=period; periodOffset=0;
  document.querySelectorAll('.forest-period-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  renderAnalytics();
}

function shiftPeriod(dir){
  periodOffset+=dir;
  if(periodOffset>0)periodOffset=0;
  renderAnalytics();
}

function getPeriodRange(){
  const now=new Date();
  let from=new Date(), to=new Date(), label='';
  if(curPeriod==='day'){
    from=new Date(now); from.setDate(now.getDate()+periodOffset); from.setHours(0,0,0,0);
    to=new Date(from); to.setHours(23,59,59,999);
    if(periodOffset===0)label='Today';
    else label=from.toLocaleDateString('en-US',{month:'long',day:'numeric',year:'numeric'})+(periodOffset===0?' (Today)':'');
  } else if(curPeriod==='week'){
    // Start of week (Mon) + offset weeks
    const day=now.getDay(); const diff=day===0?6:day-1;
    from=new Date(now); from.setDate(now.getDate()-diff+periodOffset*7); from.setHours(0,0,0,0);
    to=new Date(from); to.setDate(from.getDate()+6); to.setHours(23,59,59,999);
    label=from.toLocaleDateString('en-US',{month:'short',day:'numeric'})+' ‚Äì '+to.toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'});
  } else if(curPeriod==='month'){
    from=new Date(now.getFullYear(),now.getMonth()+periodOffset,1);
    to=new Date(now.getFullYear(),now.getMonth()+periodOffset+1,0,23,59,59,999);
    label=from.toLocaleDateString('en-US',{month:'long',year:'numeric'});
  } else {
    from=new Date(now.getFullYear()+periodOffset,0,1);
    to=new Date(now.getFullYear()+periodOffset,11,31,23,59,59,999);
    label=String(now.getFullYear()+periodOffset);
  }
  return{from,to,label};
}

function getLogsForPeriod(from,to){
  return S.studylogs.filter(l=>{const d=new Date(l.date);return d>=from&&d<=to;});
}

function renderAnalytics(){
  const{from,to,label}=getPeriodRange();
  document.getElementById('forestDateLabel').textContent=label;
  const logs=getLogsForPeriod(from,to);
  const totalMins=logs.reduce((a,l)=>a+l.totalMins,0);
  const sessions=logs.length;
  // Summary stats
  const dispTotal=totalMins>=60?(Math.floor(totalMins/60)+'h'+(totalMins%60?totalMins%60+'m':'')):totalMins+'m';
  document.getElementById('statTotalHours').textContent=dispTotal||'0m';
  document.getElementById('statSessions').textContent=sessions;
  // Peak hour from all logs
  const hourMins=Array(24).fill(0);
  S.studylogs.forEach(l=>{if(l.hour>=0&&l.hour<24)hourMins[l.hour]+=l.totalMins;});
  const peakHour=hourMins.indexOf(Math.max(...hourMins));
  function fmtHour12(h){const ampm=h<12?'AM':'PM';const h12=h%12===0?12:h%12;return h12+':00 '+ampm;}
  const peakDisp=hourMins[peakHour]>0?`${fmtHour12(peakHour)}‚Äì${fmtHour12(peakHour+1<24?peakHour+1:peakHour)}`:'‚Äî';
  document.getElementById('statPeak').textContent=peakDisp;
  document.getElementById('statPeak').style.fontSize=hourMins[peakHour]>0?'14px':'28px';
  document.getElementById('totalFocused').textContent=totalMins>=120?(Math.floor(totalMins/60)+'h '+(totalMins%60)+'m'):totalMins+' mins';
  renderBarChart(logs,from,to,totalMins);
  renderLineChart();
  renderTrend(logs,from,to);
  renderDonut(logs);
  renderStudyLogList();
}

function renderBarChart(logs,from,to,totalMins){
  const chart=document.getElementById('studyBarChart');
  chart.querySelectorAll('.bar-item').forEach(e=>e.remove());
  document.getElementById('barAxisLabels').innerHTML='';
  let buckets=[];
  if(curPeriod==='day'){
    const labels=['0','4','8','12','16','20'];
    buckets=labels.map((lbl,i)=>({
      label:lbl+'h',
      mins:logs.filter(l=>l.hour>=i*4&&l.hour<(i+1)*4).reduce((a,l)=>a+l.totalMins,0)
    }));
  } else if(curPeriod==='week'){
    const days=['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
    buckets=days.map((d,i)=>({
      label:d,
      mins:logs.filter(l=>{const dd=new Date(l.date).getDay();return((dd===0?7:dd)-1)===i;}).reduce((a,l)=>a+l.totalMins,0)
    }));
  } else if(curPeriod==='month'){
    for(let i=0;i<4;i++){
      const wFrom=new Date(from);wFrom.setDate(from.getDate()+i*7);
      const wTo=new Date(wFrom);wTo.setDate(wFrom.getDate()+6);
      buckets.push({label:'Wk'+(i+1),mins:logs.filter(l=>{const d=new Date(l.date);return d>=wFrom&&d<=wTo;}).reduce((a,l)=>a+l.totalMins,0)});
    }
  } else {
    const mNames=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
    const yr=from.getFullYear();
    buckets=mNames.map((m,i)=>({label:m,mins:logs.filter(l=>{const d=new Date(l.date);return d.getMonth()===i&&d.getFullYear()===yr;}).reduce((a,l)=>a+l.totalMins,0)}));
  }
  const maxMins=Math.max(...buckets.map(b=>b.mins),1);
  // Decide unit: if max >= 120 mins, display in hours
  const useHours=maxMins>=120;
  const CHART_H=200; // matches CSS height
  const LABEL_H=30;  // reserve px for label + val at bottom
  const USABLE_H=CHART_H-LABEL_H;
  // Grid Y labels
  let grid=chart.querySelector('.bar-chart-grid');
  if(!grid){grid=document.createElement('div');grid.className='bar-chart-grid';chart.insertBefore(grid,chart.firstChild);}
  const steps=[100,75,50,25,0];
  grid.innerHTML=steps.map(v=>{
    const val=useHours?((maxMins*(v/100))/60).toFixed(1)+'h':Math.round(maxMins*(v/100))+'m';
    return `<div class="bar-chart-line" style="position:relative;"><span>${val}</span></div>`;
  }).join('');
  buckets.forEach((b,idx)=>{
    const pct=b.mins>0?(b.mins/maxMins):0;
    const barH=Math.max(4, Math.round(pct*USABLE_H));
    const dispVal=useHours?(b.mins/60).toFixed(1)+'h':b.mins+'m';
    const item=document.createElement('div');
    item.className='bar-item';
    item.innerHTML=`<div class="bar-val" style="height:14px;">${b.mins>0?dispVal:''}</div>
      <div class="bar-fill" style="height:${barH}px;"></div>
      <div class="bar-label">${b.label}</div>`;
    chart.appendChild(item);
  });
}

// ===== LINE CHART =====
function renderLineChart(){
  const svg=document.getElementById('lineChartSvg');
  svg.innerHTML='';
  const ns='http://www.w3.org/2000/svg';
  const allLogs=S.studylogs; // use all logs for "in general" pattern
  const hourMins=Array(24).fill(0);
  allLogs.forEach(l=>{if(l.hour>=0&&l.hour<24)hourMins[l.hour]+=l.totalMins;});
  const maxH=Math.max(...hourMins,1);
  const peakHour=hourMins.indexOf(Math.max(...hourMins));

  // Update label with range
  function fmtHr12(h){const ampm=h<12?'AM':'PM';const h12=h%12===0?12:h%12;return h12+':00 '+ampm;}
  const peakLabel=hourMins[peakHour]>0?`${fmtHr12(peakHour)} ‚Äì ${fmtHr12(peakHour+1<24?peakHour+1:peakHour)}`:'‚Äî';
  document.getElementById('peakHourLabel').textContent=peakLabel;

  // Draw baseline
  const base=document.createElementNS(ns,'line');
  base.setAttribute('x1','0');base.setAttribute('y1','75');base.setAttribute('x2','300');base.setAttribute('y2','75');
  base.setAttribute('stroke','#e5e7eb');base.setAttribute('stroke-width','1');svg.appendChild(base);

  if(allLogs.length===0)return;

  // Points
  const pts=hourMins.map((m,h)=>({x:h*(300/23),y:75-(m/maxH)*65}));
  const pathD='M'+pts.map(p=>`${p.x.toFixed(1)},${p.y.toFixed(1)}`).join(' L');

  // Fill area
  const fillD=pathD+` L${pts[23].x},75 L${pts[0].x},75 Z`;
  const fill=document.createElementNS(ns,'path');
  fill.setAttribute('d',fillD);fill.setAttribute('fill','rgba(34,197,94,0.15)');svg.appendChild(fill);

  // Line
  const path=document.createElementNS(ns,'path');
  path.setAttribute('d',pathD);path.setAttribute('fill','none');
  path.setAttribute('stroke','#22c55e');path.setAttribute('stroke-width','2');path.setAttribute('stroke-linejoin','round');
  svg.appendChild(path);

  // Peak circle
  const peak=pts[peakHour];
  const circ=document.createElementNS(ns,'circle');
  circ.setAttribute('cx',peak.x);circ.setAttribute('cy',peak.y);circ.setAttribute('r','4');
  circ.setAttribute('fill','#22c55e');circ.setAttribute('stroke','#fff');circ.setAttribute('stroke-width','2');
  svg.appendChild(circ);
  // Dashed vertical line at peak
  const dash=document.createElementNS(ns,'line');
  dash.setAttribute('x1',peak.x);dash.setAttribute('y1',peak.y);dash.setAttribute('x2',peak.x);dash.setAttribute('y2','75');
  dash.setAttribute('stroke','#9ca3af');dash.setAttribute('stroke-width','1');dash.setAttribute('stroke-dasharray','3,3');
  svg.appendChild(dash);
}

// ===== FOCUS TREND =====
function renderTrend(logs,from,to){
  const el=document.getElementById('trendSection');
  const totalMins=logs.reduce((a,l)=>a+l.totalMins,0);

  // Get previous period's mins
  let prevFrom=new Date(from), prevTo=new Date(to);
  if(curPeriod==='day'){prevFrom.setDate(prevFrom.getDate()-1);prevTo.setDate(prevTo.getDate()-1);}
  else if(curPeriod==='week'){prevFrom.setDate(prevFrom.getDate()-7);prevTo.setDate(prevTo.getDate()-7);}
  else if(curPeriod==='month'){prevFrom.setMonth(prevFrom.getMonth()-1);prevTo.setMonth(prevTo.getMonth()-1);}
  else{prevFrom.setFullYear(prevFrom.getFullYear()-1);prevTo.setFullYear(prevTo.getFullYear()-1);}
  const prevLogs=S.studylogs.filter(l=>{const d=new Date(l.date);return d>=prevFrom&&d<=prevTo;});
  const prevMins=prevLogs.reduce((a,l)=>a+l.totalMins,0);
  const diff=totalMins-prevMins;
  const diffStr=(diff>=0?'+':'')+diff+'M '+( diff>=0?'longer':'shorter');
  const diffColor=diff>=0?'#22c55e':'#ef4444';
  const maxBar=Math.max(totalMins,prevMins,1);

  el.innerHTML=`
    <div style="font-size:12px;color:#6b7280;margin-bottom:12px;">
      This period vs last: <span style="color:${diffColor};font-weight:700;">${diffStr}</span>
    </div>
    <div class="trend-row">
      <div class="trend-row-label">This period <span>${totalMins} M</span></div>
      <div class="trend-bar-track"><div class="trend-bar-fill" style="width:${(totalMins/maxBar)*100}%;"></div></div>
    </div>
    <div class="trend-row">
      <div class="trend-row-label">Previous period <span style="color:#9ca3af;">${prevMins} M</span></div>
      <div class="trend-bar-track"><div class="trend-bar-fill" style="width:${(prevMins/maxBar)*100}%;background:#bbf7d0;"></div></div>
    </div>`;
}

// ===== DONUT CHART =====
function renderDonut(logs){
  const svg=document.getElementById('donutSvg');
  const legend=document.getElementById('donutLegend');
  const ns='http://www.w3.org/2000/svg';
  svg.innerHTML=''; legend.innerHTML='';

  const subMap={};
  logs.forEach(l=>{const s=l.subject||'General';subMap[s]=(subMap[s]||0)+l.totalMins;});
  const sorted=Object.entries(subMap).sort((a,b)=>b[1]-a[1]);
  const total=sorted.reduce((a,v)=>a+v[1],0);

  if(!sorted.length){
    svg.innerHTML='<circle cx="60" cy="60" r="40" fill="none" stroke="#f0fdf4" stroke-width="20"/>';
    legend.innerHTML='<p style="color:#9ca3af;font-size:11px;">No data yet</p>';
    document.getElementById('donutTopPct').textContent='0%';
    return;
  }

  document.getElementById('donutTopPct').textContent=total>0?Math.round((sorted[0][1]/total)*100)+'%':'0%';

  let startAngle=-Math.PI/2;
  const cx=60,cy=60,r=45,inner=28;
  sorted.slice(0,6).forEach(([sub,mins],i)=>{
    const pct=mins/total;
    const angle=pct*Math.PI*2;
    const end=startAngle+angle;
    const x1=cx+r*Math.cos(startAngle);const y1=cy+r*Math.sin(startAngle);
    const x2=cx+r*Math.cos(end);const y2=cy+r*Math.sin(end);
    const ix1=cx+inner*Math.cos(startAngle);const iy1=cy+inner*Math.sin(startAngle);
    const ix2=cx+inner*Math.cos(end);const iy2=cy+inner*Math.sin(end);
    const largeArc=angle>Math.PI?1:0;
    const col=SUBJECT_COLORS[i%SUBJECT_COLORS.length];
    const path=document.createElementNS(ns,'path');
    path.setAttribute('d',`M${ix1},${iy1} L${x1},${y1} A${r},${r} 0 ${largeArc},1 ${x2},${y2} L${ix2},${iy2} A${inner},${inner} 0 ${largeArc},0 ${ix1},${iy1} Z`);
    path.setAttribute('fill',col);path.setAttribute('stroke','#fff');path.setAttribute('stroke-width','1');
    svg.appendChild(path);
    startAngle=end;

    // Legend
    const row=document.createElement('div');
    row.className='donut-leg-row';
    row.innerHTML=`<div class="donut-dot" style="background:${col}"></div>
      <div class="donut-leg-name">${sub}</div>
      <div class="donut-leg-pct">${Math.round(pct*100)}%</div>
      <div class="donut-leg-mins">&nbsp;${Math.floor(mins/60)}h${mins%60}m</div>`;
    legend.appendChild(row);
  });
}

function renderStudyLogList(){
  const el=document.getElementById('studyLogList');
  el.innerHTML='';
  // Show ALL logs, newest first ‚Äî never auto-delete
  const logs=[...S.studylogs].reverse();
  if(!logs.length){el.innerHTML='<p style="color:#9ca3af;font-size:12px;text-align:center;padding:10px;">No study logs yet ‚Äî start your first session!</p>';return;}
  // Group by date for readability
  let lastDay='';
  logs.forEach(l=>{
    const dayStr=new Date(l.date).toLocaleDateString('en-US',{weekday:'long',month:'short',day:'numeric',year:'numeric'});
    if(dayStr!==lastDay){
      const sep=document.createElement('div');
      sep.style.cssText='font-family:"Space Mono",monospace;font-size:9px;color:#9ca3af;letter-spacing:2px;padding:8px 0 4px;margin-top:4px;border-bottom:1px dashed #e5e7eb;';
      sep.textContent=dayStr.toUpperCase();
      el.appendChild(sep);
      lastDay=dayStr;
    }
    const row=document.createElement('div');
    row.style.cssText='padding:10px 0;border-bottom:1px solid #f0fdf4;display:flex;align-items:center;gap:10px;';
    const col=SUBJECT_COLORS[getSubjectColor(l.subject)];
    const h=Math.floor(l.totalMins/60),m=l.totalMins%60;
    row.innerHTML=`<div style="width:6px;height:36px;border-radius:3px;background:${col};flex-shrink:0;"></div>
      <div style="flex:1;">
        <div style="font-weight:700;font-size:13px;color:#14532d;">${l.subject||'General'}</div>
        <div style="font-family:'Space Mono',monospace;font-size:10px;color:#6b7280;">${l.startTime?l.startTime+(l.endTime?'‚Äì'+l.endTime:''):''}</div>
        ${l.notes?`<div style="font-size:11px;color:#6b7280;margin-top:2px;">${(l.notes||'').substring(0,60)}${(l.notes||'').length>60?'‚Ä¶':''}</div>`:''}
      </div>
      <div style="display:flex;flex-direction:column;align-items:flex-end;gap:6px;">
        <span style="font-family:'Space Mono',monospace;font-size:12px;color:#16a34a;font-weight:700;">${h>0?h+'h ':''}${m}m</span>
        <button onclick="deleteStudyLog(${l.id||0})" style="background:none;border:none;color:#ef4444;cursor:pointer;font-size:15px;padding:0;" title="Delete log">üóë</button>
      </div>`;
    el.appendChild(row);
  });
}

function deleteStudyLog(id){
  if(!confirm('Delete this study log? This action cannot be undone.'))return;
  if(!confirm('‚ö†Ô∏è FINAL CONFIRMATION: Permanently delete this log?'))return;
  S.studylogs=S.studylogs.filter(l=>l.id!==id);
  sv(K.STUDYLOGS,S.studylogs);idbSet(K.STUDYLOGS,S.studylogs);
  renderStudyLogList();showToast('üóë Log deleted');
}

function resetAnalytics(){
  if(!confirm('Reset ALL study log data? This permanently deletes every session you have ever logged.'))return;
  if(!confirm('‚ö†Ô∏è FINAL WARNING: This cannot be undone. Delete ALL analytics data forever?'))return;
  S.studylogs=[];sv(K.STUDYLOGS,[]);idbSet(K.STUDYLOGS,[]);
  renderAnalytics();showToast('üîÑ Analytics data cleared');
}

const subjectColorMap={};
let subColorIdx=0;
function getSubjectColor(sub){
  if(subjectColorMap[sub]===undefined){subjectColorMap[sub]=subColorIdx%SUBJECT_COLORS.length;subColorIdx++;}
  return subjectColorMap[sub];
}

// ===== GRID =====
let curGridSize = 90;

function setGridTab(size, btn) {
  curGridSize = size;
  document.querySelectorAll('.grid-tab').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  renderGrids();
  checkAchievedBanners();
}

function buildBorderMap(rows, cols, mask) {
  const map = {};
  const add = (r, c, side) => {
    const k = r + ',' + c;
    if (!map[k]) map[k] = '';
    if (!map[k].includes(side)) map[k] += side;
  };
  for (let r = 0; r < rows; r++) {
    for (let c = 0; c < cols; c++) {
      const cur = (mask[r] && mask[r][c]) ? 1 : 0;
      const up    = (r > 0      && mask[r-1] && mask[r-1][c]) ? 1 : 0;
      const dn    = (r < rows-1 && mask[r+1] && mask[r+1][c]) ? 1 : 0;
      const lt    = (c > 0      && mask[r]   && mask[r][c-1]) ? 1 : 0;
      const rt    = (c < cols-1 && mask[r]   && mask[r][c+1]) ? 1 : 0;
      if (cur === 1) {
        if (!up) add(r, c, 'T');
        if (!dn) add(r, c, 'B');
        if (!lt) add(r, c, 'L');
        if (!rt) add(r, c, 'R');
      }
    }
  }
  return map;
}

function makeRectGrid(startDay, rows, cols, cellSize, fontSize, borderMap, maxDay) {
  const table = document.createElement('table');
  table.className = 'grid-table';
  table.style.borderCollapse = 'collapse';

  for (let r = 0; r < rows; r++) {
    const tr = document.createElement('tr');
    for (let c = 0; c < cols; c++) {
      const td = document.createElement('td');
      const dayNum = startDay + r * cols + c;
      td.style.width  = cellSize + 'px';
      td.style.height = cellSize + 'px';
      td.style.fontSize = fontSize + 'px';
      td.style.border = '1px solid #ccc';
      td.style.textAlign = 'center';
      td.style.verticalAlign = 'middle';
      td.style.fontFamily = "'Space Mono', monospace";
      td.style.background = '#fff';
      td.style.color = '#bbb';
      td.style.boxSizing = 'border-box';

      if (dayNum > maxDay) {
        td.style.background = '#f8fffe';
        td.style.borderColor = '#e8f5e9';
      } else {
        td.textContent = dayNum;
        if (dayNum <= S.streak) {
          td.style.background = '#22c55e';
          td.style.color = '#fff';
          td.style.fontWeight = '700';
          td.style.borderColor = '#16a34a';
        } else if (dayNum === S.streak + 1) {
          td.style.border = '2px solid #ef4444';
          td.style.color = '#ef4444';
          td.style.fontWeight = '700';
        }
      }

      const key = r + ',' + c;
      if (borderMap && borderMap[key]) {
        const sides = borderMap[key];
        if (sides.includes('T')) td.style.borderTop    = '3px solid #14532d';
        if (sides.includes('B')) td.style.borderBottom = '3px solid #14532d';
        if (sides.includes('L')) td.style.borderLeft   = '3px solid #14532d';
        if (sides.includes('R')) td.style.borderRight  = '3px solid #14532d';
      }

      tr.appendChild(td);
    }
    table.appendChild(tr);
  }

  const block = document.createElement('div');
  block.className = 'grid-block';
  block.appendChild(table);
  return block;
}

function renderGrids() {
  const gw = document.getElementById('gridWrapper');
  gw.innerHTML = '';

  if (curGridSize === 90) {
    const cs = 40, fs = 11;
    const mask9 = [
      [1,1,1,1,1,1],
      [1,0,0,0,0,1],
      [1,0,0,0,0,1],
      [1,1,1,1,1,1],
      [0,0,0,0,0,1],
      [0,0,0,0,0,1],
      [1,1,1,1,1,1],
    ];
    gw.appendChild(makeRectGrid(1,  7, 6, cs, fs, buildBorderMap(7,6,mask9), 90));

    const mask0 = [
      [1,1,1,1,1,1],
      [1,0,0,0,0,1],
      [1,0,0,0,0,1],
      [1,0,0,0,0,1],
      [1,0,0,0,0,1],
      [1,0,0,0,0,1],
      [1,0,0,0,0,1],
      [1,1,1,1,1,1],
    ];
    gw.appendChild(makeRectGrid(43, 8, 6, cs, fs, buildBorderMap(8,6,mask0), 90));

  } else if (curGridSize === 180) {
    const cs = 28, fs = 9;
    const mask1 = [
      [0,0,1,0,0],
      [0,1,1,0,0],
      [0,0,1,0,0],
      [0,0,1,0,0],
      [0,0,1,0,0],
      [1,1,1,1,1],
    ];
    gw.appendChild(makeRectGrid(1,   6,  5, cs, fs, buildBorderMap(6,5,mask1),  180));

    const mask8 = [
      [1,1,1,1,1,1,1,1],
      [1,0,0,0,0,0,0,1],
      [1,0,0,0,0,0,0,1],
      [1,0,0,0,0,0,0,1],
      [1,1,1,1,1,1,1,1],
      [1,0,0,0,0,0,0,1],
      [1,0,0,0,0,0,0,1],
      [1,0,0,0,0,0,0,1],
      [1,0,0,0,0,0,0,1],
      [1,1,1,1,1,1,1,1],
    ];
    gw.appendChild(makeRectGrid(31,  10, 8, cs, fs, buildBorderMap(10,8,mask8), 180));

    const mask0b = [
      [1,1,1,1,1,1,1],
      [1,0,0,0,0,0,1],
      [1,0,0,0,0,0,1],
      [1,0,0,0,0,0,1],
      [1,0,0,0,0,0,1],
      [1,0,0,0,0,0,1],
      [1,0,0,0,0,0,1],
      [1,0,0,0,0,0,1],
      [1,0,0,0,0,0,1],
      [1,1,1,1,1,1,1],
    ];
    gw.appendChild(makeRectGrid(111, 10, 7, cs, fs, buildBorderMap(10,7,mask0b), 180));

  } else {
    const cs = 22, fs = 8;
    const mask3 = [
      [1,1,1,1,1,1,1,1,1,1,1],
      [0,0,0,0,0,0,0,0,0,0,1],
      [0,0,0,0,0,0,0,0,0,0,1],
      [0,0,0,0,0,0,0,0,0,0,1],
      [0,1,1,1,1,1,1,1,1,1,0],
      [0,0,0,0,0,0,0,0,0,0,1],
      [0,0,0,0,0,0,0,0,0,0,1],
      [0,0,0,0,0,0,0,0,0,0,1],
      [0,0,0,0,0,0,0,0,0,0,1],
      [0,0,0,0,0,0,0,0,0,0,1],
      [1,1,1,1,1,1,1,1,1,1,1],
    ];
    const mask6 = [
      [0,1,1,1,1,1,1,1,1,1,1],
      [1,0,0,0,0,0,0,0,0,0,0],
      [1,0,0,0,0,0,0,0,0,0,0],
      [1,0,0,0,0,0,0,0,0,0,0],
      [1,1,1,1,1,1,1,1,1,1,0],
      [1,0,0,0,0,0,0,0,0,0,1],
      [1,0,0,0,0,0,0,0,0,0,1],
      [1,0,0,0,0,0,0,0,0,0,1],
      [1,0,0,0,0,0,0,0,0,0,1],
      [1,0,0,0,0,0,0,0,0,0,1],
      [0,1,1,1,1,1,1,1,1,1,0],
    ];
    const mask5 = [
      [1,1,1,1,1,1,1,1,1,1,1],
      [1,0,0,0,0,0,0,0,0,0,0],
      [1,0,0,0,0,0,0,0,0,0,0],
      [1,0,0,0,0,0,0,0,0,0,0],
      [1,1,1,1,1,1,1,1,1,1,0],
      [0,0,0,0,0,0,0,0,0,0,1],
      [0,0,0,0,0,0,0,0,0,0,1],
      [0,0,0,0,0,0,0,0,0,0,1],
      [0,0,0,0,0,0,0,0,0,0,1],
      [0,0,0,0,0,0,0,0,0,0,1],
      [1,1,1,1,1,1,1,1,1,1,1],
    ];
    gw.appendChild(makeRectGrid(1,   11, 11, cs, fs, buildBorderMap(11,11,mask3), 365));
    gw.appendChild(makeRectGrid(122, 11, 11, cs, fs, buildBorderMap(11,11,mask6), 365));
    gw.appendChild(makeRectGrid(243, 11, 11, cs, fs, buildBorderMap(11,11,mask5), 365));
  }
}

function checkAchievedBanners(){
  document.getElementById('banner90').className='achieved-banner'+(S.streak>=90?' show':'');
  document.getElementById('banner180').className='achieved-banner'+(S.streak>=180?' show':'');
  document.getElementById('banner365').className='achieved-banner'+(S.streak>=365?' show':'');
}

// ===== SUCCESS CARD =====
function showSuccessCard(){
  const b=getCurBadge();
  const o=document.createElement('div');
  o.className='success-overlay';
  o.innerHTML=`<div class="success-card">
    <div class="success-emoji-big">${b.emoji}</div>
    <div class="success-title">CHECKED IN!</div>
    <div class="success-big-num">${S.streak}</div>
    <div class="success-sub">DAYS STRONG</div>
    <div class="success-badge">${b.name}</div>
    <button class="success-close-btn" onclick="this.parentElement.parentElement.remove()">KEEP GOING! üîó</button>
  </div>`;
  document.body.appendChild(o);
}

// ===== JOURNAL =====
function renderJournal(){
  const list=document.getElementById('journalList');
  list.innerHTML='';
  renderDailyQuote();

  const sortVal=document.getElementById('journalSort')?.value||'newest';
  const dateFilter=document.getElementById('journalDateFilter')?.value||'';

  let entries=[...S.journal];
  // Filter by date if selected
  if(dateFilter){
    entries=entries.filter(e=>{
      const d=e.dateISO||(e.ts?new Date(e.ts).toISOString().split('T')[0]:'');
      return d===dateFilter;
    });
  }
  // Sort
  entries.sort((a,b)=>sortVal==='newest'?(b.ts||0)-(a.ts||0):(a.ts||0)-(b.ts||0));

  if(!entries.length){
    list.innerHTML='<p style="text-align:center;color:#9ca3af;padding:20px;font-size:13px;">'+(dateFilter?'No entries on this date.':'No entries yet. Start writing!')+'</p>';
    return;
  }

  entries.forEach((e,i)=>{
    const typeLabel=e.type==='study'?'üìö STUDY LOG':e.type==='quote'?'üí¨ QUOTE':'‚úèÔ∏è YOUR ENTRY';
    const preview=(e.text||'').substring(0,80);
    const isTruncated=(e.text||'').length>80;
    const el=document.createElement('div');
    el.className='journal-entry-card';
    el.style.cursor='pointer';
    el.innerHTML=`
      <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:8px;">
        <div style="flex:1;">
          <div class="journal-entry-date">${e.date||''}</div>
          <div class="journal-entry-type">${typeLabel}${e.subject?' ¬∑ '+e.subject:''}</div>
          <div class="journal-entry-text">${preview}${isTruncated?'<span style="color:#9ca3af;"> ‚Ä¶tap to read more</span>':''}</div>
          <div class="journal-entry-streak">STREAK: ${e.streak||0} DAYS üî•</div>
        </div>
        <button onclick="event.stopPropagation();deleteJournalEntry(${e.id||e.ts||i})" 
          style="background:none;border:none;color:#ef4444;cursor:pointer;font-size:16px;flex-shrink:0;padding:2px 4px;" title="Delete">üóë</button>
      </div>`;
    // Click to expand full entry
    el.onclick=()=>openJournalDetail(e);
    list.appendChild(el);
  });
}

function openJournalDetail(e){
  const typeLabel=e.type==='study'?'üìö STUDY LOG':e.type==='quote'?'üí¨ QUOTE':'‚úèÔ∏è YOUR ENTRY';
  document.getElementById('journalDetailTitle').textContent=typeLabel;
  document.getElementById('journalDetailDate').textContent=e.date||'';
  document.getElementById('journalDetailStreak').textContent='STREAK: '+(e.streak||0)+' DAYS üî•'+(e.subject?' ¬∑ '+e.subject:'')+(e.startTime?' ¬∑ '+e.startTime+(e.endTime?'‚Äì'+e.endTime:''):'');
  document.getElementById('journalDetailText').textContent=e.text||'';
  document.getElementById('journalDetailModal').style.display='flex';
}
function closeJournalDetail(){
  document.getElementById('journalDetailModal').style.display='none';
}

function deleteJournalEntry(idOrTs){
  if(!confirm('Delete this journal entry?'))return;
  S.journal=S.journal.filter(e=>(e.id||e.ts)!==idOrTs);
  sv(K.JOURNAL,S.journal);
  renderJournal();showToast('üóë Entry deleted');
}

function saveJournal(){
  const text=document.getElementById('journalInput').value.trim();
  if(!text){showToast('‚úèÔ∏è Write something first!');return;}
  const now=new Date();
  S.journal.push({
    id:Date.now(),
    date:now.toLocaleDateString('en-US',{weekday:'long',year:'numeric',month:'long',day:'numeric'}),
    dateISO:now.toISOString().split('T')[0],
    text,streak:S.streak,ts:Date.now(),type:'entry'
  });
  sv(K.JOURNAL,S.journal);
  document.getElementById('journalInput').value='';
  renderJournal();
  showToast('üìì Entry saved!');
}

// ===== SETTINGS =====
function exportData(){
  const d={...S,exportDate:new Date().toISOString(),v:5};
  const b=new Blob([JSON.stringify(d,null,2)],{type:'application/json'});
  const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download='chain-backup-'+new Date().toISOString().split('T')[0]+'.json';a.click();
  markExported();
  showToast('‚úÖ Exported!');
}
function importData(ev){
  const f=ev.target.files[0];if(!f)return;
  if(!confirm('Import will replace all data. Continue?')){ev.target.value='';return;}
  const r=new FileReader();
  r.onload=e=>{
    try{
      const d=JSON.parse(e.target.result);
      S.streak=d.streak||0;S.last=d.last||null;S.dates=d.dates||[];
      S.journal=d.journal||[];S.gifs=d.gifs||{};S.cquotes=d.cquotes||[];
      S.notif=d.notif||false;S.rtimes=d.rtimes||[];S.revealed=d.revealed||{};
      S.studylogs=d.studylogs||[];
      sv(K.STREAK,S.streak);sv(K.LAST,S.last);sv(K.DATES,S.dates);
      sv(K.JOURNAL,S.journal);sv(K.GIFS,S.gifs);sv(K.CQUOTES,S.cquotes);
      sv(K.NOTIF,S.notif);sv(K.RTIMES,S.rtimes);sv(K.REVEALED,S.revealed);sv(K.STUDYLOGS,S.studylogs);
      syncToIDB();markExported();
      updateAll();renderJournal();renderGifSettings();renderCustomQuotes();
      showToast('‚úÖ Imported!');
    }catch{showToast('‚ùå Import failed');}
  };
  r.readAsText(f);ev.target.value='';
}
function resetStreak(){
  if(!confirm('Reset your streak? This cannot be undone!'))return;
  if(!confirm('REALLY? You will lose '+S.streak+' days!'))return;
  S.streak=0;S.last=null;S.dates=[];
  sv(K.STREAK,0);sv(K.LAST,null);sv(K.DATES,[]);
  updateAll();showToast('üîÑ Streak reset');
}

// ===== NOTIFICATIONS =====
async function toggleNotifications(){
  const t=document.getElementById('notifToggle');
  if(!S.notif){
    if(!('Notification' in window)){showToast('‚ùå Not supported');return;}
    const p=await Notification.requestPermission();
    if(p!=='granted'){showToast('‚ùå Enable notifications in browser settings');return;}
    S.notif=true;
  }else{S.notif=false;}
  sv(K.NOTIF,S.notif);
  t.className='toggle'+(S.notif?' on':'');
  document.getElementById('reminderSection').style.display=S.notif?'block':'none';
  showToast(S.notif?'üîî Notifications ON':'üîï Notifications OFF');
  if(S.notif)scheduleNotifs();
}
function scheduleNotifs(){
  if(!S.notif||Notification.permission!=='granted')return;
  S.rtimes.forEach(time=>{
    const[h,m]=time.split(':').map(Number);
    const now=new Date(),t=new Date();t.setHours(h,m,0,0);
    if(t<=now)t.setDate(t.getDate()+1);
    setTimeout(()=>{new Notification('CHAIN Reminder üîó',{body:`Keep the chain! Streak: ${S.streak} days üî•`});},t-now);
  });
}
function addReminder(){
  const v=document.getElementById('newReminderTime').value;if(!v)return;
  if(!S.rtimes.includes(v)){S.rtimes.push(v);S.rtimes.sort();sv(K.RTIMES,S.rtimes);}
  renderReminderTags();showToast('‚è∞ Added: '+v);if(S.notif)scheduleNotifs();
}
function removeReminder(t){S.rtimes=S.rtimes.filter(x=>x!==t);sv(K.RTIMES,S.rtimes);renderReminderTags();}
function renderReminderTags(){document.getElementById('reminderTags').innerHTML=S.rtimes.map(t=>`<span class="reminder-tag"><span>${t}</span><button onclick="removeReminder('${t}')">√ó</button></span>`).join('');}

// ===== CUSTOM QUOTES =====
function addCustomQuote(){
  const text=document.getElementById('quoteTextInput').value.trim();
  const author=document.getElementById('quoteAuthorInput').value.trim();
  if(!text){showToast('üí¨ Enter quote text');return;}
  S.cquotes.push({text,author:author||'YOU'});
  sv(K.CQUOTES,S.cquotes);
  document.getElementById('quoteTextInput').value='';
  document.getElementById('quoteAuthorInput').value='';
  renderCustomQuotes();
  showToast('‚úÖ Quote added to daily inspiration!');
}
function removeCustomQuote(i){S.cquotes.splice(i,1);sv(K.CQUOTES,S.cquotes);renderCustomQuotes();}
function renderCustomQuotes(){
  document.getElementById('customQuotesList').innerHTML=S.cquotes.map((q,i)=>
    `<div class="custom-q-item"><div class="custom-q-text">"${q.text}" <span style="color:var(--dark-green)">‚Äî ${q.author}</span></div><button class="custom-q-del" onclick="removeCustomQuote(${i})">üóëÔ∏è</button></div>`
  ).join('')||'<p style="color:#9ca3af;font-size:12px;text-align:center;padding:10px;">No custom quotes yet</p>';
}

// ===== GIF SETTINGS =====
function renderGifSettings(){
  document.getElementById('gifSettings').innerHTML=BADGES.map(b=>
    `<div class="gif-item"><div class="gif-label">${b.emoji} DAY ${b.day}: ${b.name}</div>
    <input type="text" class="gif-input" placeholder="Paste GIF URL..."
      value="${S.gifs[b.day]||''}"
      onchange="S.gifs[${b.day}]=this.value;sv(K.GIFS,S.gifs);renderBadges();renderHeroGif();">
    </div>`
  ).join('');
}

// ===== SHARE =====
function shareApp(){
  if(navigator.share){navigator.share({title:'CHAIN',text:`I'm on a ${S.streak}-day chain! üîó`,url:window.location.href}).catch(()=>{});}
  else{navigator.clipboard&&navigator.clipboard.writeText(window.location.href).then(()=>showToast('üîó Link copied!'));}
}

// ===== PAGE NAV =====
function switchPage(pg,btn){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('page-'+pg).classList.add('active');
  btn.classList.add('active');
  if(pg==='journal')renderJournal();
  if(pg==='analytics')renderAnalytics();
}

// ===== TOAST =====
function showToast(msg){
  document.querySelector('.toast')?.remove();
  const t=document.createElement('div');t.className='toast';t.textContent=msg;
  document.body.appendChild(t);setTimeout(()=>{if(t.parentElement)t.remove();},2800);
}

// ===== SOUND =====
function playSuccess(){
  try{const ctx=new(window.AudioContext||window.webkitAudioContext)(),o=ctx.createOscillator(),g=ctx.createGain();o.connect(g);g.connect(ctx.destination);o.frequency.setValueAtTime(523,ctx.currentTime);o.frequency.setValueAtTime(659,ctx.currentTime+.12);o.frequency.setValueAtTime(784,ctx.currentTime+.24);g.gain.setValueAtTime(.2,ctx.currentTime);g.gain.exponentialRampToValueAtTime(.01,ctx.currentTime+.5);o.start();o.stop(ctx.currentTime+.5);}catch(e){}
}

// ===== FIRE =====
function buildFire(){
  const c=document.getElementById('fireContainer');
  [[`3%`,70,190,'#ff3d00','1.3s',8,-3,3,.85,1.1,.7,.9],[`14%`,90,230,'#ff6b00','1.1s',6,-2,4,.9,1.1,.8,1],[`28%`,110,270,'#ff8c00','0.9s',4,-4,2,.88,1.2,.9,1],[`44%`,130,290,'#ff5722','1.0s',3,-2,3,.92,1.1,.85,1],[`59%`,100,250,'#ff6b00','1.2s',5,-3,5,.87,1.15,.8,.95],[`74%`,80,210,'#ff3d00','0.8s',7,-5,2,.9,1.1,.75,.9],[`22%`,55,160,'#ffb300','0.7s',1,-1,2,.95,1.05,.9,1],[`50%`,65,180,'#ffcc00','0.6s',0,-2,2,.96,1.08,.95,1],[`70%`,50,140,'#ff9800','0.75s',1,-1,3,.93,1.06,.88,1]].forEach(([l,w,h,col,dur,bl,r1,r2,sx,sy,o1,o2])=>{
    const el=document.createElement('div');el.className='flame';
    el.style.cssText=`left:${l};width:${w}px;height:${h}px;background:${col};--dur:${dur};--blur:${bl}px;--r1:${r1}deg;--r2:${r2}deg;--sx:${sx};--sy:${sy};--o1:${o1};--o2:${o2};`;
    c.appendChild(el);
  });
}

// ===== INIT =====
async function init(){
  await restoreFromIDBIfNeeded();
  // Re-load state after potential IDB restore
  S.streak=ld(K.STREAK,0);S.last=ld(K.LAST,null);S.dates=ld(K.DATES,[]);
  S.journal=ld(K.JOURNAL,[]);S.gifs=ld(K.GIFS,{});S.cquotes=ld(K.CQUOTES,[]);
  S.notif=ld(K.NOTIF,false);S.rtimes=ld(K.RTIMES,['15:00','20:00','22:00']);
  S.revealed=ld(K.REVEALED,{});S.studylogs=ld(K.STUDYLOGS,[]);
  // Initial IDB sync
  syncToIDB();
  buildFire();
  setTimeout(()=>{
    const intro=document.getElementById('fire-intro');
    intro.classList.add('fade-out');
    setTimeout(()=>{
      intro.classList.add('gone');
      document.getElementById('app').classList.add('visible');
      updateAll();
      renderGifSettings();renderCustomQuotes();renderReminderTags();renderDailyQuote();
      if(S.notif){document.getElementById('notifToggle').classList.add('on');document.getElementById('reminderSection').style.display='block';scheduleNotifs();}
      checkExportReminder();
    },600);
  },3200);
  setInterval(updateTimer,1000);updateTimer();
}

// ===== PWA =====
window.addEventListener('beforeinstallprompt',e=>{
  e.preventDefault();
  const b=document.createElement('div');
  b.style.cssText='position:fixed;bottom:85px;left:16px;right:16px;background:#14532d;color:#86efac;padding:14px;border-radius:14px;display:flex;align-items:center;gap:12px;z-index:500;box-shadow:0 4px 20px rgba(0,0,0,.15);';
  b.innerHTML=`<div style="flex:1"><div style="font-weight:700;font-size:14px;">üîó Install CHAIN</div><div style="font-size:11px;opacity:.7;margin-top:2px;">Add to home screen</div></div>
    <button onclick="e.prompt();this.parentElement.remove();" style="background:var(--green);color:#fff;border:none;border-radius:8px;padding:8px 14px;cursor:pointer;font-weight:700;">Install</button>
    <button onclick="this.parentElement.remove();" style="background:none;border:none;color:#86efac;cursor:pointer;font-size:20px;">√ó</button>`;
  document.body.appendChild(b);
  setTimeout(()=>{if(b.parentElement)b.remove();},12000);
});

if('serviceWorker' in navigator){
  const sw=`const C='chain-v5';self.addEventListener('install',e=>e.waitUntil(caches.open(C).then(c=>c.addAll(['/']))));self.addEventListener('fetch',e=>e.respondWith(caches.match(e.request).then(r=>r||fetch(e.request))));`;
  navigator.serviceWorker.register(URL.createObjectURL(new Blob([sw],{type:'application/javascript'}))).catch(()=>{});
}

window.addEventListener('DOMContentLoaded',init);
</script>
</body>
</html>
