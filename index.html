<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="CHAIN">
  <meta name="theme-color" content="#f0fdf4">
  <title>CHAIN</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Space+Mono:wght@400;700&family=Nunito:wght@400;600;700;900&family=Playfair+Display:ital,wght@0,700;1,400;1,700&display=swap" rel="stylesheet">
  <!-- PWA Manifest -->
  <link rel="manifest" id="pwa-manifest">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-touch-fullscreen" content="yes">
  <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='20' fill='%2314532d'/><text y='.9em' font-size='70' x='15'>üîó</text></svg>">
  <style>
    :root {
      --green: #22c55e;
      --dark-green: #16a34a;
      --light-green: #86efac;
      --xlight-green: #dcfce7;
      --red: #ef4444;
      --dark-red: #dc2626;
      --bg: #f0fdf4;
      --card: #ffffff;
      --text: #14532d;
      --muted: #6b7280;
      --border: #d1fae5;
      --accent: #4ade80;
      --transition: .2s cubic-bezier(.4,0,.2,1);
      --shadow-sm: 0 1px 3px rgba(0,0,0,.08);
      --shadow-md: 0 4px 16px rgba(20,83,45,.12);
      --shadow-lg: 0 8px 32px rgba(20,83,45,.2);
    }
    * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
    html, body { width:100%; min-height:100%; background:var(--bg); color:var(--text); font-family:'Nunito',sans-serif; overscroll-behavior:none; }

    /* ===== FIRE INTRO ===== */
    #fire-intro {
      position:fixed; inset:0; z-index:9999;
      background:linear-gradient(160deg,#f0fdf4 0%,#dcfce7 60%,#bbf7d0 100%);
      display:flex; flex-direction:column;
      align-items:center; justify-content:flex-end; overflow:hidden;
    }
    #fire-intro .title-wrap {
      position:absolute; top:30%; left:50%;
      transform:translateX(-50%); text-align:center; z-index:2;
    }
    #fire-intro .title-wrap h1 {
      font-family:'Bebas Neue',sans-serif;
      font-size:clamp(64px,18vw,120px); letter-spacing:8px; color:#14532d;
      opacity:0; animation:fadeUp .8s 1s forwards;
    }
    #fire-intro .title-wrap p {
      font-family:'Space Mono',monospace; font-size:12px;
      letter-spacing:5px; color:var(--dark-green); opacity:0;
      animation:fadeUp .8s 1.4s forwards; margin-top:6px;
    }
    @keyframes fadeUp { from{opacity:0;transform:translateY(14px)} to{opacity:1;transform:translateY(0)} }
    .fire-container { position:relative; width:100%; height:280px; }
    .flame {
      position:absolute; bottom:0; border-radius:50% 50% 20% 20%;
      transform-origin:bottom center;
      animation:flk var(--dur,1.2s) ease-in-out infinite alternate;
      filter:blur(var(--blur,2px));
    }
    @keyframes flk {
      0%   { transform:scaleX(1) scaleY(1) rotate(var(--r1,-2deg)); opacity:var(--o1,.9); }
      100% { transform:scaleX(var(--sx,.9)) scaleY(var(--sy,1.1)) rotate(var(--r2,2deg)); opacity:var(--o2,1); }
    }
    #fire-intro.fade-out { animation:fadeOutI .5s 3.2s forwards; }
    @keyframes fadeOutI { to{opacity:0;pointer-events:none} }
    #fire-intro.gone { display:none; }

    /* ===== APP ===== */
    #app { display:none; }
    #app.visible { display:block; }

    /* ===== BOTTOM NAV ===== */
    .bottom-nav {
      position:fixed; bottom:0; left:0; right:0;
      background:linear-gradient(135deg,#0f3d22,#14532d);
      display:flex; align-items:center; justify-content:space-around;
      padding:8px 0 env(safe-area-inset-bottom,10px); z-index:100;
      box-shadow:0 -1px 0 rgba(255,255,255,.06), 0 -4px 24px rgba(10,46,26,.4);
    }
    .nav-btn {
      display:flex; flex-direction:column; align-items:center; gap:3px;
      background:none; border:none; cursor:pointer; color:#4a8c6a;
      font-family:'Nunito',sans-serif; font-size:9px; font-weight:700;
      letter-spacing:1px; padding:6px 12px; border-radius:12px;
      transition:all var(--transition); position:relative;
    }
    .nav-btn.active { color:#4ade80; }
    .nav-btn.active::after {
      content:''; position:absolute; bottom:-2px; left:50%; transform:translateX(-50%);
      width:20px; height:3px; background:#4ade80; border-radius:2px;
      box-shadow:0 0 8px rgba(74,222,128,.6);
    }
    .nav-btn:active { transform:scale(.9); }
    .nav-btn svg { width:20px; height:20px; transition:transform var(--transition); }
    .nav-btn.active svg { transform:scale(1.1); }

    /* ===== PAGES ===== */
    .page { display:none; padding-bottom:90px; }
    .page.active { display:block; animation:pageFadeIn .25s ease; }
    @keyframes pageFadeIn { from{opacity:0;transform:translateY(6px)} to{opacity:1;transform:translateY(0)} }

    /* ===== TOP BAR ===== */
    .app-topbar {
      display:flex; align-items:center; justify-content:space-between;
      padding:14px 16px 10px;
      background:linear-gradient(135deg,#f0fdf4,#dcfce7);
      border-bottom:1px solid var(--border);
      position:sticky; top:0; z-index:10;
      box-shadow:0 1px 8px rgba(20,83,45,.06);
    }
    .app-name {
      font-family:'Bebas Neue',sans-serif;
      font-size:26px; letter-spacing:6px; color:#14532d;
    }

    /* ===== STREAK HERO ===== */
    .streak-hero {
      background:linear-gradient(135deg,#0f3d22 0%,#14532d 50%,#166534 100%);
      padding:24px 16px 22px; text-align:center; position:relative; overflow:hidden;
    }
    .streak-hero::before {
      content:''; position:absolute; inset:0;
      background:radial-gradient(circle at 30% 50%,rgba(74,222,128,.18) 0%,transparent 60%),
                 radial-gradient(circle at 80% 20%,rgba(134,239,172,.1) 0%,transparent 50%);
    }
    .streak-hero::after {
      content:''; position:absolute; bottom:0; left:0; right:0; height:1px;
      background:linear-gradient(90deg,transparent,rgba(74,222,128,.3),transparent);
    }
    .streak-num-big {
      font-family:'Bebas Neue',sans-serif;
      font-size:clamp(80px,22vw,130px); line-height:1;
      color:#4ade80; position:relative; display:inline-block;
      text-shadow:0 0 60px rgba(74,222,128,.5), 0 0 120px rgba(74,222,128,.2);
      animation:streakPulse 4s ease-in-out infinite;
    }
    @keyframes streakPulse {
      0%,100%{text-shadow:0 0 40px rgba(74,222,128,.4),0 0 80px rgba(74,222,128,.15);}
      50%{text-shadow:0 0 60px rgba(74,222,128,.7),0 0 120px rgba(74,222,128,.3);}
    }
    .streak-label {
      font-family:'Space Mono',monospace; font-size:11px;
      letter-spacing:5px; color:#86efac; margin-top:-4px; opacity:.8;
    }
    .streak-badge-name {
      font-family:'Bebas Neue',sans-serif; font-size:22px;
      letter-spacing:4px; color:#fff; margin-top:8px;
      opacity:.9;
    }

    /* ===== CURRENT BADGE HERO ===== */
    .current-badge-hero {
      background:var(--card); padding:16px 16px 12px;
      border-bottom:1px solid var(--border);
      text-align:center;
    }
    .badge-label-top {
      font-family:'Space Mono',monospace; font-size:11px;
      letter-spacing:4px; color:var(--muted); margin-bottom:6px;
    }
    .badge-hero-name {
      font-family:'Bebas Neue',sans-serif; font-size:34px;
      letter-spacing:4px; color:#14532d; margin-bottom:2px;
    }
    .badge-hero-day {
      font-family:'Space Mono',monospace; font-size:12px;
      letter-spacing:3px; color:var(--muted); margin-bottom:12px;
    }
    .badge-gif-area {
      width:100%; max-width:500px; margin:0 auto;
      height:200px; border-radius:16px; overflow:hidden;
      background:var(--xlight-green); position:relative; cursor:pointer;
      transition:transform .2s; border:2px solid var(--border);
    }
    .badge-gif-area:active { transform:scale(.98); }
    .badge-gif-area img { width:100%; height:100%; object-fit:cover; }
    .badge-gif-tap {
      width:100%; height:100%;
      display:flex; align-items:center; justify-content:center;
      font-family:'Space Mono',monospace; font-size:13px;
      color:#6b7280; background:var(--xlight-green);
    }

    /* Progress bar section */
    .progress-section {
      background:linear-gradient(135deg,#14532d,#166534);
      margin:12px 16px 0; border-radius:14px; padding:16px; color:#fff;
    }
    .progress-days-row {
      font-family:'Space Mono',monospace; font-size:13px;
      color:#86efac; margin-bottom:4px;
    }
    .progress-target-row {
      font-family:'Space Mono',monospace; font-size:11px;
      color:#4ade80; margin-bottom:12px;
      display:flex; align-items:center; gap:6px;
    }
    .progress-bar-track {
      height:26px; background:rgba(255,255,255,.15); border-radius:13px;
      overflow:hidden; position:relative;
    }
    .progress-bar-fill {
      height:100%; background:linear-gradient(90deg,#4ade80,#22c55e,#16a34a);
      border-radius:13px;
      transition:width 1s cubic-bezier(.4,0,.2,1);
      min-width:4px; position:relative;
    }
    .progress-bar-fill::after {
      content:''; position:absolute; right:0; top:0; bottom:0; width:24px;
      background:linear-gradient(90deg,transparent,rgba(255,255,255,.35));
      border-radius:0 13px 13px 0;
      animation:shimmerBar 2s ease-in-out infinite;
    }
    @keyframes shimmerBar { 0%,100%{opacity:.6} 50%{opacity:1} }
    .progress-pct {
      font-family:'Bebas Neue',sans-serif; font-size:12px;
      color:#fff; text-align:center; letter-spacing:2px;
      pointer-events:none; white-space:nowrap;
      text-shadow:0 1px 3px rgba(0,0,0,.4);
    }

    /* Check-in button */
    .checkin-wrap { padding:12px 16px; background:var(--card); border-bottom:1px solid var(--border); }
    .checkin-btn {
      width:100%; padding:15px; border:none; border-radius:14px;
      font-family:'Bebas Neue',sans-serif; font-size:22px;
      letter-spacing:3px; cursor:pointer; transition:all .2s cubic-bezier(.34,1.56,.64,1);
    }
    .checkin-btn.available {
      background:linear-gradient(135deg,#22c55e,#16a34a); color:#fff;
      box-shadow:0 4px 20px rgba(34,197,94,.35), 0 1px 0 rgba(255,255,255,.2) inset;
    }
    .checkin-btn.available:active { transform:scale(.97); box-shadow:0 2px 10px rgba(34,197,94,.3); }
    .checkin-btn.done {
      background:linear-gradient(135deg,#f0fdf4,#dcfce7); color:var(--dark-green);
      border:2px solid var(--green); box-shadow:var(--shadow-sm);
    }
    .timer-sm {
      text-align:center; margin-top:7px;
      font-family:'Bebas Neue',sans-serif; font-size:11px; color:var(--muted);
    }
    .timer-sm span { color:var(--red); font-weight:700; }

    /* ALL BADGES section */
    .all-badges-header {
      text-align:center; padding:16px 0 8px;
      font-family:'Space Mono',monospace; font-size:12px;
      letter-spacing:4px; color:var(--dark-green);
    }
    .all-badges-arrow {
      text-align:center; color:var(--green); font-size:20px; margin-bottom:8px;
    }

    /* Badge cards */
    .badges-list { padding:0 16px 20px; }
    .badge-card {
      border-radius:16px; margin-bottom:10px;
      display:flex; align-items:center;
      overflow:hidden; transition:transform .15s, box-shadow .15s; cursor:pointer;
    }
    .badge-card:active { transform:scale(.985); }
    .badge-card.state-current { box-shadow:0 4px 20px rgba(34,197,94,.3); }
    .badge-card.state-future:active { transform:scale(.99); }

    /* CURRENT = bright green gradient ‚Äî active now */
    .badge-card.state-current {
      background:linear-gradient(135deg,#16a34a,#15803d);
      box-shadow:0 4px 20px rgba(34,197,94,.3);
    }
    .badge-card.state-current .bc-left-text { color:#fff; }
    .badge-card.state-current .bc-day { color:rgba(255,255,255,.75); }

    /* PAST = soft muted green ‚Äî already achieved, stepping stone */
    .badge-card.state-past { background:linear-gradient(135deg,#14532d,#166534); }
    .badge-card.state-past .bc-left-text { color:#86efac; }
    .badge-card.state-past .bc-day { color:#4ade80; }

    /* FUTURE = smoky white / light green */
    .badge-card.state-future { background:#f9fffe; border:1px solid #d1fae5; }
    .badge-card.state-future .bc-left-text { color:#6b7280; }
    .badge-card.state-future .bc-day { color:#9ca3af; }

    .bc-left { flex:1; padding:18px 16px; }
    .bc-day { font-family:'Space Mono',monospace; font-size:10px; letter-spacing:2px; margin-bottom:4px; }
    .bc-left-text { font-family:'Bebas Neue',sans-serif; font-size:22px; letter-spacing:3px; }

    .bc-right { width:110px; height:74px; flex-shrink:0; position:relative; background:#e8f5e9; overflow:hidden; }
    .bc-right img { width:100%; height:100%; object-fit:cover; }
    .bc-right-tap { width:100%; height:100%; display:flex; align-items:center; justify-content:center; font-size:11px; color:#6b7280; font-family:'Space Mono',monospace; background:#f0fdf4; cursor:pointer; }
    .bc-right-locked { width:100%; height:100%; display:flex; align-items:center; justify-content:center; font-size:22px; background:#f9fffe; }
    /* Past badge right side ‚Äî slightly tinted */
    /* ===== GRID PAGE ===== */
    .grid-page-header {
      padding:14px 16px 10px;
      background:linear-gradient(135deg,#f0fdf4,#dcfce7);
      border-bottom:1px solid var(--border);
    }
    .grid-tabs-row { display:flex; gap:8px; align-items:center; margin-top:10px; }
    .grid-tab {
      padding:7px 14px; border-radius:20px;
      border:2px solid #86efac; background:#f0fdf4;
      cursor:pointer; font-family:'Bebas Neue',sans-serif;
      font-size:15px; letter-spacing:2px; color:#6b7280;
      transition:all .2s;
    }
    .grid-tab.active { background:var(--green); border-color:var(--green); color:#fff; }
    .share-icon-btn { margin-left:auto; background:none; border:none; cursor:pointer; color:#16a34a; transition:transform var(--transition); }
    .share-icon-btn:active { transform:scale(.9); }

    .achieved-banner {
      margin:12px 16px; border-radius:14px; padding:18px;
      text-align:center; display:none;
      background:linear-gradient(135deg,var(--dark-green),var(--green));
      box-shadow:0 4px 20px rgba(34,197,94,.25);
    }
    .achieved-banner.show { display:block; }
    .achieved-banner h2 { font-family:'Bebas Neue',sans-serif; font-size:34px; letter-spacing:1px; color:#fff; }
    .achieved-banner p { font-size:13px; color:rgba(255,255,255,.85); margin-top:4px; }

    .grid-scroll-area { overflow-x:auto; padding:16px; -webkit-overflow-scrolling:touch; }
    .grid-scroll-area::-webkit-scrollbar { display:none; }
    .number-grid-wrapper { display:inline-flex; gap:4px; min-width:max-content; }
    .grid-table { border-collapse:collapse; }
    .gc { border:1px solid #ccc; font-family:'Space Mono',monospace; text-align:center; vertical-align:middle; background:#fff; transition:background .3s; color:#bbb; }
    .gc.filled { background:var(--green) !important; color:#fff !important; border-color:var(--dark-green) !important; font-weight:700; }
    .gc.today-cell { border:2px solid var(--red) !important; color:var(--red) !important; font-weight:700; }
    .gc.empty { background:#f8f8f8; border-color:#f0f0f0; color:transparent; pointer-events:none; }
    .grid-block { border:3px solid #14532d; display:inline-block; }

    /* ===== CHECK-IN LOG MODAL ===== */
    .modal-overlay { position:fixed; inset:0; background:rgba(0,0,0,.5); display:flex; align-items:flex-end; justify-content:center; z-index:9000; backdrop-filter:blur(2px); }
    .modal-sheet {
      background:#fff; border-radius:24px 24px 0 0; padding:8px 20px 24px; width:100%; max-width:480px; max-height:85vh; overflow-y:auto;
      box-shadow:0 -8px 40px rgba(0,0,0,.15);
    }
    .modal-sheet::before {
      content:''; display:block; width:40px; height:4px; border-radius:2px;
      background:#e5e7eb; margin:0 auto 16px;
    }
    .modal-title { font-family:'Bebas Neue',sans-serif; font-size:22px; letter-spacing:4px; color:#14532d; margin-bottom:16px; }
    .study-form label { font-family:'Space Mono',monospace; font-size:11px; letter-spacing:2px; color:var(--muted); display:block; margin-bottom:6px; margin-top:14px; }
    .study-form input, .study-form select {
      width:100%; padding:12px 14px; border:2px solid var(--border); border-radius:10px;
      font-family:'Nunito',sans-serif; font-size:14px; color:#111; background:#f9fafb; outline:none;
      transition:border-color var(--transition);
    }
    .study-form input:focus, .study-form select:focus { border-color:var(--green); background:#fff; }
    .study-form .time-row { display:flex; gap:10px; }
    .study-form .time-row > * { flex:1; }
    .study-form-btn {
      margin-top:18px; width:100%; padding:14px; background:linear-gradient(135deg,#22c55e,#16a34a);
      border:none; border-radius:14px; color:#fff;
      font-family:'Bebas Neue',sans-serif; font-size:20px; letter-spacing:3px; cursor:pointer;
      box-shadow:0 4px 16px rgba(34,197,94,.3); transition:all .2s;
    }
    .study-form-btn:active { transform:scale(.98); }

    /* ===== ANALYTICS PAGE ===== */
    .analytics-wrap { padding:0 0 20px; }
    /* Forest garden hero */
    .forest-hero {
      background:linear-gradient(180deg,#1a5c38 0%,#1e7a40 60%,#2d9e58 100%);
      padding:18px 16px 24px; position:relative; overflow:hidden;
    }
    .forest-period-bar {
      display:flex; background:rgba(0,0,0,.25); border-radius:20px; padding:3px;
      margin-bottom:14px; gap:2px;
    }
    .forest-period-btn {
      flex:1; padding:7px 4px; border-radius:18px; border:none; cursor:pointer;
      font-family:'Nunito',sans-serif; font-size:12px; font-weight:700;
      color:rgba(255,255,255,.6); background:transparent; transition:all .2s;
    }
    .forest-period-btn.active { background:#fff; color:#14532d; }
    .forest-date-nav { display:flex; align-items:center; justify-content:center; gap:12px; margin-bottom:14px; }
    .forest-date-nav span { font-family:'Nunito',sans-serif; font-size:14px; font-weight:700; color:#fff; }
    .forest-date-nav button { background:rgba(255,255,255,.15); border:none; color:#fff; width:28px; height:28px; border-radius:50%; cursor:pointer; font-size:16px; }
    /* SVG isometric forest */
    .forest-scene { width:100%; height:180px; display:block; margin:0 auto; }
    .forest-stats-row { display:flex; justify-content:flex-end; gap:14px; margin-top:8px; }
    .forest-stat { display:flex; align-items:center; gap:5px; font-family:'Nunito',sans-serif; font-size:13px; font-weight:700; color:#fff; }

    .analytics-card { background:#fff; border:1px solid var(--border); border-radius:0; padding:18px 16px; margin-bottom:1px; }
    .analytics-card:first-of-type { border-radius:16px 16px 0 0; }
    .analytics-card:last-child { border-radius:0 0 16px 16px; }
    .analytics-title-lg { font-size:18px; font-weight:900; color:#111; margin-bottom:4px; font-family:'Nunito',sans-serif; }
    .analytics-sub { font-size:13px; color:#6b7280; margin-bottom:14px; }
    .analytics-sub span { color:var(--green); font-weight:700; }

    /* Bar chart */
    .bar-chart { display:flex; align-items:flex-end; gap:4px; height:200px; margin-bottom:6px; position:relative; padding-left:28px; }
    .bar-chart-grid { position:absolute; left:28px;right:0;top:0;bottom:0; display:flex; flex-direction:column; justify-content:space-between; pointer-events:none; }
    .bar-chart-line { border-top:1px solid #f0f0f0; width:100%; display:flex; align-items:center; }
    .bar-chart-line span { font-family:'Space Mono',monospace; font-size:8px; color:#bbb; margin-left:2px; position:absolute; left:0; white-space:nowrap; }
    .bar-item { flex:1; display:flex; flex-direction:column; align-items:center; gap:2px; position:relative; z-index:1; height:100%; justify-content:flex-end; }
    .bar-fill { width:75%; background:linear-gradient(180deg,#86efac,#22c55e,#16a34a); border-radius:6px 6px 0 0; min-height:4px; transition:height .7s cubic-bezier(.4,0,.2,1); box-shadow:0 2px 8px rgba(34,197,94,.3); }
    .bar-fill.today { background:linear-gradient(180deg,#bbf7d0,#4ade80,#22c55e); box-shadow:0 2px 12px rgba(74,222,128,.5); }
    .bar-label { font-family:'Space Mono',monospace; font-size:8px; color:var(--muted); text-align:center; }
    .bar-val { font-family:'Space Mono',monospace; font-size:8px; color:var(--dark-green); font-weight:700; }

    /* Line chart for "Most Focused Period" */
    .line-chart-wrap { width:100%; height:90px; position:relative; margin-bottom:6px; }
    .line-chart-wrap svg { width:100%; height:100%; }
    .chart-axis-label { display:flex; justify-content:space-between; font-family:'Space Mono',monospace; font-size:8px; color:#ccc; }

    /* Focus trend comparison bars */
    .trend-row { margin-bottom:12px; }
    .trend-row-label { font-size:12px; color:#6b7280; margin-bottom:4px; display:flex; justify-content:space-between; }
    .trend-row-label span { font-weight:700; color:#111; }
    .trend-bar-track { height:8px; background:#f0fdf4; border-radius:4px; overflow:hidden; }
    .trend-bar-fill { height:100%; background:linear-gradient(90deg,#4ade80,#22c55e); border-radius:4px; transition:width .8s; }
    .trend-compare { font-size:11px; color:var(--green); font-weight:700; margin-top:2px; }

    /* Donut chart */
    .donut-wrap { display:flex; align-items:center; gap:16px; }
    .donut-svg-wrap { position:relative; flex-shrink:0; }
    .donut-center-text { position:absolute; inset:0; display:flex; flex-direction:column; align-items:center; justify-content:center; }
    .donut-pct { font-family:'Bebas Neue',sans-serif; font-size:22px; color:#14532d; line-height:1; }
    .donut-lbl { font-family:'Space Mono',monospace; font-size:8px; color:#9ca3af; }
    .donut-legend { flex:1; }
    .donut-leg-row { display:flex; align-items:center; gap:8px; padding:5px 0; border-bottom:1px solid #f5f5f5; }
    .donut-leg-row:last-child { border-bottom:none; }
    .donut-dot { width:10px; height:10px; border-radius:50%; flex-shrink:0; }
    .donut-leg-name { flex:1; font-size:12px; font-weight:700; color:#333; }
    .donut-leg-pct { font-family:'Space Mono',monospace; font-size:10px; color:#6b7280; }
    .donut-leg-mins { font-family:'Space Mono',monospace; font-size:10px; color:var(--dark-green); font-weight:700; }

    /* Subject rows */
    .subject-row { display:flex; align-items:center; gap:10px; padding:8px 0; border-bottom:1px solid var(--border); }
    .subject-row:last-child { border-bottom:none; }
    .subject-dot { width:10px; height:10px; border-radius:50%; flex-shrink:0; }
    .subject-name { flex:1; font-size:13px; font-weight:700; color:#14532d; }
    .subject-hours { font-family:'Space Mono',monospace; font-size:11px; color:var(--muted); }

    /* ===== JOURNAL PAGE ===== */
    .journal-wrap { padding:12px 16px 20px; }
    .journal-form-card {
      background:#fff; border:1px solid var(--border); border-radius:16px;
      padding:16px; margin-bottom:14px; box-shadow:var(--shadow-sm);
    }
    .journal-form-title { font-family:'Bebas Neue',sans-serif; font-size:16px; letter-spacing:3px; color:#14532d; margin-bottom:10px; }
    .journal-textarea {
      width:100%; min-height:100px; background:var(--xlight-green);
      border:1px solid var(--border); border-radius:12px;
      padding:12px; color:#111; font-family:'Nunito',sans-serif;
      font-size:14px; line-height:1.6; resize:none; outline:none;
      transition:border-color var(--transition), box-shadow var(--transition);
    }
    .journal-textarea:focus { border-color:var(--green); box-shadow:0 0 0 3px rgba(34,197,94,.1); }
    .journal-save-btn {
      margin-top:10px; width:100%; padding:15px;
      background:linear-gradient(135deg,#22c55e,#16a34a);
      border:none; border-radius:12px; color:#fff;
      font-family:'Bebas Neue',sans-serif; font-size:18px; letter-spacing:3px; cursor:pointer;
      box-shadow:0 4px 16px rgba(34,197,94,.25); transition:all .2s;
    }
    .journal-save-btn:active { transform:scale(.98); }
    /* Daily quote card ‚Äî pure quote only */
    .quote-card {
      position: relative; margin-bottom:14px; border-radius:20px; overflow:hidden;
      background: linear-gradient(145deg, #0a2e1a 0%, #0f3d24 45%, #0d2e1c 100%);
      box-shadow: 0 8px 32px rgba(10,46,26,.5), inset 0 1px 0 rgba(255,255,255,.06);
      min-height: 110px;
    }
    .quote-card::before {
      content:''; position:absolute; inset:0; pointer-events:none;
      background:
        radial-gradient(ellipse at 10% 0%, rgba(74,222,128,.13) 0%, transparent 55%),
        radial-gradient(ellipse at 90% 100%, rgba(34,197,94,.08) 0%, transparent 55%);
    }
    .quote-card::after {
      content:''; position:absolute; inset:0; pointer-events:none;
      background-image: repeating-linear-gradient(
        0deg, transparent, transparent 28px,
        rgba(74,222,128,.025) 28px, rgba(74,222,128,.025) 29px
      );
    }
    .quote-big-mark {
      position:absolute; bottom:-24px; right:8px; font-size:120px; line-height:1;
      color:rgba(74,222,128,.05); font-family:'Playfair Display',Georgia,serif;
      font-style:italic; user-select:none; pointer-events:none; z-index:0;
      transform: scaleX(-1);
    }
    .quote-card-inner { padding: 16px 18px 20px; position:relative; z-index:1; }
    .quote-text {
      font-family:'Playfair Display',Georgia,serif;
      font-size:16px; line-height:1.8; color:#e8f5e9;
      font-style:italic; position:relative; z-index:1; letter-spacing:.01em;
    }
    .quote-text.fade-in { animation:quoteFade .4s ease; }
    @keyframes quoteFade { from{opacity:0;transform:translateY(6px)} to{opacity:1;transform:translateY(0)} }
    .quote-text.hindi {
      font-family:'Nunito',sans-serif; font-style:normal;
      font-size:15px; font-weight:600; color:#f0fdf4;
    }
    .quote-lang-tag, .quote-divider, .quote-meta,
    .quote-source-pill, .quote-dot, .quote-source-name,
    .quote-author { display:none; }
    .quote-refresh-btn {
      position:relative; z-index:2; float:right; margin-bottom:6px;
      background:rgba(255,255,255,.07); border:1px solid rgba(255,255,255,.1);
      border-radius:10px; padding:5px 10px; color:rgba(134,239,172,.5);
      cursor:pointer; font-size:14px; transition:all .2s; line-height:1;
    }
    .quote-refresh-btn:active { transform:rotate(180deg); color:#86efac; }

    .journal-entry-card {
      background:#fff; border:1px solid var(--border); border-radius:12px;
      padding:10px 12px; margin-bottom:8px;
      display:flex; align-items:stretch; gap:10px;
      overflow:hidden; cursor:pointer; height:72px;
    }
    .journal-entry-card.type-break { border-left:4px solid #ef4444; }
    .journal-entry-card.type-study { border-left:4px solid var(--green); }
    .journal-entry-card.type-entry { border-left:4px solid #3b82f6; }
    .jec-left { flex:1; min-width:0; display:flex; flex-direction:column; justify-content:space-between; }
    .jec-top { display:flex; align-items:center; gap:6px; }
    .jec-type-dot { width:7px; height:7px; border-radius:50%; flex-shrink:0; }
    .jec-type-label { font-family:'Bebas Neue',sans-serif; font-size:9px; color:var(--muted); letter-spacing:1px; }
    .jec-subject { font-family:'Bebas Neue',sans-serif; font-size:9px; color:var(--dark-green); font-weight:700; }
    .jec-preview { font-size:12px; color:#333; line-height:1.4; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; flex:1; }
    .jec-bottom { display:flex; align-items:center; justify-content:space-between; }
    .jec-date { font-family:'Bebas Neue',sans-serif; font-size:9px; color:var(--muted); }
    .jec-streak { font-family:'Bebas Neue',sans-serif; font-size:9px; color:var(--dark-green); }
    .jec-right { display:flex; flex-direction:column; align-items:center; justify-content:space-between; flex-shrink:0; }
    .jec-del { background:none; border:none; color:#ef4444; cursor:pointer; font-size:14px; padding:0; line-height:1; }
    .jec-time { font-family:'Bebas Neue',sans-serif; font-size:9px; color:var(--muted); }

    /* ===== SETTINGS PAGE ===== */
    .settings-wrap { padding:12px 16px 20px; }
    .settings-card {
      background:#fff; border:1px solid var(--border); border-radius:16px;
      padding:16px; margin-bottom:14px;
      box-shadow:var(--shadow-sm); transition:box-shadow var(--transition);
    }
    .settings-card:hover { box-shadow:var(--shadow-md); }
    .settings-card-title { font-family:'Bebas Neue',sans-serif; font-size:14px; letter-spacing:4px; color:#14532d; margin-bottom:12px; }
    .setting-row { display:flex; align-items:center; justify-content:space-between; padding:11px 0; border-bottom:1px solid var(--border); }
    .setting-row:last-child { border-bottom:none; }
    .setting-label { font-size:14px; font-weight:700; }
    .setting-sub { font-size:10px; color:var(--muted); margin-top:2px; font-family:'Space Mono',monospace; }
    .toggle { width:44px; height:26px; background:#ddd; border-radius:13px; position:relative; cursor:pointer; transition:background .2s; flex-shrink:0; }
    .toggle.on { background:var(--green); }
    .toggle::after { content:''; position:absolute; width:20px; height:20px; border-radius:50%; background:#fff; top:3px; left:3px; transition:left .2s; box-shadow:0 1px 4px rgba(0,0,0,.2); }
    .toggle.on::after { left:21px; }
    .action-btn { padding:8px 14px; border-radius:8px; border:1px solid var(--border); background:#f9fafb; font-family:'Nunito',sans-serif; font-weight:700; font-size:12px; cursor:pointer; color:#333; }
    .action-btn.success { border-color:var(--green); color:var(--dark-green); }
    .action-btn.danger { border-color:var(--red); color:var(--red); }
    .reminder-tags { display:flex; flex-wrap:wrap; gap:6px; margin:8px 0; }
    .reminder-tag { display:inline-flex; align-items:center; gap:5px; padding:4px 10px; background:var(--xlight-green); border:1px solid var(--green); border-radius:8px; font-size:11px; font-family:'Space Mono',monospace; color:var(--dark-green); }
    .reminder-tag button { background:none; border:none; color:var(--red); cursor:pointer; font-size:14px; }
    .reminder-add-row { display:flex; gap:8px; margin-top:8px; }
    input[type="time"] { flex:1; padding:8px 12px; background:#f9fafb; border:1px solid var(--border); border-radius:8px; font-family:'Space Mono',monospace; font-size:12px; color:#111; outline:none; }
    .quotes-input { width:100%; padding:10px 12px; background:#f9fafb; border:1px solid var(--border); border-radius:8px; font-family:'Nunito',sans-serif; font-size:14px; color:#111; outline:none; margin-bottom:8px; }
    .quotes-input:focus { border-color:var(--green); }
    .quotes-author-row { display:none; }
    .quotes-add-btn { padding:10px 16px; background:var(--green); border:none; border-radius:8px; color:#fff; font-family:'Bebas Neue',sans-serif; font-size:18px; cursor:pointer; }
    .custom-q-item { display:flex; align-items:center; gap:8px; padding:10px; background:var(--xlight-green); border-radius:8px; margin-bottom:6px; }
    .custom-q-text { flex:1; font-size:12px; color:#14532d; line-height:1.5; }
    .custom-q-del { background:none; border:none; color:var(--red); cursor:pointer; font-size:18px; }
    .gif-item { margin-bottom:10px; padding:10px; background:var(--xlight-green); border-radius:10px; border:1px solid var(--border); }
    .gif-label { font-family:'Bebas Neue',sans-serif; font-size:13px; letter-spacing:2px; color:#14532d; margin-bottom:6px; }
    .gif-input { width:100%; padding:8px; background:#fff; border:1px solid var(--border); border-radius:8px; font-size:12px; color:#111; outline:none; }
    .gif-input:focus { border-color:var(--green); }

    /* ===== TOAST ===== */
    .toast {
      position:fixed; top:max(20px, env(safe-area-inset-top, 20px)); left:50%;
      transform:translateX(-50%); background:#0f3d22;
      color:#86efac; padding:12px 22px; border-radius:50px; font-weight:700; font-size:14px;
      z-index:9998; white-space:nowrap; max-width:90vw; text-align:center;
      box-shadow:0 4px 24px rgba(0,0,0,.2), 0 1px 0 rgba(255,255,255,.1) inset;
      animation:toastIn .35s cubic-bezier(.34,1.56,.64,1);
      border:1px solid rgba(74,222,128,.2);
    }
    @keyframes toastIn { from{transform:translateX(-50%) translateY(-20px);opacity:0} to{transform:translateX(-50%) translateY(0);opacity:1} }

    /* ===== SUCCESS CARD ===== */
    .success-overlay { position:fixed; inset:0; background:rgba(0,0,0,.6); backdrop-filter:blur(4px); display:flex; align-items:center; justify-content:center; z-index:9997; }
    .success-card {
      background:#fff; border-radius:24px; padding:40px 28px; text-align:center;
      max-width:300px; width:90%; box-shadow:0 24px 80px rgba(0,0,0,.3);
      animation:popIn .4s cubic-bezier(.34,1.56,.64,1);
      border:1px solid var(--border);
    }
    @keyframes popIn { from{transform:scale(.6);opacity:0} to{transform:scale(1);opacity:1} }
    .success-emoji-big { font-size:60px; }
    .success-title { font-family:'Bebas Neue',sans-serif; font-size:32px; color:var(--green); letter-spacing:3px; margin-top:8px; }
    .success-big-num { font-family:'Bebas Neue',sans-serif; font-size:80px; line-height:1; color:#14532d; }
    .success-sub { font-size:11px; letter-spacing:4px; color:var(--muted); }
    .success-badge { font-family:'Bebas Neue',sans-serif; font-size:20px; color:var(--dark-green); letter-spacing:2px; margin-top:8px; }
    .success-close-btn {
      margin-top:20px; width:100%; padding:14px;
      background:linear-gradient(135deg,#22c55e,#16a34a); border:none; border-radius:14px;
      color:#fff; font-family:'Bebas Neue',sans-serif; font-size:20px; letter-spacing:2px;
      cursor:pointer; box-shadow:0 4px 16px rgba(34,197,94,.3); transition:all .2s;
    }
    .success-close-btn:active { transform:scale(.98); }

    /* ===== BROKEN CHAIN MODAL ===== */
    .broken-overlay { position:fixed; inset:0; background:rgba(0,0,0,.65); display:flex; align-items:center; justify-content:center; z-index:9998; }
    .broken-card {
      background:#fff; border-radius:24px; padding:32px 24px; text-align:center;
      max-width:320px; width:92%; box-shadow:0 24px 64px rgba(0,0,0,.3);
      animation:popIn .4s cubic-bezier(.34,1.56,.64,1);
    }
    .broken-chain-icon { font-size:64px; line-height:1; margin-bottom:4px; filter:grayscale(.2); }
    .broken-title { font-family:'Bebas Neue',sans-serif; font-size:26px; letter-spacing:2px; color:#ef4444; margin-bottom:4px; font-weight:700; }
    .broken-sub { font-family:'Nunito',sans-serif; font-size:13px; color:#6b7280; margin-bottom:16px; line-height:1.6; }
    .broken-streak-lost { font-family:'Bebas Neue',sans-serif; font-size:56px; line-height:1; color:#14532d; font-weight:700; }
    .broken-streak-label { font-family:'Bebas Neue',sans-serif; font-size:9px; letter-spacing:2px; color:#9ca3af; margin-bottom:20px; }
    .broken-missed-date { font-family:'Bebas Neue',sans-serif; font-size:10px; color:#ef4444; letter-spacing:1px; margin-bottom:18px; background:#fff5f5; padding:8px 14px; border-radius:8px; border:1px solid #fecaca; }
    .broken-note { font-family:'Nunito',sans-serif; font-size:12px; color:#6b7280; margin-bottom:20px; background:#f0fdf4; padding:10px 14px; border-radius:10px; text-align:left; border-left:3px solid #22c55e; }
    .broken-cta { width:100%; padding:15px; background:linear-gradient(135deg,#22c55e,#16a34a); border:none; border-radius:14px; color:#fff; font-family:'Bebas Neue',sans-serif; font-size:18px; letter-spacing:2px; cursor:pointer; }
    .broken-history-btn { margin-top:10px; width:100%; padding:10px; background:none; border:1px solid var(--border); border-radius:10px; color:#6b7280; font-family:'Bebas Neue',sans-serif; font-size:10px; cursor:pointer; letter-spacing:1px; }

    /* Missed days badge in journal */
    .journal-entry-card.type-break { border-left:4px solid #ef4444; }

    ::-webkit-scrollbar { width:3px; height:3px; }
    ::-webkit-scrollbar-track { background:transparent; }
    ::-webkit-scrollbar-thumb { background:#86efac; border-radius:3px; }

    /* Subject color dots */
    .c0{background:#22c55e} .c1{background:#3b82f6} .c2{background:#f59e0b} .c3{background:#ef4444} .c4{background:#8b5cf6} .c5{background:#ec4899} .c6{background:#14b8a6} .c7{background:#f97316}
  </style>
</head>
<body>

<!-- FIRE INTRO -->
<div id="fire-intro">
  <div class="title-wrap">
    <h1>CHAIN</h1>
    <p>DON'T BREAK THE CHAIN</p>
  </div>
  <div class="fire-container" id="fireContainer"></div>
</div>

<!-- MAIN APP -->
<div id="app">

  <!-- ===== BADGES PAGE (Tab 1) ===== -->
  <div class="page active" id="page-badges">
    <div class="app-topbar">
      <div class="app-name">CHAIN</div>
      <div style="font-family:'Bebas Neue',sans-serif;font-size:20px;color:var(--dark-green);" id="headerStreak">0 üî•</div>
    </div>

    <!-- BIG STREAK HERO (merged, no duplicate) -->
    <div class="streak-hero">
      <div class="streak-num-big" id="streakNumBig">0</div>
      <div class="streak-label">D A Y S &nbsp; S T R O N G</div>
      <div class="streak-badge-name" id="streakBadgeHero">üå± BELIEVER</div>
      <div class="badge-gif-area" id="heroBadgeGif" onclick="toggleHeroReveal()" style="max-width:340px;height:170px;margin:14px auto 0;border:2px solid rgba(255,255,255,.2);">
        <div class="badge-gif-tap" style="background:rgba(0,0,0,.2);color:rgba(255,255,255,.5);">No GIF ‚Äî add one in Settings</div>
      </div>
      <!-- Today study status: below GIF, inside hero -->
      <div id="todayStudyStatus" style="margin:16px -16px -18px;display:none;"></div>
    </div>

    <!-- Progress section -->
    <div class="progress-section">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;">
        <div class="progress-days-row" id="progressDaysRow" style="margin-bottom:0;">CURRENT DAYS: 0</div>
        <div class="progress-target-row" style="margin-bottom:0;">
          <span>NEXT TARGET</span>
          <span>‚Üí</span>
          <span id="progressTarget">1 DAYS</span>
        </div>
      </div>
      <div class="progress-bar-track">
        <div class="progress-bar-fill" id="progressFill" style="width:0%"></div>
        <div class="progress-pct" id="progressPct" style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);margin-top:0;">0.0% COMPLETED</div>
      </div>
    </div>

    <!-- Check-in button -->
    <div class="checkin-wrap">
      <button class="checkin-btn available" id="checkinBtn" onclick="handleCheckin()">‚úì CHECK IN TODAY</button>
      <div class="timer-sm">‚è∞ Resets at midnight ¬∑ <span id="timerDisplay">--:--:--</span> left</div>
    </div>

    <div class="all-badges-header">A L L &nbsp; B A D G E S</div>
    <div class="all-badges-arrow">‚Üì</div>
    <div class="badges-list" id="badgesList"></div>
  </div>

  <!-- ===== GRID PAGE (Tab 2) ===== -->
  <div class="page" id="page-grid">
    <div class="grid-page-header">
      <div class="app-name">CHAIN</div>
      <div class="grid-tabs-row">
        <button class="grid-tab active" onclick="setGridTab(90,this)">90 DAYS</button>
        <button class="grid-tab" onclick="setGridTab(180,this)">180 DAYS</button>
        <button class="grid-tab" onclick="setGridTab(365,this)">365 DAYS</button>
        <button class="share-icon-btn" onclick="shareApp()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="22" height="22"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/></svg>
        </button>
      </div>
    </div>
    <div class="achieved-banner" id="banner90"><h2>üèÜ 90 DAYS ACHIEVED!</h2><p>Incredible discipline. You've completed the 90-day challenge!</p></div>
    <div class="achieved-banner" id="banner180"><h2>ü•á 180 DAYS ACHIEVED!</h2><p>Half a year of pure commitment. You are unstoppable!</p></div>
    <div class="achieved-banner" id="banner365"><h2>üëë 365 DAYS ACHIEVED!</h2><p>ONE FULL YEAR! Legend status unlocked.</p></div>
    <div class="grid-scroll-area">
      <div class="number-grid-wrapper" id="gridWrapper"></div>
    </div>
  </div>

  <!-- ===== JOURNAL PAGE (Tab 3) ===== -->
  <div class="page" id="page-journal">
    <div class="app-topbar"><div class="app-name">JOURNAL</div></div>
    <div class="journal-wrap">
      <!-- Daily Motivation Quote -->
      <div class="quote-card" id="dailyQuoteCard">
        <div class="quote-big-mark">"</div>
        <div class="quote-card-inner">
          <div style="display:flex;align-items:flex-end;justify-content:flex-end;">
            <button class="quote-refresh-btn" onclick="showNewQuote()">‚Üª</button>
          </div>
          <div class="quote-text" id="quoteText">Loading inspiration...</div>
        </div>
        <div class="quote-author" id="quoteAuthor"></div>
      </div>

      <div class="journal-form-card">
        <div class="journal-form-title">TODAY'S ENTRY</div>
        <textarea class="journal-textarea" id="journalInput" placeholder="Write your thoughts, struggles, wins..."></textarea>
        <button class="journal-save-btn" onclick="saveJournal()">SAVE ENTRY</button>
      </div>

      <!-- Sort / Filter bar -->
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px;flex-wrap:wrap;">
        <div style="font-family:'Bebas Neue',sans-serif;font-size:13px;letter-spacing:1px;color:#14532d;flex:1;">ALL ENTRIES</div>
        <select id="journalSort" onchange="renderJournal()" style="padding:5px 8px;border:1px solid var(--border);border-radius:8px;font-size:11px;font-family:'Bebas Neue',sans-serif;color:#14532d;background:#f0fdf4;outline:none;">
          <option value="newest">Newest first</option>
          <option value="oldest">Oldest first</option>
        </select>
        <input type="date" id="journalDateFilter" onchange="renderJournal()" style="padding:5px 8px;border:1px solid var(--border);border-radius:8px;font-size:11px;font-family:'Bebas Neue',sans-serif;color:#14532d;background:#f0fdf4;outline:none;">
        <button onclick="document.getElementById('journalDateFilter').value='';renderJournal();" style="padding:5px 8px;border:1px solid var(--border);border-radius:8px;font-size:11px;background:#f0fdf4;cursor:pointer;color:#6b7280;">Clear</button>
      </div>
      <div id="journalList"></div>
    </div>
  </div>

  <!-- Journal Entry Detail Modal -->
  <div id="journalDetailModal" class="modal-overlay" style="display:none;" onclick="if(event.target===this)closeJournalDetail()">
    <div class="modal-sheet" style="max-height:85vh;">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;">
        <div class="modal-title" style="margin-bottom:0;" id="journalDetailTitle">ENTRY</div>
        <button onclick="closeJournalDetail()" style="background:none;border:none;font-size:22px;cursor:pointer;color:#6b7280;">√ó</button>
      </div>
      <div id="journalDetailDate" style="font-family:'Nunito',sans-serif;font-size:11px;font-weight:700;color:#9ca3af;letter-spacing:1.5px;text-transform:uppercase;margin-bottom:6px;"></div>
      <div id="journalDetailStreak" style="display:flex;flex-wrap:wrap;align-items:center;gap:6px;margin-bottom:18px;padding-bottom:14px;border-bottom:1px solid #f0fdf4;"></div>
      <div id="journalDetailText" style="font-family:'Nunito',sans-serif;font-size:15px;line-height:1.8;color:#333;white-space:pre-wrap;"></div>
    </div>
  </div>

  <!-- ===== ANALYTICS PAGE (Tab 4) ===== -->
  <div class="page" id="page-analytics">
    <div class="app-topbar" style="flex-wrap:wrap;gap:8px;">
      <div class="app-name">ANALYTICS</div>
      <button onclick="resetAnalytics()" style="padding:6px 12px;border:1px solid #ef4444;border-radius:8px;background:#fff5f5;color:#ef4444;font-family:'Bebas Neue',sans-serif;font-size:10px;cursor:pointer;font-weight:700;">RESET DATA</button>
    </div>
    <div class="analytics-wrap">
      <!-- Period Header -->
      <div class="forest-hero">
        <div class="forest-period-bar">
          <button class="forest-period-btn active" onclick="setForestPeriod('day',this)">Day</button>
          <button class="forest-period-btn" onclick="setForestPeriod('week',this)">Week</button>
          <button class="forest-period-btn" onclick="setForestPeriod('month',this)">Month</button>
          <button class="forest-period-btn" onclick="setForestPeriod('year',this)">Year</button>
        </div>
        <div class="forest-date-nav">
          <button onclick="shiftPeriod(-1)">‚Äπ</button>
          <span id="forestDateLabel">Today</span>
          <button onclick="shiftPeriod(1)">‚Ä∫</button>
        </div>
        <!-- Summary stats instead of forest -->
        <div style="display:flex;gap:10px;margin-top:8px;">
          <div style="flex:1;background:rgba(255,255,255,.15);border-radius:12px;padding:12px;text-align:center;">
            <div style="font-family:'Bebas Neue',sans-serif;font-size:28px;color:#fff;" id="statTotalHours">0h</div>
            <div style="font-family:'Bebas Neue',sans-serif;font-size:9px;color:#86efac;">TOTAL STUDY</div>
          </div>
          <div style="flex:1;background:rgba(255,255,255,.15);border-radius:12px;padding:12px;text-align:center;">
            <div style="font-family:'Bebas Neue',sans-serif;font-size:28px;color:#fff;" id="statSessions">0</div>
            <div style="font-family:'Bebas Neue',sans-serif;font-size:9px;color:#86efac;">SESSIONS</div>
          </div>
          <div style="flex:1;background:rgba(255,255,255,.15);border-radius:12px;padding:12px;text-align:center;">
            <div style="font-family:'Bebas Neue',sans-serif;font-size:22px;color:#fff;line-height:1.1;" id="statPeak">‚Äî</div>
            <div style="font-family:'Bebas Neue',sans-serif;font-size:9px;color:#86efac;">PEAK TIME</div>
          </div>
        </div>
      </div>

      <!-- Focused Time Distribution -->
      <div class="analytics-card">
        <div class="analytics-title-lg">Focused Time Distribution</div>
        <div class="analytics-sub">Total: <span id="totalFocused">0</span></div>
        <div class="bar-chart" id="studyBarChart">
          <div class="bar-chart-grid" id="barChartGrid"></div>
        </div>
        <div class="chart-axis-label" id="barAxisLabels"></div>
      </div>

      <!-- Most Focused Period -->
      <div class="analytics-card">
        <div class="analytics-title-lg">Best Study Window</div>
        <div class="analytics-sub" id="peakTimeSubtitle">Your most consistent study block across all sessions</div>
        <div style="display:none"><span id="peakHourLabel">‚Äî</span></div>
        <div class="line-chart-wrap">
          <svg id="lineChartSvg" viewBox="0 0 300 80" xmlns="http://www.w3.org/2000/svg" style="width:100%;height:80px;"></svg>
        </div>
        <div class="chart-axis-label">
          <span>12am</span><span>6am</span><span>12pm</span><span>6pm</span><span>11pm</span>
        </div>
      </div>

      <!-- Focus Trend -->
      <div class="analytics-card">
        <div class="analytics-title-lg">Focus Trend</div>
        <div id="trendSection"></div>
      </div>

      <!-- Subject Distribution Donut -->
      <div class="analytics-card">
        <div class="analytics-title-lg">Subject Distribution</div>
        <div id="donutEmpty" style="display:none;text-align:center;color:#9ca3af;font-size:12px;padding:14px;">No data yet for this period</div>
        <div class="donut-wrap" style="margin-top:10px;" id="donutWrap">
          <div class="donut-svg-wrap">
            <svg id="donutSvg" viewBox="0 0 120 120" width="120" height="120"></svg>
            <div class="donut-center-text">
              <div class="donut-pct" id="donutTopPct">‚Äî</div>
              <div class="donut-lbl">TOP</div>
            </div>
          </div>
          <div class="donut-legend" id="donutLegend"></div>
        </div>
      </div>

      <!-- All Study Logs (permanent, only deleted on explicit user action) -->
      <div class="analytics-card" style="border-radius:0 0 16px 16px;">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;">
          <div class="analytics-title-lg" style="margin-bottom:0;">All Study Logs</div>
          <span style="font-family:'Bebas Neue',sans-serif;font-size:9px;color:#9ca3af;">üîó LINKED DELETE</span>
        </div>
        <div id="studyLogList"></div>
      </div>
    </div>
  </div>

  <!-- ===== SETTINGS PAGE (Tab 5) ===== -->
  <div class="page" id="page-settings">
    <div class="app-topbar"><div class="app-name">SETTINGS</div></div>
    <div class="settings-wrap">

      <div class="settings-card">
        <div class="settings-card-title">NOTIFICATIONS</div>
        <div class="setting-row">
          <div><div class="setting-label">Daily Reminders</div><div class="setting-sub">PUSH ALERTS</div></div>
          <div class="toggle" id="notifToggle" onclick="toggleNotifications()"></div>
        </div>
        <div id="reminderSection" style="display:none;margin-top:10px;">
          <div style="font-size:11px;color:var(--muted);font-family:'Bebas Neue',sans-serif;margin-bottom:6px;">REMINDER TIMES</div>
          <div class="reminder-tags" id="reminderTags"></div>
          <div class="reminder-add-row">
            <input type="time" id="newReminderTime" value="20:00">
            <button class="action-btn success" onclick="addReminder()">ADD</button>
          </div>
        </div>
      </div>

      <div class="settings-card">
        <div class="settings-card-title">MY QUOTES</div>
        <p style="font-size:11px;color:var(--muted);margin-bottom:10px;font-family:'Bebas Neue',sans-serif;">APPEAR IN JOURNAL DAILY INSPIRATION</p>
        <div style="display:flex;gap:8px;">
          <input type="text" class="quotes-input" id="quoteTextInput" placeholder="Enter your quote..." style="margin-bottom:0;flex:1;">
          <button class="quotes-add-btn" onclick="addCustomQuote()">ADD</button>
        </div>
        <div id="customQuotesList"></div>
      </div>

      <div class="settings-card">
        <div class="settings-card-title">DATA</div>
        <div class="setting-row">
          <div><div class="setting-label">Export Backup</div><div class="setting-sub">DOWNLOAD JSON</div></div>
          <button class="action-btn success" onclick="exportData()">EXPORT</button>
        </div>
        <div class="setting-row">
          <div><div class="setting-label">Import Backup</div><div class="setting-sub">RESTORE DATA</div></div>
          <button class="action-btn" onclick="document.getElementById('importFile').click()">IMPORT</button>
        </div>
        <input type="file" id="importFile" accept=".json" style="display:none" onchange="importData(event)">
        <div class="setting-row">
          <div><div class="setting-label">Reset Streak</div><div class="setting-sub">‚ö†Ô∏è IRREVERSIBLE</div></div>
          <button class="action-btn danger" onclick="resetStreak()">RESET</button>
        </div>
      </div>

      <div class="settings-card">
        <div class="settings-card-title">BADGE GIF URLS</div>
        <p style="font-size:11px;color:var(--muted);margin-bottom:12px;font-family:'Bebas Neue',sans-serif;">PASTE GIPHY / TENOR DIRECT GIF LINKS</p>
        <div id="gifSettings" style="max-height:320px;overflow-y:auto;"></div>
      </div>
    </div>
  </div>

  <!-- BOTTOM NAV -->
  <nav class="bottom-nav">
    <button class="nav-btn active" onclick="switchPage('badges',this)" id="nav-badges">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
      BADGES
    </button>
    <button class="nav-btn" onclick="switchPage('grid',this)" id="nav-grid">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
      CHECKIN
    </button>
    <button class="nav-btn" onclick="switchPage('journal',this)" id="nav-journal">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
      JOURNAL
    </button>
    <button class="nav-btn" onclick="switchPage('analytics',this)" id="nav-analytics">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
      ANALYTICS
    </button>
    <button class="nav-btn" onclick="switchPage('settings',this)" id="nav-settings">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/></svg>
      SETTINGS
    </button>
  </nav>
</div>

<!-- Study Log Modal -->
<div id="studyModal" class="modal-overlay" style="display:none;" onclick="if(event.target===this)closeStudyModal()">
  <div class="modal-sheet">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;">
      <div class="modal-title" style="margin-bottom:0;">üìö LOG STUDY SESSION</div>
      <button onclick="closeStudyModal()" style="background:none;border:none;font-size:22px;cursor:pointer;color:#6b7280;">√ó</button>
    </div>
    <div class="study-form">
      <label>SUBJECT</label>
      <input type="text" id="studySubject" placeholder="e.g. Math, Physics, English...">

      <!-- Hidden real time inputs (used by saveStudyLog) -->
      <input type="hidden" id="studyStartTime">
      <input type="hidden" id="studyEndTime">

      <!-- Custom time pickers row -->
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:14px;">
        <!-- START TIME -->
        <div>
          <div style="font-family:'Space Mono',monospace;font-size:10px;letter-spacing:2px;color:#6b7280;margin-bottom:8px;">START TIME</div>
          <div id="startTimePicker" class="tpicker" onclick="openTimePicker('start')" style="background:linear-gradient(135deg,#f0fdf4,#dcfce7);border:2px solid #86efac;border-radius:14px;padding:14px 12px;cursor:pointer;text-align:center;transition:all .2s;position:relative;">
            <div style="font-family:'Bebas Neue',sans-serif;font-size:28px;letter-spacing:2px;color:#14532d;line-height:1;" id="startTimeDisplay">--:--</div>
            <div style="font-family:'Space Mono',monospace;font-size:9px;color:#86efac;margin-top:3px;letter-spacing:1px;">TAP TO SET</div>
          </div>
        </div>
        <!-- END TIME -->
        <div>
          <div style="font-family:'Space Mono',monospace;font-size:10px;letter-spacing:2px;color:#6b7280;margin-bottom:8px;">END TIME</div>
          <div id="endTimePicker" class="tpicker" onclick="openTimePicker('end')" style="background:#f9fafb;border:2px solid #e5e7eb;border-radius:14px;padding:14px 12px;cursor:pointer;text-align:center;transition:all .2s;position:relative;">
            <div style="font-family:'Bebas Neue',sans-serif;font-size:28px;letter-spacing:2px;color:#9ca3af;line-height:1;" id="endTimeDisplay">--:--</div>
            <div style="font-family:'Space Mono',monospace;font-size:9px;color:#d1d5db;margin-top:3px;letter-spacing:1px;">TAP TO SET</div>
          </div>
        </div>
      </div>

      <div id="durationDisplay" style="margin-top:12px;min-height:20px;"></div>
      <div id="dailyGoalHint" style="min-height:16px;margin-top:2px;"></div>
      <label>JOURNAL / NOTES <span style="font-size:9px;color:#9ca3af;">(synced to Journal)</span></label>
      <textarea id="studyNotes" style="width:100%;min-height:70px;padding:10px;border:2px solid var(--border);border-radius:10px;font-family:'Nunito',sans-serif;font-size:13px;resize:none;outline:none;background:#f9fafb;" placeholder="What did you study? How did it feel?"></textarea>
      <button class="study-form-btn" onclick="saveStudyLog()">SAVE SESSION ‚úì</button>
    </div>
  </div>
</div>

<!-- ===== CUSTOM TIME PICKER SHEET ===== -->
<div id="timePickerSheet" style="display:none;position:fixed;inset:0;z-index:9999;background:rgba(0,0,0,.55);backdrop-filter:blur(4px);align-items:flex-end;justify-content:center;" onclick="if(event.target===this)closeTimePicker(false)">
  <div style="background:#fff;border-radius:28px 28px 0 0;padding:0 0 env(safe-area-inset-bottom,16px);width:100%;max-width:480px;box-shadow:0 -8px 40px rgba(0,0,0,.18);animation:ss-pop .3s cubic-bezier(.34,1.56,.64,1);">
    <!-- Header -->
    <div style="display:flex;align-items:center;justify-content:space-between;padding:20px 24px 12px;">
      <button onclick="closeTimePicker(false)" style="background:none;border:none;font-family:'Nunito',sans-serif;font-size:15px;font-weight:700;color:#9ca3af;cursor:pointer;padding:4px 8px;">Cancel</button>
      <div id="tpSheetLabel" style="font-family:'Bebas Neue',sans-serif;font-size:18px;letter-spacing:3px;color:#14532d;">START TIME</div>
      <button onclick="closeTimePicker(true)" style="background:linear-gradient(135deg,#22c55e,#16a34a);border:none;font-family:'Nunito',sans-serif;font-size:15px;font-weight:800;color:#fff;cursor:pointer;padding:6px 18px;border-radius:20px;">Done</button>
    </div>

    <!-- Live preview -->
    <div style="text-align:center;padding:4px 0 16px;border-bottom:1px solid #f0f0f0;">
      <span id="tpPreview" style="font-family:'Bebas Neue',sans-serif;font-size:52px;letter-spacing:4px;color:#14532d;line-height:1;">12:00</span>
      <span id="tpAmPmPreview" style="font-family:'Bebas Neue',sans-serif;font-size:24px;letter-spacing:2px;color:#86efac;margin-left:8px;">PM</span>
    </div>

    <!-- Scroll drums -->
    <div style="display:flex;align-items:center;justify-content:center;gap:0;padding:0 24px;position:relative;height:200px;overflow:hidden;">
      <!-- Highlight bar -->
      <div style="position:absolute;top:50%;left:24px;right:24px;transform:translateY(-50%);height:48px;background:linear-gradient(135deg,#f0fdf4,#dcfce7);border-radius:12px;border:2px solid #86efac;pointer-events:none;z-index:1;"></div>

      <!-- Hour drum -->
      <div style="flex:1;position:relative;z-index:2;">
        <div id="drumHour" class="tp-drum" style="height:200px;overflow-y:scroll;scroll-snap-type:y mandatory;-webkit-overflow-scrolling:touch;scrollbar-width:none;" onscroll="tpDrumScroll('hour')"></div>
      </div>

      <div style="font-family:'Bebas Neue',sans-serif;font-size:32px;color:#14532d;padding:0 6px;position:relative;z-index:2;margin-top:-4px;">:</div>

      <!-- Minute drum -->
      <div style="flex:1;position:relative;z-index:2;">
        <div id="drumMin" class="tp-drum" style="height:200px;overflow-y:scroll;scroll-snap-type:y mandatory;-webkit-overflow-scrolling:touch;scrollbar-width:none;" onscroll="tpDrumScroll('min')"></div>
      </div>

      <!-- AM/PM drum -->
      <div style="width:72px;position:relative;z-index:2;margin-left:8px;">
        <div id="drumAmPm" class="tp-drum" style="height:200px;overflow-y:scroll;scroll-snap-type:y mandatory;-webkit-overflow-scrolling:touch;scrollbar-width:none;" onscroll="tpDrumScroll('ampm')"></div>
      </div>
    </div>
    <div style="height:20px;"></div>
  </div>
</div>

<style>
.tp-drum::-webkit-scrollbar{display:none;}
.tp-drum-item{height:48px;display:flex;align-items:center;justify-content:center;scroll-snap-align:center;font-family:'Bebas Neue',sans-serif;font-size:26px;letter-spacing:2px;color:#9ca3af;transition:color .15s,font-size .15s;cursor:pointer;user-select:none;}
.tp-drum-item.selected{color:#14532d;font-size:28px;}
.tp-drum-spacer{height:76px;flex-shrink:0;}
</style>

<!-- Broken Chain Modal -->
<div id="brokenChainModal" class="broken-overlay" style="display:none;">
  <div class="broken-card">
    <div class="broken-chain-icon">üíî</div>
    <div class="broken-title">CHAIN BROKEN</div>
    <div class="broken-streak-lost" id="brokenStreakNum">0</div>
    <div class="broken-streak-label">DAYS LOST</div>
    <div class="broken-missed-date" id="brokenMissedDate">‚Äî</div>
    <div style="font-family:'Space Mono',monospace;font-size:10px;color:#86efac;margin:10px 0 4px;text-align:center;letter-spacing:1px;">üèÜ Your study hours are safe</div>
    <div style="font-family:'Space Mono',monospace;font-size:9px;color:rgba(134,239,172,.7);text-align:center;margin-bottom:12px;">Hours never reset ‚Äî only the streak did.</div>
    <button class="broken-cta" onclick="closeBrokenModal()">START AGAIN ‚Äî DAY 1</button>
    <button class="broken-history-btn" onclick="closeBrokenModal();switchPage('journal',document.getElementById('nav-journal'))">VIEW IN JOURNAL ¬∑ ADD REASON ‚Üí</button>
  </div>
</div>

<script>
// ===== STORAGE =====
const K={STREAK:'ch_streak',LAST:'ch_last',DATES:'ch_dates',JOURNAL:'ch_journal',GIFS:'ch_gifs',CQUOTES:'ch_cquotes',NOTIF:'ch_notif',RTIMES:'ch_rtimes',REVEALED:'ch_revealed',STUDYLOGS:'ch_studylogs',BREAKS:'ch_breaks',TOTALMINS:'ch_totalmins'};
const sv=(k,v)=>{try{localStorage.setItem(k,JSON.stringify(v));}catch(e){}};
const ld=(k,d)=>{try{const v=localStorage.getItem(k);return v!==null?JSON.parse(v):d;}catch(e){return d;}};

// ===== INDEXEDDB BACKUP LAYER =====
// IDB acts as a secondary backup so data survives even if localStorage is cleared
let idb=null;
const IDB_NAME='chain_backup',IDB_STORE='kv',IDB_VER=1;
function openIDB(){
  return new Promise((res,rej)=>{
    const req=indexedDB.open(IDB_NAME,IDB_VER);
    req.onupgradeneeded=e=>{e.target.result.createObjectStore(IDB_STORE,{keyPath:'k'});};
    req.onsuccess=e=>{res(e.target.result);};
    req.onerror=()=>rej();
  });
}
async function idbSet(k,v){
  try{
    if(!idb)idb=await openIDB();
    const tx=idb.transaction(IDB_STORE,'readwrite');
    tx.objectStore(IDB_STORE).put({k,v:JSON.stringify(v)});
  }catch(e){}
}
async function idbGet(k,def){
  try{
    if(!idb)idb=await openIDB();
    return new Promise((res)=>{
      const tx=idb.transaction(IDB_STORE,'readonly');
      const req=tx.objectStore(IDB_STORE).get(k);
      req.onsuccess=()=>{
        if(req.result)res(JSON.parse(req.result.v));
        else res(def);
      };
      req.onerror=()=>res(def);
    });
  }catch(e){return def;}
}
// On load, if localStorage is empty but IDB has data, restore from IDB
async function restoreFromIDBIfNeeded(){
  const lsEmpty=!localStorage.getItem(K.STREAK)&&!localStorage.getItem(K.STUDYLOGS);
  if(!lsEmpty)return;
  const keys=Object.values(K);
  for(const k of keys){
    const v=await idbGet(k,null);
    if(v!==null){try{localStorage.setItem(k,JSON.stringify(v));}catch(e){}}
  }
}
// Sync ALL data to IDB whenever we save (call this after any sv() block)
function syncToIDB(){
  Object.values(K).forEach(k=>{
    const v=ld(k,null);
    if(v!==null)idbSet(k,v);
  });
}

const LAST_EXPORT_KEY='ch_last_export';
function checkExportReminder(){
  const last=localStorage.getItem(LAST_EXPORT_KEY);
  if(!last)return; // never exported, no reminder until they export once
  const daysSince=Math.floor((Date.now()-Number(last))/(1000*60*60*24));
  if(daysSince>=7&&S.studylogs.length>0){
    setTimeout(()=>{
      showToast('üíæ Reminder: Back up your data! (Settings ‚Üí Export)');
    },4000);
  }
}
function markExported(){localStorage.setItem(LAST_EXPORT_KEY,String(Date.now()));}

// ===== STATE =====
let S={
  streak:ld(K.STREAK,0), last:ld(K.LAST,null), dates:ld(K.DATES,[]),
  journal:ld(K.JOURNAL,[]), gifs:ld(K.GIFS,{}), cquotes:ld(K.CQUOTES,[]),
  notif:ld(K.NOTIF,false), rtimes:ld(K.RTIMES,['15:00','20:00','22:00']),
  revealed:ld(K.REVEALED,{}), studylogs:ld(K.STUDYLOGS,[]),
  breaks:ld(K.BREAKS,[]),
  totalMins:ld(K.TOTALMINS,0), // PERMANENT ‚Äî never resets, only grows
};

// ===== BUILT-IN MOTIVATIONAL QUOTES ‚Äî Bilingual (Hindi + English) =====
const BUILTIN_QUOTES = [
  // OSHO
  {text:"Be ‚Äî don't try to become.", source:"Osho", lang:"en"},
  {text:"Drop the idea of becoming someone, because you are already a masterpiece. You cannot be improved upon.", source:"Osho", lang:"en"},
  {text:"If you love a flower, don't pick it up. Because if you pick it up it dies and it ceases to be what you love.", source:"Osho", lang:"en"},
  {text:"The real question is not whether life exists after death. The real question is whether you are alive before death.", source:"Osho", lang:"en"},
  {text:"Creativity is the greatest rebellion in existence.", source:"Osho", lang:"en"},
  {text:"‡§ú‡•Ä‡§ì ‡§™‡•Ç‡§∞‡•Ä ‡§§‡§∞‡§π ‚Äî ‡§Ö‡§ß‡•Ç‡§∞‡•á ‡§ú‡•Ä‡§µ‡§® ‡§∏‡•á ‡§¨‡•á‡§π‡§§‡§∞ ‡§π‡•à ‡§™‡•Ç‡§∞‡•Ä ‡§§‡§∞‡§π ‡§ú‡•Ä‡§®‡§æ‡•§", source:"Osho", lang:"hi"},
  {text:"‡§ß‡•ç‡§Ø‡§æ‡§® ‡§µ‡§π ‡§ï‡§≤‡§æ ‡§π‡•à ‡§ú‡•ã ‡§§‡•Å‡§Æ‡•ç‡§π‡•á‡§Ç ‡§µ‡§∞‡•ç‡§§‡§Æ‡§æ‡§® ‡§Æ‡•á‡§Ç ‡§≤‡§æ‡§§‡•Ä ‡§π‡•à ‚Äî ‡§î‡§∞ ‡§µ‡§∞‡•ç‡§§‡§Æ‡§æ‡§® ‡§π‡•Ä ‡§è‡§ï‡§Æ‡§æ‡§§‡•ç‡§∞ ‡§∏‡§§‡•ç‡§Ø ‡§π‡•à‡•§", source:"Osho", lang:"hi"},

  // RUMI
  {text:"Don't grieve. Anything you lose comes round in another form.", source:"Rumi", lang:"en"},
  {text:"Yesterday I was clever, so I wanted to change the world. Today I am wise, so I am changing myself.", source:"Rumi", lang:"en"},
  {text:"Silence is the language of God, all else is poor translation.", source:"Rumi", lang:"en"},
  {text:"‡§ú‡•ã ‡§§‡•Å‡§Æ ‡§¢‡•Ç‡§Ç‡§¢ ‡§∞‡§π‡•á ‡§π‡•ã, ‡§µ‡§π ‡§§‡•Å‡§Æ‡•ç‡§π‡•á‡§Ç ‡§π‡•Ä ‡§¢‡•Ç‡§Ç‡§¢ ‡§∞‡§π‡§æ ‡§π‡•à‡•§", source:"Rumi", lang:"hi"},

  // MARCUS AURELIUS
  {text:"You have power over your mind ‚Äî not outside events. Realize this and you will find strength.", source:"Marcus Aurelius", lang:"en"},
  {text:"Waste no more time arguing about what a good man should be. Be one.", source:"Marcus Aurelius", lang:"en"},
  {text:"The impediment to action advances action. What stands in the way becomes the way.", source:"Marcus Aurelius", lang:"en"},

  // STOIC / EPICTETUS
  {text:"It's not what happens to you, but how you react to it that matters.", source:"Epictetus", lang:"en"},
  {text:"Man is not disturbed by events, but by the opinions he has about events.", source:"Epictetus", lang:"en"},

  // NIETZSCHE
  {text:"He who has a why to live can bear almost any how.", source:"Nietzsche", lang:"en"},
  {text:"The higher we soar, the smaller we appear to those who cannot fly.", source:"Nietzsche", lang:"en"},
  {text:"That which does not kill us makes us stronger.", source:"Nietzsche", lang:"en"},

  // DOSTOEVSKY
  {text:"Pain and suffering are always inevitable for a large intelligence and a deep heart.", source:"Dostoevsky", lang:"en"},
  {text:"To love someone means to see them as God intended them.", source:"Dostoevsky", lang:"en"},

  // BUDDHA / EASTERN WISDOM
  {text:"The mind is everything. What you think you become.", source:"Buddha", lang:"en"},
  {text:"Peace comes from within. Do not seek it without.", source:"Buddha", lang:"en"},
  {text:"‡§§‡•Å‡§Æ‡•ç‡§π‡§æ‡§∞‡§æ ‡§∏‡§¨‡§∏‡•á ‡§¨‡§°‡§º‡§æ ‡§∂‡§§‡•ç‡§∞‡•Å ‡§§‡•Å‡§Æ‡•ç‡§π‡§æ‡§∞‡•Ä ‡§Ö‡§™‡§®‡•Ä ‡§Ö‡§ú‡•ç‡§û‡§æ‡§®‡§§‡§æ ‡§π‡•à‡•§", source:"Buddha", lang:"hi"},
  {text:"Three things cannot be long hidden: the sun, the moon, and the truth.", source:"Buddha", lang:"en"},

  // CHANAKYA
  {text:"Before you start some work, always ask yourself three questions ‚Äî why am I doing it, what the results might be and will I be successful?", source:"Chanakya", lang:"en"},
  {text:"‡§∂‡§ø‡§ï‡•ç‡§∑‡§æ ‡§∏‡§¨‡§∏‡•á ‡§Ö‡§ö‡•ç‡§õ‡•Ä ‡§Æ‡§ø‡§§‡•ç‡§∞ ‡§π‡•à‡•§ ‡§∂‡§ø‡§ï‡•ç‡§∑‡§ø‡§§ ‡§µ‡•ç‡§Ø‡§ï‡•ç‡§§‡§ø ‡§π‡§∞ ‡§ú‡§ó‡§π ‡§∏‡§Æ‡•ç‡§Æ‡§æ‡§® ‡§™‡§æ‡§§‡§æ ‡§π‡•à‡•§", source:"Chanakya", lang:"hi"},
  {text:"‡§®‡•Ä‡§§‡§ø ‡§ï‡•á ‡§¨‡§ø‡§®‡§æ ‡§ï‡•ã‡§à ‡§≠‡•Ä ‡§∞‡§æ‡§ú‡•ç‡§Ø ‡§ü‡§ø‡§ï ‡§®‡§π‡•Ä‡§Ç ‡§∏‡§ï‡§§‡§æ ‚Äî ‡§î‡§∞ ‡§¨‡§ø‡§®‡§æ ‡§Ö‡§®‡•Å‡§∂‡§æ‡§∏‡§® ‡§ï‡•á ‡§ï‡•ã‡§à ‡§≠‡•Ä ‡§ú‡•Ä‡§µ‡§®‡•§", source:"Chanakya", lang:"hi"},

  // SWAMI VIVEKANANDA
  {text:"Arise, awake and stop not until the goal is reached.", source:"Vivekananda", lang:"en"},
  {text:"You cannot believe in God until you believe in yourself.", source:"Vivekananda", lang:"en"},
  {text:"Take risks in your life. If you win, you can lead. If you lose, you can guide.", source:"Vivekananda", lang:"en"},
  {text:"‡§â‡§†‡•ã, ‡§ú‡§æ‡§ó‡•ã ‡§î‡§∞ ‡§§‡§¨ ‡§§‡§ï ‡§Æ‡§§ ‡§∞‡•Å‡§ï‡•ã ‡§ú‡§¨ ‡§§‡§ï ‡§≤‡§ï‡•ç‡§∑‡•ç‡§Ø ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§® ‡§π‡•ã ‡§ú‡§æ‡§è‡•§", source:"Vivekananda", lang:"hi"},
  {text:"‡§ú‡•ã ‡§Ö‡§ó‡•ç‡§®‡§ø ‡§π‡§Æ‡•á‡§Ç ‡§ó‡§∞‡•ç‡§Æ‡•Ä ‡§¶‡•á‡§§‡•Ä ‡§π‡•à, ‡§µ‡§π ‡§π‡§Æ‡•á‡§Ç ‡§®‡§∑‡•ç‡§ü ‡§≠‡•Ä ‡§ï‡§∞ ‡§∏‡§ï‡§§‡•Ä ‡§π‡•à ‚Äî ‡§Ø‡§π ‡§Ö‡§ó‡•ç‡§®‡§ø ‡§ï‡•Ä ‡§¶‡•ã‡§∑ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§", source:"Vivekananda", lang:"hi"},

  // ALBERT CAMUS
  {text:"In the midst of winter, I found there was, within me, an invincible summer.", source:"Albert Camus", lang:"en"},
  {text:"You will never be happy if you continue to search for what happiness consists of.", source:"Albert Camus", lang:"en"},

  // VIKTOR FRANKL
  {text:"When we are no longer able to change a situation, we are challenged to change ourselves.", source:"Viktor Frankl", lang:"en"},
  {text:"Everything can be taken from a man but one thing: the last of the human freedoms ‚Äî to choose one's attitude.", source:"Viktor Frankl", lang:"en"},

  // CARL JUNG
  {text:"Who looks outside, dreams; who looks inside, awakes.", source:"Carl Jung", lang:"en"},
  {text:"You are not what happened to you. You are what you choose to become.", source:"Carl Jung", lang:"en"},

  // INTERNET / VIRAL WISDOM ‚Äî Hindi
  {text:"‡§Æ‡•á‡§π‡§®‡§§ ‡§á‡§§‡§®‡•Ä ‡§ñ‡§æ‡§Æ‡•ã‡§∂‡•Ä ‡§∏‡•á ‡§ï‡§∞‡•ã ‡§ï‡§ø ‡§∏‡§´‡§≤‡§§‡§æ ‡§∂‡•ã‡§∞ ‡§Æ‡§ö‡§æ ‡§¶‡•á‡•§", source:"Wisdom", lang:"hi"},
  {text:"‡§ú‡§¨ ‡§§‡§ï ‡§§‡•ã‡§°‡§º‡•ã‡§ó‡•á ‡§®‡§π‡•Ä‡§Ç ‡§ñ‡•Å‡§¶ ‡§ï‡•ã, ‡§§‡§¨ ‡§§‡§ï ‡§¨‡§® ‡§®‡§π‡•Ä‡§Ç ‡§∏‡§ï‡§§‡•á ‡§ï‡•Å‡§õ ‡§®‡§Ø‡§æ‡•§", source:"Wisdom", lang:"hi"},
  {text:"‡§ï‡§≤ ‡§ï‡§æ ‡§¨‡•á‡§π‡§§‡§∞ ‡§¨‡§®‡§®‡§æ ‡§Ü‡§ú ‡§ï‡•Ä ‡§õ‡•ã‡§ü‡•Ä ‡§∏‡•Ä ‡§ï‡•ã‡§∂‡§ø‡§∂ ‡§∏‡•á ‡§∂‡•Å‡§∞‡•Ç ‡§π‡•ã‡§§‡§æ ‡§π‡•à‡•§", source:"Wisdom", lang:"hi"},
  {text:"‡§¶‡§∞‡•ç‡§¶ ‡§§‡§¨ ‡§§‡§ï ‡§π‡•à ‡§ú‡§¨ ‡§§‡§ï ‡§≤‡§ï‡•ç‡§∑‡•ç‡§Ø ‡§®‡§π‡•Ä‡§Ç ‚Äî ‡§≤‡§ï‡•ç‡§∑‡•ç‡§Ø ‡§Æ‡§ø‡§≤‡§æ ‡§§‡•ã ‡§¶‡§∞‡•ç‡§¶ ‡§ï‡§π‡§æ‡§®‡•Ä ‡§¨‡§® ‡§ú‡§æ‡§§‡§æ ‡§π‡•à‡•§", source:"Wisdom", lang:"hi"},
  {text:"‡§ú‡•ã ‡§≤‡•ã‡§ó ‡§∞‡§æ‡§§ ‡§ï‡•ã ‡§∏‡•ã‡§®‡•á ‡§∏‡•á ‡§™‡§π‡§≤‡•á ‡§•‡§ï‡•á ‡§π‡•ã‡§§‡•á ‡§π‡•à‡§Ç ‚Äî ‡§µ‡§π‡•Ä ‡§≤‡•ã‡§ó ‡§∏‡•Å‡§¨‡§π ‡§â‡§†‡§ï‡§∞ ‡§ú‡•Ä‡§§‡§§‡•á ‡§π‡•à‡§Ç‡•§", source:"Wisdom", lang:"hi"},
  {text:"‡§π‡§∞ ‡§Æ‡§π‡§æ‡§® ‡§Ø‡§æ‡§§‡•ç‡§∞‡§æ ‡§è‡§ï ‡§õ‡•ã‡§ü‡•á ‡§∏‡•á ‡§ï‡§¶‡§Æ ‡§∏‡•á ‡§∂‡•Å‡§∞‡•Ç ‡§π‡•ã‡§§‡•Ä ‡§π‡•à ‚Äî ‡§Ø‡§π‡•Ä ‡§ï‡§¶‡§Æ ‡§â‡§†‡§æ‡§ì ‡§Ü‡§ú‡•§", source:"Wisdom", lang:"hi"},

  // INTERNET / VIRAL WISDOM ‚Äî English
  {text:"Work in silence. Let your success make the noise.", source:"Wisdom", lang:"en"},
  {text:"One day or day one. You decide.", source:"Wisdom", lang:"en"},
  {text:"Your future self is watching you right now through your memories.", source:"Wisdom", lang:"en"},
  {text:"Stop being afraid of what could go wrong and start being excited about what could go right.", source:"Wisdom", lang:"en"},
  {text:"The version of you that exists five years from now is shaped entirely by the actions you take today.", source:"Wisdom", lang:"en"},
  {text:"Hard days build hard people. You are being forged right now.", source:"Wisdom", lang:"en"},
  {text:"Discipline is choosing between what you want now and what you want most.", source:"Abraham Lincoln", lang:"en"},
  {text:"The only impossible journey is the one you never begin.", source:"Tony Robbins", lang:"en"},

  // ARISTOTLE / PLATO
  {text:"We are what we repeatedly do. Excellence, then, is not an act, but a habit.", source:"Aristotle", lang:"en"},
  {text:"The secret of change is to focus all your energy, not on fighting the old, but on building the new.", source:"Socrates", lang:"en"},

  // APJ ABDUL KALAM
  {text:"Dream is not that which you see while sleeping. It is something that does not let you sleep.", source:"APJ Abdul Kalam", lang:"en"},
  {text:"‡§∏‡§™‡§®‡•á ‡§µ‡•ã ‡§®‡§π‡•Ä‡§Ç ‡§ú‡•ã ‡§®‡•Ä‡§Ç‡§¶ ‡§Æ‡•á‡§Ç ‡§Ü‡§§‡•á ‡§π‡•à‡§Ç ‚Äî ‡§∏‡§™‡§®‡•á ‡§µ‡•ã ‡§π‡•à‡§Ç ‡§ú‡•ã ‡§®‡•Ä‡§Ç‡§¶ ‡§â‡§°‡§º‡§æ ‡§¶‡•á‡§Ç‡•§", source:"APJ Abdul Kalam", lang:"hi"},
  {text:"‡§§‡•Å‡§Æ ‡§Ö‡§™‡§®‡•Ä ‡§Æ‡§Ç‡§ú‡§ø‡§≤ ‡§™‡§æ‡§ì‡§ó‡•á, ‡§ï‡•ç‡§Ø‡•ã‡§Ç‡§ï‡§ø ‡§§‡•Å‡§Æ‡§®‡•á ‡§â‡§∏ ‡§Æ‡§Ç‡§ú‡§ø‡§≤ ‡§ï‡•ã ‡§¶‡•á‡§ñ‡§®‡•á ‡§ï‡•Ä ‡§π‡§ø‡§Æ‡•ç‡§Æ‡§§ ‡§ï‡•Ä‡•§", source:"APJ Abdul Kalam", lang:"hi"},
];
let curQuoteIdx = Math.floor(Math.random()*BUILTIN_QUOTES.length);

function getAllQuotes(){
  const custom = S.cquotes.map(q=>({text:q.text, source:'YOU', lang:'en'}));
  // Interleave custom quotes at higher frequency: every 3rd slot is a custom quote if available
  if(!custom.length) return BUILTIN_QUOTES;
  const result=[];
  let bi=0, ci=0;
  while(bi<BUILTIN_QUOTES.length || ci<custom.length){
    if(ci<custom.length && (result.length%3===2 || bi>=BUILTIN_QUOTES.length)){
      result.push(custom[ci%custom.length]); ci++;
    } else if(bi<BUILTIN_QUOTES.length){
      result.push(BUILTIN_QUOTES[bi]); bi++;
    }
  }
  return result;
}
function _setQuoteUI(q, animate){
  const el=document.getElementById('quoteText');
  if(animate){
    el.classList.remove('fade-in');
    void el.offsetWidth; // reflow
    el.classList.add('fade-in');
  }
  el.textContent=q.text;
  el.className='quote-text fade-in'+(q.lang==='hi'?' hindi':'');
}
function showNewQuote(){
  const all=getAllQuotes();
  curQuoteIdx=(curQuoteIdx+1)%all.length;
  _setQuoteUI(all[curQuoteIdx], true);
}
function renderDailyQuote(){
  const all=getAllQuotes();
  _setQuoteUI(all[curQuoteIdx%all.length], false);
}

// ===== BADGES =====
const BADGES=[
  {day:0,  name:'BELIEVER',      emoji:'üå±',desc:'Start of the journey'},
  {day:1,  name:'KID',           emoji:'üë∂',desc:'First day done!'},
  {day:2,  name:'COOL KID',      emoji:'üòé',desc:'Two days in'},
  {day:3,  name:'NEWBIE',        emoji:'üéØ',desc:'Three days strong'},
  {day:4,  name:'BEGINNER',      emoji:'üî•',desc:'Building habits'},
  {day:5,  name:'RECRUIT',       emoji:'‚ö°',desc:'Almost a week'},
  {day:6,  name:'MEMBER',        emoji:'üí™',desc:'Six days committed'},
  {day:7,  name:'WEEK WARRIOR',  emoji:'üèÜ',desc:'One full week!'},
  {day:8,  name:'ELITE MEMBER',  emoji:'ü¶Å',desc:'Elite status'},
  {day:9,  name:'SUPE',          emoji:'ü¶∏',desc:'Superhuman effort'},
  {day:10, name:'CAPTAIN',       emoji:'‚öì',desc:'Captain of destiny'},
  {day:11, name:'PERFECTIONIST', emoji:'üíé',desc:'Flawless streak'},
  {day:12, name:'SUPER SAIYAN',  emoji:'‚ö°',desc:'Power level rising'},
  {day:13, name:'INVINCIBLE',    emoji:'üõ°Ô∏è',desc:'Nothing stops you'},
  {day:14, name:'URGE SMASHER',  emoji:'üî®',desc:'Two full weeks!'},
  {day:15, name:'BADASS',        emoji:'üí•',desc:'15 days discipline'},
  {day:16, name:'WOLF',          emoji:'üê∫',desc:'Pack leader mentality'},
  {day:17, name:'LONE WOLF',     emoji:'üåï',desc:'Solo discipline king'},
  {day:18, name:'ALPHA',         emoji:'ü¶Ö',desc:'Alpha mindset unlocked'},
  {day:19, name:'PREDATOR',      emoji:'üêÜ',desc:'Relentless pursuit'},
  {day:20, name:'HUNTER',        emoji:'üèπ',desc:'On the hunt daily'},
  {day:21, name:'TITAN',         emoji:'‚öîÔ∏è',desc:'Three weeks done!'},
  {day:22, name:'BADASS MASTER', emoji:'üî±',desc:'Mastery begins here'},
  {day:30, name:'MONK',          emoji:'üßò',desc:'One full month!'},
  {day:31, name:'CHAMP',         emoji:'ü•á',desc:'Champion mindset'},
  {day:45, name:'IRON WILL',     emoji:'‚öôÔ∏è',desc:'Unbreakable will'},
  {day:46, name:'CONQUEROR',     emoji:'üè∞',desc:'Conquering fears'},
  {day:60, name:'GLADIATOR',     emoji:'üèõÔ∏è',desc:'Two months strong'},
  {day:66, name:'LEGEND',        emoji:'üåü',desc:'Legendary discipline'},
  {day:90, name:'IMMORTAL',      emoji:'üîÆ',desc:'90 days ‚Äî pure gold'},
  {day:91, name:'SENSEI',        emoji:'ü•ã',desc:'Teaching by example'},
  {day:120,name:'DEMIGOD',       emoji:'‚ö°',desc:'Beyond human limits'},
  {day:121,name:'KING',          emoji:'üëë',desc:'King of discipline'},
  {day:150,name:'GOD MODE',      emoji:'üåå',desc:'Operating in god mode'},
  {day:180,name:'HALF YEAR',     emoji:'üìÖ',desc:'Six months of glory'},
  {day:200,name:'OVERLORD',      emoji:'üåê',desc:'Overlord status'},
  {day:201,name:'KRATOS',        emoji:'‚öîÔ∏è',desc:'God of War energy'},
  {day:300,name:'MATRIX ESCAPEE',emoji:'üï¥Ô∏è',desc:'Escaped the matrix'},
  {day:365,name:'ONE YEAR KING', emoji:'üéñÔ∏è',desc:'One year. Respect.'},
];

function getCurBadge(){let b=BADGES[0];for(let x of BADGES){if(S.streak>=x.day)b=x;else break;}return b;}
function getNextBadge(){for(let x of BADGES){if(x.day>S.streak)return x;}return null;}

// ===== PROGRESS ‚Äî NEW LOGIC: progress is FROM prevBadge baseline =====
// The idea: once you hit badge X (e.g. day 7), you "own" those 7 days.
// Progress shows how far you've gone from X toward next badge Y.
// BUT we start the fill at e.g. 10% (visual motivator that you've already "owned" the prev badge).
// This is the "already completed = fills faster" pattern.
function getProgress(){
  const cur=getCurBadge(), nxt=getNextBadge();
  if(!nxt)return{pct:100,target:'MAX',prev:cur.day,curDay:cur.day,nextDay:null};
  const nextDay=nxt.day;
  // Logic: percentage = (current streak / next target) * 100
  // So if streak=1, target=2 ‚Üí 1/2 * 100 = 50% COMPLETED
  const pct=nextDay>0?Math.min(100,(S.streak/nextDay)*100):100;
  return{pct,target:nextDay,prev:cur.day,curDay:cur.day,nextDay};
}

function updateProgressUI(){
  const{pct,target}=getProgress();
  document.getElementById('progressDaysRow').textContent='CURRENT DAYS: '+S.streak;
  document.getElementById('progressTarget').textContent=target==='MAX'?'MAX ACHIEVED':target+' DAYS';
  document.getElementById('progressFill').style.width=pct.toFixed(1)+'%';
  document.getElementById('progressPct').textContent=pct.toFixed(1)+'% COMPLETED';
}

// ===== HERO GIF REVEAL =====
let heroRevealed=false;
function toggleHeroReveal(){
  const cur=getCurBadge();
  if(!S.gifs[cur.day])return;
  heroRevealed=!heroRevealed;
  renderHeroGif();
}
function renderHeroGif(){
  const cur=getCurBadge();
  const area=document.getElementById('heroBadgeGif');
  if(S.gifs[cur.day]){
    if(heroRevealed){
      area.innerHTML='<img src="'+S.gifs[cur.day]+'" alt="'+cur.name+'">';
    } else {
      area.innerHTML='<div class="badge-gif-tap">Tap to Play</div>';
    }
  } else {
    area.innerHTML='<div class="badge-gif-tap">No GIF ‚Äî add one in Settings</div>';
  }
}

// ===== RENDER BADGES LIST =====
function renderBadges(){
  const list=document.getElementById('badgesList');
  list.innerHTML='';
  const cur=getCurBadge();

  BADGES.forEach(badge=>{
    const isPast=S.streak>badge.day;
    const isCurrent=badge.day===cur.day;
    const isFuture=badge.day>S.streak;

    const card=document.createElement('div');
    const state=isCurrent?'state-current':isPast?'state-past':'state-future';
    card.className='badge-card '+state;

    const left=document.createElement('div');
    left.className='bc-left';
    const dayLabel=isFuture?'UNLOCKS ON DAY '+badge.day:(isCurrent?'‚ñ∂ CURRENT ¬∑ DAY '+badge.day:'‚úì DAY '+badge.day);
    left.innerHTML=`<div class="bc-day">${dayLabel}</div><div class="bc-left-text">${badge.emoji} ${badge.name}</div>`;
    card.appendChild(left);

    const right=document.createElement('div');
    right.className='bc-right';
    const gifUrl=S.gifs[badge.day];
    const isRevealed=S.revealed[badge.day];

    if(isFuture){
      right.innerHTML='<div class="bc-right-locked">üîí</div>';
    } else if(gifUrl){
      if(isRevealed){
        right.innerHTML='<img src="'+gifUrl+'" alt="'+badge.name+'">';
        right.style.cursor='pointer';
        right.onclick=()=>toggleBadgeReveal(badge.day);
      } else {
        right.innerHTML='<div class="bc-right-tap" onclick="toggleBadgeReveal('+badge.day+')">Tap to Play</div>';
      }
    } else {
      right.innerHTML='<div class="bc-right-locked" style="font-size:13px;color:#6b7280;">No GIF</div>';
    }
    card.appendChild(right);
    list.appendChild(card);
  });
}

function toggleBadgeReveal(day){
  S.revealed[day]=!S.revealed[day];
  sv(K.REVEALED,S.revealed);
  renderBadges();
}

function updateHero(){
  const cur=getCurBadge();
  // Big streak display
  document.getElementById('streakNumBig').textContent=S.streak;
  document.getElementById('streakBadgeHero').textContent=cur.emoji+' '+cur.name;
  heroRevealed=false;
  renderHeroGif();
  renderTodayStudyStatus();
}

function renderTodayStudyStatus(){
  let el=document.getElementById('todayStudyStatus');
  if(!el) return;
  el.style.display='block';

  const todayMins=getTodayLoggedMins();
  const totalH=Math.floor((S.totalMins||0)/60);
  const totalM=(S.totalMins||0)%60;
  const allTimeStr=`${totalH}h${totalM>0?totalM+'m':''} studied`;
  const pct=Math.min(100,Math.round((todayMins/DAILY_GOAL_MINS)*100));
  const dh=Math.floor(todayMins/60),dm=todayMins%60;
  const rem=Math.max(0,DAILY_GOAL_MINS-todayMins);
  const rh=Math.floor(rem/60),rmm=rem%60;
  const todayStr=dh>0?`${dh}h${dm>0?dm+'m':''}`:`${dm}m`;
  const remStr=rh>0?`${rh}h${rmm>0?rmm+'m':''}`:`${rmm}m`;

  // inject keyframes once
  if(!document.getElementById('ssk')){
    const s=document.createElement('style');s.id='ssk';
    s.textContent=`
      @keyframes ss-shimmer{0%{background-position:-200% center}100%{background-position:200% center}}
      @keyframes ss-pulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.85;transform:scale(1.015)}}
      @keyframes ss-bar{from{width:0%}to{width:var(--bar-w)}}
      @keyframes ss-pop{0%{transform:scale(.92);opacity:0}70%{transform:scale(1.03)}100%{transform:scale(1);opacity:1}}
      @keyframes ss-glow{0%,100%{box-shadow:0 0 18px var(--glow-c)}50%{box-shadow:0 0 36px var(--glow-c),0 0 60px var(--glow-c)}}
      @keyframes ss-dots{0%,80%,100%{opacity:0;transform:scale(.6)}40%{opacity:1;transform:scale(1)}}
      @keyframes ss-confetti-fall{0%{transform:translateY(-10px) rotate(0deg);opacity:1}100%{transform:translateY(60px) rotate(720deg);opacity:0}}
    `;
    document.head.appendChild(s);
  }

  let html='';

  if(todayMins===0){
    // STATE 0 ‚Äî COLD START: Deep navy-to-forest, electric lime accent, pulsing CTA energy
    el.style.cssText=`margin:16px -16px -18px;display:block;background:linear-gradient(160deg,#0a1628 0%,#0d2b14 60%,#0f3d1e 100%);padding:18px 20px 20px;position:relative;overflow:hidden;`;
    html=`
      <div style="position:absolute;inset:0;background:radial-gradient(ellipse at 80% 50%,rgba(74,222,128,.07) 0%,transparent 65%);pointer-events:none;"></div>
      <div style="position:absolute;top:-1px;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,rgba(74,222,128,.4),transparent);"></div>
      <div style="display:flex;align-items:center;gap:14px;position:relative;">
        <div style="flex-shrink:0;width:44px;height:44px;border-radius:14px;background:linear-gradient(135deg,#052e16,#14532d);border:1px solid rgba(74,222,128,.25);display:flex;align-items:center;justify-content:center;animation:ss-pulse 3s ease-in-out infinite;">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="10" stroke="#4ade80" stroke-width="1.5" opacity=".4"/><path d="M12 6v6l4 2" stroke="#4ade80" stroke-width="2" stroke-linecap="round"/></svg>
        </div>
        <div style="flex:1;min-width:0;">
          <div style="font-family:'Nunito',sans-serif;font-size:14px;font-weight:900;color:#f0fdf4;letter-spacing:.1px;line-height:1.3;">Today's session awaits</div>
          <div style="font-family:'Space Mono',monospace;font-size:9.5px;color:#4ade80;opacity:.7;margin-top:3px;letter-spacing:1.5px;">4H BUILDS THE CHAIN ¬∑ ${totalH>0?allTimeStr.toUpperCase()+' TOTAL':'START YOUR LEGACY'}</div>
        </div>
        <div style="flex-shrink:0;background:linear-gradient(135deg,#16a34a,#15803d);border-radius:10px;padding:7px 13px;box-shadow:0 4px 16px rgba(34,197,94,.35);">
          <div style="font-family:'Bebas Neue',sans-serif;font-size:14px;letter-spacing:2px;color:#fff;">GO</div>
        </div>
      </div>
      <div style="margin-top:14px;height:4px;background:rgba(255,255,255,.06);border-radius:4px;overflow:hidden;">
        <div style="width:2px;height:100%;background:rgba(74,222,128,.3);border-radius:4px;"></div>
      </div>
      <div style="display:flex;justify-content:space-between;margin-top:7px;">
        <span style="font-family:'Space Mono',monospace;font-size:8px;color:rgba(134,239,172,.45);letter-spacing:1px;">0H</span>
        <span style="font-family:'Space Mono',monospace;font-size:8px;color:rgba(134,239,172,.45);letter-spacing:1px;">2H</span>
        <span style="font-family:'Space Mono',monospace;font-size:8px;color:rgba(134,239,172,.45);letter-spacing:1px;">4H STREAK</span>
      </div>`;

  } else if(todayMins>=DAILY_GOAL_MINS){
    // STATE 2 ‚Äî COMPLETE: Gold victory, confetti dots, pure celebration
    const confettiColors=['#fbbf24','#4ade80','#38bdf8','#f472b6','#a78bfa'];
    let confetti='';
    for(let i=0;i<8;i++){
      const c=confettiColors[i%confettiColors.length];
      const left=10+i*11;
      const delay=(i*0.15).toFixed(2);
      const dur=(1.2+Math.random()*0.8).toFixed(2);
      confetti+=`<div style="position:absolute;top:0;left:${left}%;width:5px;height:5px;border-radius:${i%2?'50%':'2px'};background:${c};animation:ss-confetti-fall ${dur}s ${delay}s ease-in infinite;opacity:0;"></div>`;
    }
    el.style.cssText=`margin:16px -16px -18px;display:block;background:linear-gradient(160deg,#1a0a00 0%,#1c1500 40%,#0d2b14 100%);padding:18px 20px 20px;position:relative;overflow:hidden;--glow-c:rgba(251,191,36,.25);animation:ss-glow 2.5s ease-in-out infinite;`;
    html=`
      <div style="position:absolute;inset:0;background:radial-gradient(ellipse at 20% 50%,rgba(251,191,36,.12) 0%,transparent 60%),radial-gradient(ellipse at 85% 30%,rgba(74,222,128,.08) 0%,transparent 50%);pointer-events:none;"></div>
      <div style="position:absolute;top:-1px;left:0;right:0;height:2px;background:linear-gradient(90deg,#fbbf24,#f59e0b,#4ade80,#fbbf24);background-size:200%;animation:ss-shimmer 2s linear infinite;"></div>
      <div style="position:absolute;top:0;left:0;right:0;height:50px;pointer-events:none;">${confetti}</div>
      <div style="display:flex;align-items:center;gap:14px;position:relative;animation:ss-pop .5s cubic-bezier(.34,1.56,.64,1) forwards;">
        <div style="flex-shrink:0;width:48px;height:48px;border-radius:14px;background:linear-gradient(135deg,#92400e,#b45309);border:1.5px solid rgba(251,191,36,.5);display:flex;align-items:center;justify-content:center;box-shadow:0 6px 24px rgba(251,191,36,.3);">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none"><path d="M12 2l2.4 7.4H22l-6.2 4.5 2.4 7.4L12 17l-6.2 4.3 2.4-7.4L2 9.4h7.6L12 2z" fill="#fbbf24" stroke="#f59e0b" stroke-width=".5"/></svg>
        </div>
        <div style="flex:1;min-width:0;">
          <div style="font-family:'Nunito',sans-serif;font-size:15px;font-weight:900;background:linear-gradient(90deg,#fde68a,#fbbf24,#fff);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;letter-spacing:.2px;line-height:1.2;">${todayStr} crushed. Chain lives!</div>
          <div style="font-family:'Space Mono',monospace;font-size:9px;color:#4ade80;opacity:.8;margin-top:4px;letter-spacing:1.5px;">ALL-TIME ¬∑ ${allTimeStr.toUpperCase()}</div>
        </div>
        <div style="flex-shrink:0;background:linear-gradient(135deg,#fbbf24,#f59e0b);border-radius:10px;padding:7px 12px;box-shadow:0 4px 18px rgba(251,191,36,.4);">
          <div style="font-family:'Bebas Neue',sans-serif;font-size:14px;letter-spacing:2px;color:#1c1400;">DONE</div>
        </div>
      </div>
      <div style="margin-top:14px;height:5px;background:rgba(255,255,255,.06);border-radius:4px;overflow:hidden;position:relative;">
        <div style="--bar-w:100%;width:100%;height:100%;background:linear-gradient(90deg,#fbbf24,#f59e0b,#4ade80);border-radius:4px;animation:ss-shimmer 2s linear infinite;background-size:200%;"></div>
      </div>
      <div style="margin-top:8px;text-align:center;">
        <span style="font-family:'Bebas Neue',sans-serif;font-size:10px;letter-spacing:3px;color:rgba(251,191,36,.6);">STREAK SECURED ¬∑ COME BACK TOMORROW</span>
      </div>`;

  } else {
    // STATE 1 ‚Äî IN PROGRESS: Electric urgency, warm amber-to-green gradient bar, real momentum
    const barW=pct;
    const isHot=pct>=75;
    const barGrad=isHot
      ?'linear-gradient(90deg,#f59e0b,#fbbf24,#4ade80)'
      :'linear-gradient(90deg,#f59e0b,#fbbf24)';
    const accentCol=isHot?'#86efac':'#fde68a';
    const glowCol=isHot?'rgba(74,222,128,.2)':'rgba(251,191,36,.2)';
    el.style.cssText=`margin:16px -16px -18px;display:block;background:linear-gradient(160deg,#0d1f0d 0%,#0f2d10 50%,#111f00 100%);padding:18px 20px 20px;position:relative;overflow:hidden;`;
    html=`
      <div style="position:absolute;inset:0;background:radial-gradient(ellipse at 60% 0%,${glowCol} 0%,transparent 55%);pointer-events:none;"></div>
      <div style="position:absolute;top:-1px;left:0;right:0;height:1.5px;background:linear-gradient(90deg,transparent,#fbbf24 40%,${isHot?'#4ade80':'#fbbf24'} 100%,transparent);"></div>
      <div style="display:flex;align-items:center;gap:14px;position:relative;">
        <div style="flex-shrink:0;position:relative;width:46px;height:46px;">
          <svg width="46" height="46" viewBox="0 0 46 46" style="transform:rotate(-90deg);">
            <circle cx="23" cy="23" r="19" fill="none" stroke="rgba(255,255,255,.07)" stroke-width="3.5"/>
            <circle cx="23" cy="23" r="19" fill="none" stroke="url(#rg)" stroke-width="3.5" stroke-linecap="round"
              stroke-dasharray="${Math.round(2*Math.PI*19)}"
              stroke-dashoffset="${Math.round(2*Math.PI*19*(1-pct/100))}"
              style="transition:stroke-dashoffset 1s ease;"/>
            <defs><linearGradient id="rg" x1="0%" y1="0%" x2="100%" y2="0%"><stop offset="0%" stop-color="#f59e0b"/><stop offset="100%" stop-color="${isHot?'#4ade80':'#fbbf24'}"/></linearGradient></defs>
          </svg>
          <div style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-family:'Bebas Neue',sans-serif;font-size:13px;color:#fff;letter-spacing:0;">${pct}%</div>
        </div>
        <div style="flex:1;min-width:0;">
          <div style="font-family:'Nunito',sans-serif;font-size:14px;font-weight:900;color:#fff;letter-spacing:.1px;line-height:1.3;">${isHot?'Almost there ‚Äî':''} ${todayStr} done, ${remStr} to go</div>
          <div style="font-family:'Space Mono',monospace;font-size:9px;color:${accentCol};opacity:.75;margin-top:3px;letter-spacing:1.2px;">ALL-TIME ¬∑ ${allTimeStr.toUpperCase()}</div>
        </div>
        <div style="flex-shrink:0;background:rgba(251,191,36,.12);border:1px solid rgba(251,191,36,.3);border-radius:10px;padding:6px 11px;">
          <div style="font-family:'Bebas Neue',sans-serif;font-size:13px;letter-spacing:1.5px;color:#fbbf24;">${remStr}<br><span style="font-size:8px;color:rgba(251,191,36,.6);letter-spacing:2px;">LEFT</span></div>
        </div>
      </div>
      <div style="margin-top:13px;height:5px;background:rgba(255,255,255,.07);border-radius:4px;overflow:hidden;">
        <div style="--bar-w:${barW}%;width:${barW}%;height:100%;background:${barGrad};border-radius:4px;animation:ss-bar .9s cubic-bezier(.4,0,.2,1) forwards;box-shadow:0 0 10px rgba(251,191,36,.4);"></div>
      </div>
      <div style="display:flex;justify-content:space-between;margin-top:6px;">
        <span style="font-family:'Space Mono',monospace;font-size:8px;color:rgba(253,230,138,.4);letter-spacing:1px;">0H</span>
        <span style="font-family:'Space Mono',monospace;font-size:8px;color:rgba(253,230,138,.4);letter-spacing:1px;">2H</span>
        <span style="font-family:'Space Mono',monospace;font-size:8px;color:${isHot?'rgba(134,239,172,.7)':'rgba(253,230,138,.4)'};letter-spacing:1px;${isHot?'font-weight:700;':''}">4H STREAK</span>
      </div>`;
  }

  el.innerHTML=html;
}

function updateAll(){
  const cur=getCurBadge();
  document.getElementById('headerStreak').textContent=S.streak+' üî•';
  updateHero();
  updateProgressUI();
  updateCheckinBtn();
  renderBadges();
  renderGrids();
  checkAchievedBanners();
}

// ===== CHECK IN =====
function isToday(){
  if(!S.last)return false;
  return new Date(S.last).toDateString()===new Date().toDateString();
}
function updateCheckinBtn(){
  const btn=document.getElementById('checkinBtn');

  if(isToday()){
    btn.className='checkin-btn done';
    btn.innerHTML='‚úì CHECKED IN TODAY';
  } else {
    btn.className='checkin-btn available';
    btn.innerHTML='‚úì CHECK IN TODAY';
  }
}

function handleCheckin(){
  if(navigator.vibrate) navigator.vibrate(12);
  openStudyModal();
}

function calcDuration(){
  const start=document.getElementById('studyStartTime').value;
  const end=document.getElementById('studyEndTime').value;
  const el=document.getElementById('durationDisplay');
  const hintEl=document.getElementById('dailyGoalHint');
  if(!start||!end){el.innerHTML='';return;}
  const [sh,sm]=start.split(':').map(Number);
  const [eh,em]=end.split(':').map(Number);
  let totalMins=(eh*60+em)-(sh*60+sm);
  if(totalMins<0)totalMins+=1440;
  if(totalMins<=0){
    el.innerHTML=`<div style="display:inline-flex;align-items:center;gap:7px;background:#fff5f5;border:1px solid #fecaca;border-radius:8px;padding:7px 12px;">
      <span style="font-family:'Nunito',sans-serif;font-size:13px;font-weight:700;color:#ef4444;">End time must be after start</span>
    </div>`;
    return;
  }
  const hrs=Math.floor(totalMins/60),rm=totalMins%60;
  const durStr=`${hrs>0?hrs+'h ':''}${rm>0?rm+'m':''}`.trim();
  el.innerHTML=`<div style="display:inline-flex;align-items:center;gap:8px;background:linear-gradient(135deg,#f0fdf4,#dcfce7);border:1.5px solid #86efac;border-radius:10px;padding:8px 14px;">
    <svg width="15" height="15" viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="9" stroke="#16a34a" stroke-width="2"/><path d="M12 7v5l3 3" stroke="#16a34a" stroke-width="2" stroke-linecap="round"/></svg>
    <span style="font-family:'Nunito',sans-serif;font-size:13px;font-weight:800;color:#14532d;letter-spacing:.2px;">Duration</span>
    <span style="font-family:'Bebas Neue',sans-serif;font-size:17px;color:#16a34a;letter-spacing:1px;line-height:1;">${durStr}</span>
  </div>`;

  if(hintEl&&!isToday()){
    const projected=getTodayLoggedMins()+totalMins;
    const rem=Math.max(0,DAILY_GOAL_MINS-projected);
    if(projected>=DAILY_GOAL_MINS){
      hintEl.innerHTML=`<div style="display:inline-flex;align-items:center;gap:7px;background:linear-gradient(135deg,#052e16,#14532d);border-radius:10px;padding:8px 14px;margin-top:6px;">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none"><path d="M13 3L4 14h7l-1 7 9-11h-7l1-7z" fill="#fbbf24" stroke="#f59e0b" stroke-width=".5"/></svg>
        <span style="font-family:'Nunito',sans-serif;font-size:13px;font-weight:800;color:#4ade80;letter-spacing:.2px;">This session unlocks today's streak!</span>
      </div>`;
    } else {
      const rh=Math.floor(rem/60),rmm=rem%60;
      const remStr=`${rh>0?rh+'h ':''}${rmm}m`;
      hintEl.innerHTML=`<div style="display:inline-flex;align-items:center;gap:7px;background:#f9fafb;border:1px solid #e5e7eb;border-radius:10px;padding:7px 12px;margin-top:6px;">
        <span style="font-family:'Nunito',sans-serif;font-size:12px;font-weight:700;color:#6b7280;">After this: <strong style="color:#14532d;">${Math.floor(projected/60)}h${projected%60>0?(projected%60)+'m':''}</strong> ¬∑ <strong style="color:#f59e0b;">${remStr}</strong> still needed for streak</span>
      </div>`;
    }
  }
}

function openStudyModal(){
  document.getElementById('studyModal').style.display='flex';
  const now=new Date();
  const hh=String(now.getHours()).padStart(2,'0');
  const mm=String(now.getMinutes()).padStart(2,'0');
  // Set hidden input for start time
  document.getElementById('studyStartTime').value=hh+':'+mm;
  document.getElementById('studyEndTime').value='';
  // Update visual pickers
  tpSetDisplay('start', hh+':'+mm);
  tpSetDisplay('end', null);
  document.getElementById('durationDisplay').innerHTML='';
  const todayMins=getTodayLoggedMins();
  const hintEl=document.getElementById('dailyGoalHint');
  if(hintEl){
    const rem=Math.max(0,DAILY_GOAL_MINS-todayMins);
    if(todayMins>=DAILY_GOAL_MINS){
      const th=Math.floor(todayMins/60),tm=todayMins%60;
      hintEl.innerHTML=`<div style="display:inline-flex;align-items:center;gap:7px;background:linear-gradient(135deg,#052e16,#14532d);border-radius:10px;padding:8px 14px;">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none"><path d="M12 2l2.4 7.4H22l-6.2 4.5 2.4 7.4L12 17l-6.2 4.3 2.4-7.4L2 9.4h7.6L12 2z" fill="#fbbf24"/></svg>
        <span style="font-family:'Nunito',sans-serif;font-size:13px;font-weight:800;color:#4ade80;">Goal hit! ${th}h${tm>0?tm+'m':''} logged ‚Äî extra session counts</span>
      </div>`;
    } else if(todayMins>0){
      const rh=Math.floor(rem/60),rm2=rem%60;
      const dh=Math.floor(todayMins/60),dm=todayMins%60;
      hintEl.innerHTML=`<div style="display:inline-flex;align-items:center;gap:7px;background:#f9fafb;border:1px solid #e5e7eb;border-radius:10px;padding:7px 12px;">
        <span style="font-family:'Nunito',sans-serif;font-size:12px;font-weight:700;color:#6b7280;"><strong style="color:#14532d;">${dh>0?dh+'h':''}${dm}m</strong> logged today ¬∑ <strong style="color:#f59e0b;">${rh>0?rh+'h ':''}${rm2}m</strong> to unlock streak</span>
      </div>`;
    } else {
      hintEl.innerHTML=`<div style="display:inline-flex;align-items:center;gap:7px;background:#f9fafb;border:1px solid #e5e7eb;border-radius:10px;padding:7px 12px;">
        <span style="font-family:'Nunito',sans-serif;font-size:12px;font-weight:700;color:#9ca3af;">Log <strong style="color:#14532d;">4h total today</strong> to advance your streak</span>
      </div>`;
    }
  }
}
function closeStudyModal(){
  document.getElementById('studyModal').style.display='none';
  tpSetDisplay('end', null);
}

// ===== CUSTOM TIME PICKER =====
let _tpTarget=null; // 'start' or 'end'
let _tpH=12, _tpM=0, _tpAmPm='PM';
let _tpScrolling=false;

function tpSetDisplay(which, val24){
  const dispEl=document.getElementById(which==='start'?'startTimeDisplay':'endTimeDisplay');
  const tapEl=dispEl?dispEl.nextElementSibling:null;
  const wrapper=document.getElementById(which==='start'?'startTimePicker':'endTimePicker');
  if(!val24){
    dispEl.textContent='--:--';
    dispEl.style.color='#9ca3af';
    if(tapEl) tapEl.textContent='TAP TO SET';
    if(wrapper){ wrapper.style.background='#f9fafb'; wrapper.style.borderColor='#e5e7eb'; }
    return;
  }
  const [hh,mm]=val24.split(':').map(Number);
  const ampm=hh>=12?'PM':'AM';
  const h12=hh%12||12;
  const display=`${String(h12).padStart(2,'0')}:${String(mm).padStart(2,'0')} ${ampm}`;
  dispEl.textContent=display;
  dispEl.style.color='#14532d';
  if(tapEl) tapEl.textContent='TAP TO CHANGE';
  if(which==='start'&&wrapper){ wrapper.style.background='linear-gradient(135deg,#f0fdf4,#dcfce7)'; wrapper.style.borderColor='#86efac'; }
  if(which==='end'&&wrapper){ wrapper.style.background='linear-gradient(135deg,#f0fdf4,#dcfce7)'; wrapper.style.borderColor='#86efac'; }
}

function openTimePicker(which){
  _tpTarget=which;
  const val=document.getElementById(which==='start'?'studyStartTime':'studyEndTime').value;
  if(val){
    const [hh,mm]=val.split(':').map(Number);
    _tpAmPm=hh>=12?'PM':'AM';
    _tpH=hh%12||12;
    _tpM=mm;
  } else {
    const now=new Date();
    _tpH=now.getHours()%12||12;
    _tpM=Math.round(now.getMinutes()/5)*5%60;
    _tpAmPm=now.getHours()>=12?'PM':'AM';
  }
  document.getElementById('tpSheetLabel').textContent=which==='start'?'START TIME':'END TIME';
  tpBuildDrums();
  const sheet=document.getElementById('timePickerSheet');
  sheet.style.display='flex';
  tpUpdatePreview();
}

function tpBuildDrums(){
  // Hours 1-12
  const dH=document.getElementById('drumHour');
  dH.innerHTML=`<div class="tp-drum-spacer"></div>`;
  for(let i=1;i<=12;i++){
    const d=document.createElement('div');
    d.className='tp-drum-item'+(i===_tpH?' selected':'');
    d.textContent=String(i).padStart(2,'0');
    dH.appendChild(d);
  }
  dH.innerHTML+=`<div class="tp-drum-spacer"></div>`;

  // Minutes 0,5,10...55
  const dM=document.getElementById('drumMin');
  dM.innerHTML=`<div class="tp-drum-spacer"></div>`;
  for(let i=0;i<60;i+=5){
    const d=document.createElement('div');
    d.className='tp-drum-item'+(i===_tpM?' selected':'');
    d.textContent=String(i).padStart(2,'0');
    dM.appendChild(d);
  }
  dM.innerHTML+=`<div class="tp-drum-spacer"></div>`;

  // AM/PM
  const dAP=document.getElementById('drumAmPm');
  dAP.innerHTML=`<div class="tp-drum-spacer"></div>`;
  ['AM','PM'].forEach(v=>{
    const d=document.createElement('div');
    d.className='tp-drum-item'+(v===_tpAmPm?' selected':'');
    d.textContent=v;
    dAP.appendChild(d);
  });
  dAP.innerHTML+=`<div class="tp-drum-spacer"></div>`;

  // Scroll to selected after render
  setTimeout(()=>{
    tpScrollToSelected('drumHour',_tpH-1);
    tpScrollToSelected('drumMin',_tpM/5);
    tpScrollToSelected('drumAmPm',_tpAmPm==='AM'?0:1);
  },50);
}

function tpScrollToSelected(drumId, idx){
  const drum=document.getElementById(drumId);
  if(!drum) return;
  drum.scrollTop=idx*48;
}

function tpDrumScroll(type){
  clearTimeout(window._tpSnapTimer);
  window._tpSnapTimer=setTimeout(()=>{
    const drumId=type==='hour'?'drumHour':type==='min'?'drumMin':'drumAmPm';
    const drum=document.getElementById(drumId);
    const idx=Math.round(drum.scrollTop/48);
    drum.scrollTop=idx*48;
    if(type==='hour'){_tpH=(idx%12)+1;}
    else if(type==='min'){_tpM=(idx%12)*5;}
    else{_tpAmPm=idx===0?'AM':'PM';}
    // Highlight selected
    drum.querySelectorAll('.tp-drum-item').forEach((el,i)=>{
      el.classList.toggle('selected',i===idx);
    });
    tpUpdatePreview();
  },80);
}

function tpUpdatePreview(){
  const h=String(_tpH).padStart(2,'0');
  const m=String(_tpM).padStart(2,'0');
  document.getElementById('tpPreview').textContent=`${h}:${m}`;
  document.getElementById('tpAmPmPreview').textContent=_tpAmPm;
}

function closeTimePicker(confirm){
  if(confirm){
    // Convert to 24h
    let h24=_tpH%12;
    if(_tpAmPm==='PM') h24+=12;
    const val24=`${String(h24).padStart(2,'0')}:${String(_tpM).padStart(2,'0')}`;
    document.getElementById(_tpTarget==='start'?'studyStartTime':'studyEndTime').value=val24;
    tpSetDisplay(_tpTarget, val24);
    calcDuration();
  }
  document.getElementById('timePickerSheet').style.display='none';
}

// ===== DAILY GOAL =====
const DAILY_GOAL_MINS = 240; // 4 hours

function getTodayLoggedMins(){
  const todayStr = new Date().toDateString();
  return S.studylogs
    .filter(l => new Date(l.date).toDateString() === todayStr)
    .reduce((a,l) => a+l.totalMins, 0);
}

// ===== ATOMIC BUNDLE SYSTEM =====
// Every study session creates a bundleId that ties together:
// - the study log entry
// - the journal entry (always created, not just when notes exist)
// - the streak change (if this session pushed today over 4h)
// Deleting any part of the bundle deletes ALL parts and reverses the streak.

function saveStudyLog(){
  const subject=document.getElementById('studySubject').value.trim()||'General';
  const startTime=document.getElementById('studyStartTime').value;
  const endTime=document.getElementById('studyEndTime').value;
  const notes=document.getElementById('studyNotes').value.trim();
  let totalMins=0;
  if(startTime&&endTime){
    const [sh,sm]=startTime.split(':').map(Number);
    const [eh,em]=endTime.split(':').map(Number);
    totalMins=(eh*60+em)-(sh*60+sm);
    if(totalMins<0)totalMins+=1440;
  }
  if(totalMins<=0){showToast('‚ö†Ô∏è Set valid start & end time');return;}

  const now=new Date();
  const bundleId='bundle_'+Date.now(); // üîë The shared ID linking all parts

  // --- Check streak impact BEFORE saving ---
  const prevTodayTotal=getTodayLoggedMins();
  const newTodayTotal=prevTodayTotal+totalMins;
  const crossedGoal=prevTodayTotal<DAILY_GOAL_MINS && newTodayTotal>=DAILY_GOAL_MINS;
  const alreadyCheckedIn=isToday();
  const gainedStreak=crossedGoal&&!alreadyCheckedIn;

  // --- Always create study log ---
  const h=Math.floor(totalMins/60),m=totalMins%60;
  const log={
    id:Date.now(),
    bundleId,               // üîë linked
    date:now.toISOString(),
    dateStr:now.toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric'}),
    subject,totalMins,startTime,endTime,notes,
    streak:S.streak+(gainedStreak?1:0),
    dayOfWeek:now.getDay(),
    hour:startTime?parseInt(startTime.split(':')[0]):now.getHours(),
    gainedStreak,            // did this bundle unlock today's streak?
    streakBefore:S.streak    // so we can roll back on delete
  };

  // --- Always create journal entry (even if no notes) ---
  const jText=notes
    ?`[${subject} ¬∑ ${h>0?h+'h ':''}${m}m ¬∑ ${startTime}‚Äì${endTime}]\n${notes}`
    :`[${subject} ¬∑ ${h>0?h+'h ':''}${m}m ¬∑ ${startTime}‚Äì${endTime}]\n(No notes)`;
  const journalEntry={
    id:Date.now()+1,
    bundleId,               // üîë linked
    date:now.toLocaleDateString('en-US',{weekday:'long',year:'numeric',month:'long',day:'numeric'}),
    dateISO:now.toISOString().split('T')[0],
    text:jText,
    streak:log.streak,ts:Date.now()+1,type:'study',subject,startTime,endTime,
    gainedStreak,streakBefore:S.streak
  };

  S.studylogs.push(log);
  S.journal.push(journalEntry);

  // --- Update permanent total study minutes (never resets) ---
  S.totalMins=(S.totalMins||0)+totalMins;
  sv(K.TOTALMINS,S.totalMins);

  sv(K.STUDYLOGS,S.studylogs);
  sv(K.JOURNAL,S.journal);

  closeStudyModal();
  document.getElementById('studySubject').value='';
  document.getElementById('studyNotes').value='';
  document.getElementById('studyEndTime').value='';
  document.getElementById('durationDisplay').textContent='';

  if(gainedStreak){
    S.streak++;
    const n=new Date();S.last=n.toISOString();
    const t=n.toDateString();
    if(!S.dates.includes(t))S.dates.push(t);
    sv(K.STREAK,S.streak);sv(K.LAST,S.last);sv(K.DATES,S.dates);
    syncToIDB();
    updateAll();showSuccessCard();playSuccess();
    if(S.notif&&Notification.permission==='granted')
      new Notification('CHAIN üîó',{body:`Day ${S.streak} done! 4h goal crushed! üî•`});
  } else {
    syncToIDB();
    updateAll();
    const rem=Math.max(0,DAILY_GOAL_MINS-newTodayTotal);
    if(rem>0){
      const rh=Math.floor(rem/60),rm2=rem%60;
      const dh=Math.floor(newTodayTotal/60),dm=newTodayTotal%60;
      showToast(`üìö ${dh}h${dm>0?dm+'m':''} logged ¬∑ ${rh>0?rh+'h ':''}${rm2}m more to unlock streak`);
    } else {
      showToast('‚úÖ Session logged! Streak already counted today.');
    }
    playSuccess();
  }
}

// ===== ATOMIC BUNDLE DELETE =====
// Deletes the study log, journal entry, AND reverses streak if this session was the one that unlocked it.
function deleteBundleById(bundleId){
  // Find the study log
  const log=S.studylogs.find(l=>l.bundleId===bundleId);
  if(!log){showToast('‚ùå Bundle not found');return;}

  const streakWillReverse=log.gainedStreak && isToday();

  let msg=`Delete this study session?\n\nThis will permanently remove:\n‚Ä¢ Study log (${log.subject} ¬∑ ${Math.floor(log.totalMins/60)}h${log.totalMins%60}m)\n‚Ä¢ Journal entry`;
  if(streakWillReverse) msg+=`\n‚Ä¢ Today's streak (+1 will be undone, streak returns to ${log.streakBefore})`;
  else if(log.gainedStreak) msg+=`\n‚ö†Ô∏è Note: This session previously unlocked a streak, but since it's a past day, only the log/journal will be removed.`;

  if(!confirm(msg))return;

  // Remove study log
  const minsToRemove=log.totalMins;
  S.studylogs=S.studylogs.filter(l=>l.bundleId!==bundleId);

  // Remove linked journal entry
  S.journal=S.journal.filter(e=>e.bundleId!==bundleId);

  // Subtract from permanent total (but never below 0)
  S.totalMins=Math.max(0,(S.totalMins||0)-minsToRemove);
  sv(K.TOTALMINS,S.totalMins);

  // Reverse streak ONLY if this session was today's streak-unlocking session
  if(streakWillReverse){
    S.streak=log.streakBefore;
    S.last=null;
    // Remove today from dates
    const todayStr=new Date().toDateString();
    S.dates=S.dates.filter(d=>d!==todayStr);
    sv(K.STREAK,S.streak);sv(K.LAST,S.last);sv(K.DATES,S.dates);
    showToast('üîÑ Session deleted ¬∑ Streak reversed to '+S.streak+' days');
  } else {
    showToast('üóë Session and journal entry deleted');
  }

  sv(K.STUDYLOGS,S.studylogs);
  sv(K.JOURNAL,S.journal);
  syncToIDB();
  updateAll();
  renderStudyLogList();
  renderJournal();
}

// ===== TIMER =====
function updateTimer(){
  const now=new Date(),midnight=new Date();midnight.setHours(24,0,0,0);
  const diff=midnight-now;
  const h=String(Math.floor(diff/3600000)).padStart(2,'0');
  const m=String(Math.floor((diff%3600000)/60000)).padStart(2,'0');
  const s=String(Math.floor((diff%60000)/1000)).padStart(2,'0');
  document.getElementById('timerDisplay').textContent=h+':'+m+':'+s;
}

// ===== ANALYTICS (Forest Style) =====
let curPeriod='day';
let periodOffset=0; // how many periods back we are
const SUBJECT_COLORS=['#22c55e','#3b82f6','#f59e0b','#ef4444','#8b5cf6','#ec4899','#14b8a6','#f97316'];

function setForestPeriod(period, btn){
  curPeriod=period; periodOffset=0;
  document.querySelectorAll('.forest-period-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  renderAnalytics();
}

function shiftPeriod(dir){
  periodOffset+=dir;
  if(periodOffset>0)periodOffset=0;
  renderAnalytics();
}

function getPeriodRange(){
  const now=new Date();
  let from=new Date(), to=new Date(), label='';
  if(curPeriod==='day'){
    from=new Date(now); from.setDate(now.getDate()+periodOffset); from.setHours(0,0,0,0);
    to=new Date(from); to.setHours(23,59,59,999);
    if(periodOffset===0)label='Today';
    else label=from.toLocaleDateString('en-US',{month:'long',day:'numeric',year:'numeric'})+(periodOffset===0?' (Today)':'');
  } else if(curPeriod==='week'){
    // Start of week (Mon) + offset weeks
    const day=now.getDay(); const diff=day===0?6:day-1;
    from=new Date(now); from.setDate(now.getDate()-diff+periodOffset*7); from.setHours(0,0,0,0);
    to=new Date(from); to.setDate(from.getDate()+6); to.setHours(23,59,59,999);
    label=from.toLocaleDateString('en-US',{month:'short',day:'numeric'})+' ‚Äì '+to.toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'});
  } else if(curPeriod==='month'){
    from=new Date(now.getFullYear(),now.getMonth()+periodOffset,1);
    to=new Date(now.getFullYear(),now.getMonth()+periodOffset+1,0,23,59,59,999);
    label=from.toLocaleDateString('en-US',{month:'long',year:'numeric'});
  } else {
    from=new Date(now.getFullYear()+periodOffset,0,1);
    to=new Date(now.getFullYear()+periodOffset,11,31,23,59,59,999);
    label=String(now.getFullYear()+periodOffset);
  }
  return{from,to,label};
}

function getLogsForPeriod(from,to){
  const f=from.getTime(),t=to.getTime();
  return S.studylogs.filter(l=>{const d=new Date(l.date).getTime();return d>=f&&d<=t;});
}

// ===== PEAK TIME: finds longest/heaviest CONTINUOUS study block across all logs =====
// Strategy: build a 24-slot hour array of total minutes, then find the contiguous
// run of hours with the most total minutes (i.e. the biggest unbroken block).
function getPeakTimeBlock(logsToUse){
  const allLogs = logsToUse && logsToUse.length ? logsToUse : S.studylogs;
  if(!allLogs.length) return null;

  // Build per-hour minute totals (use start+end to cover multi-hour sessions)
  const hourMins=Array(24).fill(0);
  allLogs.forEach(l=>{
    if(!l.startTime||!l.endTime) {
      if(l.hour>=0&&l.hour<24) hourMins[l.hour]+=l.totalMins;
      return;
    }
    const[sh,sm]=l.startTime.split(':').map(Number);
    const[eh,em]=l.endTime.split(':').map(Number);
    let startMin=sh*60+sm, endMin=eh*60+em;
    if(endMin<=startMin) endMin+=1440;
    // Distribute minutes across each clock-hour
    for(let h=sh;h<Math.ceil(endMin/60)&&h<24;h++){
      const slotStart=h*60, slotEnd=(h+1)*60;
      const overlapStart=Math.max(startMin,slotStart);
      const overlapEnd=Math.min(endMin,slotEnd);
      if(overlapEnd>overlapStart) hourMins[h%24]+=(overlapEnd-overlapStart);
    }
  });

  // Find all contiguous active blocks (hours with >0 mins)
  let bestStart=0,bestEnd=0,bestMins=0;
  let runStart=-1,runMins=0;
  for(let h=0;h<=24;h++){
    const m=h<24?hourMins[h]:0;
    if(m>0){
      if(runStart<0){runStart=h;runMins=0;}
      runMins+=m;
    } else {
      if(runStart>=0){
        if(runMins>bestMins){bestMins=runMins;bestStart=runStart;bestEnd=h-1;}
        runStart=-1;runMins=0;
      }
    }
  }
  if(bestMins===0) return null;

  // Format: "9‚Äì11 AM", "1‚Äì3 PM", "11 AM‚Äì1 PM" (cross noon)
  function fmtH(h){
    const ampm=h<12?'AM':'PM';
    const h12=h===0?12:h>12?h-12:h;
    return h12+'';
  }
  function fmtHfull(h){
    const ampm=h<12?'AM':'PM';
    const h12=h===0?12:h>12?h-12:h;
    return h12+' '+ampm;
  }
  const startAmpm=bestStart<12?'AM':'PM';
  const endH=bestEnd+1; // end is exclusive
  const endAmpm=endH<12?'AM':endH===12?'PM':endH>12?'PM':'AM';
  let label;
  if(startAmpm===endAmpm){
    label=`${fmtH(bestStart)}‚Äì${fmtH(endH)} ${startAmpm}`;
  } else {
    label=`${fmtHfull(bestStart)}‚Äì${fmtHfull(endH)}`;
  }
  return{label, startH:bestStart, endH, totalMins:bestMins, hourMins};
}

function renderAnalytics(){
  const{from,to,label}=getPeriodRange();
  document.getElementById('forestDateLabel').textContent=label;
  const logs=getLogsForPeriod(from,to);
  const totalMins=logs.reduce((a,l)=>a+l.totalMins,0);
  const sessions=logs.length;

  // Summary stats
  const dispTotal=totalMins>=60?(Math.floor(totalMins/60)+'h'+(totalMins%60?totalMins%60+'m':'')):totalMins+'m';
  document.getElementById('statTotalHours').textContent=dispTotal||'0m';
  document.getElementById('statSessions').textContent=sessions;

  // Peak time ‚Äî use ALL logs for cross-period patterns, but use period logs for per-period tabs
  const peakSrc = (curPeriod==='day'||sessions>0) ? logs : S.studylogs;
  const peakBlock=getPeakTimeBlock(peakSrc);
  const peakEl=document.getElementById('statPeak');
  peakEl.textContent=peakBlock?peakBlock.label:'‚Äî';
  peakEl.style.fontSize=peakBlock?'18px':'28px';

  document.getElementById('totalFocused').textContent=totalMins>=120?(Math.floor(totalMins/60)+'h '+(totalMins%60)+'m'):totalMins+' mins';
  renderBarChart(logs,from,to,totalMins);
  renderLineChart();
  renderTrend(logs,from,to);
  renderDonut(logs);
  renderStudyLogList();
}

function renderBarChart(logs,from,to,totalMins){
  const chart=document.getElementById('studyBarChart');
  chart.querySelectorAll('.bar-item').forEach(e=>e.remove());
  document.getElementById('barAxisLabels').innerHTML='';
  let buckets=[];
  if(curPeriod==='day'){
    const labels=['0','4','8','12','16','20'];
    buckets=labels.map((lbl,i)=>({
      label:lbl+'h',
      mins:logs.filter(l=>l.hour>=i*4&&l.hour<(i+1)*4).reduce((a,l)=>a+l.totalMins,0)
    }));
  } else if(curPeriod==='week'){
    const days=['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
    buckets=days.map((d,i)=>({
      label:d,
      mins:logs.filter(l=>{const dd=new Date(l.date).getDay();return((dd===0?7:dd)-1)===i;}).reduce((a,l)=>a+l.totalMins,0)
    }));
  } else if(curPeriod==='month'){
    // Proper calendar weeks: week starts Monday, show as many weeks as needed
    const year=from.getFullYear(), month=from.getMonth();
    const daysInMonth=new Date(year,month+1,0).getDate();
    // Find Monday of the week containing day 1
    const firstDay=new Date(year,month,1);
    const dow=firstDay.getDay(); // 0=Sun
    const mondayOffset=dow===0?-6:1-dow;
    const weekStart=new Date(year,month,1+mondayOffset);
    
    buckets=[];
    let wk=1;
    let ws=new Date(weekStart);
    while(ws.getTime()<=new Date(year,month,daysInMonth).getTime()){
      const we=new Date(ws);we.setDate(ws.getDate()+6);we.setHours(23,59,59,999);
      // Only show weeks that overlap with this month
      const wMins=logs.filter(l=>{const d=new Date(l.date);return d>=ws&&d<=we;}).reduce((a,l)=>a+l.totalMins,0);
      buckets.push({label:'Wk'+wk, mins:wMins});
      ws.setDate(ws.getDate()+7);
      wk++;
      if(wk>6)break; // safety
    }
  } else {
    const mNames=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
    const yr=from.getFullYear();
    buckets=mNames.map((m,i)=>({label:m,mins:logs.filter(l=>{const d=new Date(l.date);return d.getMonth()===i&&d.getFullYear()===yr;}).reduce((a,l)=>a+l.totalMins,0)}));
  }
  const maxMins=Math.max(...buckets.map(b=>b.mins),1);
  // Decide unit: if max >= 120 mins, display in hours
  const useHours=maxMins>=120;
  const CHART_H=200; // matches CSS height
  const LABEL_H=30;  // reserve px for label + val at bottom
  const USABLE_H=CHART_H-LABEL_H;
  // Grid Y labels
  let grid=chart.querySelector('.bar-chart-grid');
  if(!grid){grid=document.createElement('div');grid.className='bar-chart-grid';chart.insertBefore(grid,chart.firstChild);}
  const steps=[100,75,50,25,0];
  grid.innerHTML=steps.map(v=>{
    const val=useHours?((maxMins*(v/100))/60).toFixed(1)+'h':Math.round(maxMins*(v/100))+'m';
    return `<div class="bar-chart-line" style="position:relative;"><span>${val}</span></div>`;
  }).join('');
  buckets.forEach((b,idx)=>{
    const pct=b.mins>0?(b.mins/maxMins):0;
    const barH=Math.max(4, Math.round(pct*USABLE_H));
    const dispVal=useHours?(b.mins/60).toFixed(1)+'h':b.mins+'m';
    const item=document.createElement('div');
    item.className='bar-item';
    item.innerHTML=`<div class="bar-val" style="height:14px;">${b.mins>0?dispVal:''}</div>
      <div class="bar-fill" style="height:${barH}px;"></div>
      <div class="bar-label">${b.label}</div>`;
    chart.appendChild(item);
  });
}

// ===== LINE CHART ‚Äî Most Focused Period =====
function renderLineChart(){
  const svg=document.getElementById('lineChartSvg');
  svg.innerHTML='';
  const ns='http://www.w3.org/2000/svg';

  // Use ALL logs to show general daily pattern
  const peakBlock=getPeakTimeBlock(S.studylogs);
  const hourMins=peakBlock?peakBlock.hourMins:Array(24).fill(0);
  const maxH=Math.max(...hourMins,1);

  // Update subtitle label
  const peakLabel=peakBlock?peakBlock.label:'‚Äî';
  document.getElementById('peakHourLabel').textContent=peakLabel;
  document.getElementById('peakTimeSubtitle').textContent=
    peakBlock?`Most study happens ${peakBlock.label} across your history`:'Log sessions to discover your peak time';

  // Draw baseline
  const base=document.createElementNS(ns,'line');
  base.setAttribute('x1','0');base.setAttribute('y1','75');base.setAttribute('x2','300');base.setAttribute('y2','75');
  base.setAttribute('stroke','#e5e7eb');base.setAttribute('stroke-width','1');svg.appendChild(base);

  if(!S.studylogs.length)return;

  // Smooth curve points
  const pts=hourMins.map((m,h)=>({x:h*(300/23),y:75-(m/maxH)*65}));
  const pathD='M'+pts.map(p=>`${p.x.toFixed(1)},${p.y.toFixed(1)}`).join(' L');

  // Fill area
  const fillD=pathD+` L${pts[23].x},75 L${pts[0].x},75 Z`;
  const fill=document.createElementNS(ns,'path');
  fill.setAttribute('d',fillD);fill.setAttribute('fill','rgba(34,197,94,0.15)');svg.appendChild(fill);

  // Line
  const path=document.createElementNS(ns,'path');
  path.setAttribute('d',pathD);path.setAttribute('fill','none');
  path.setAttribute('stroke','#22c55e');path.setAttribute('stroke-width','2');path.setAttribute('stroke-linejoin','round');
  svg.appendChild(path);

  if(!peakBlock)return;

  // Highlight the whole peak block with a shaded region
  const blockStartX=peakBlock.startH*(300/23);
  const blockEndX=Math.min(peakBlock.endH*(300/23),300);
  const blockRect=document.createElementNS(ns,'rect');
  blockRect.setAttribute('x',blockStartX);blockRect.setAttribute('y','0');
  blockRect.setAttribute('width',blockEndX-blockStartX);blockRect.setAttribute('height','75');
  blockRect.setAttribute('fill','rgba(34,197,94,0.12)');blockRect.setAttribute('rx','2');
  svg.insertBefore(blockRect,fill); // behind fill

  // Peak circle at highest point in block
  let peakH=peakBlock.startH;
  for(let h=peakBlock.startH;h<=peakBlock.endH&&h<24;h++){
    if(hourMins[h]>hourMins[peakH])peakH=h;
  }
  const peak=pts[peakH];
  const circ=document.createElementNS(ns,'circle');
  circ.setAttribute('cx',peak.x);circ.setAttribute('cy',peak.y);circ.setAttribute('r','4');
  circ.setAttribute('fill','#22c55e');circ.setAttribute('stroke','#fff');circ.setAttribute('stroke-width','2');
  svg.appendChild(circ);
  // Dashed drop line
  const dash=document.createElementNS(ns,'line');
  dash.setAttribute('x1',peak.x);dash.setAttribute('y1',peak.y);dash.setAttribute('x2',peak.x);dash.setAttribute('y2','75');
  dash.setAttribute('stroke','#9ca3af');dash.setAttribute('stroke-width','1');dash.setAttribute('stroke-dasharray','3,3');
  svg.appendChild(dash);
}

// ===== FOCUS TREND =====
function renderTrend(logs,from,to){
  const el=document.getElementById('trendSection');
  const totalMins=logs.reduce((a,l)=>a+l.totalMins,0);

  // Get previous period's mins
  let prevFrom=new Date(from), prevTo=new Date(to);
  if(curPeriod==='day'){prevFrom.setDate(prevFrom.getDate()-1);prevTo.setDate(prevTo.getDate()-1);}
  else if(curPeriod==='week'){prevFrom.setDate(prevFrom.getDate()-7);prevTo.setDate(prevTo.getDate()-7);}
  else if(curPeriod==='month'){prevFrom.setMonth(prevFrom.getMonth()-1);prevTo.setMonth(prevTo.getMonth()-1);}
  else{prevFrom.setFullYear(prevFrom.getFullYear()-1);prevTo.setFullYear(prevTo.getFullYear()-1);}
  const prevLogs=S.studylogs.filter(l=>{const d=new Date(l.date);return d>=prevFrom&&d<=prevTo;});
  const prevMins=prevLogs.reduce((a,l)=>a+l.totalMins,0);
  const diff=totalMins-prevMins;
  const diffStr=(diff>=0?'+':'')+diff+'M '+( diff>=0?'longer':'shorter');
  const diffColor=diff>=0?'#22c55e':'#ef4444';
  const maxBar=Math.max(totalMins,prevMins,1);

  el.innerHTML=`
    <div style="font-size:12px;color:#6b7280;margin-bottom:12px;">
      This period vs last: <span style="color:${diffColor};font-weight:700;">${diffStr}</span>
    </div>
    <div class="trend-row">
      <div class="trend-row-label">This period <span>${totalMins} M</span></div>
      <div class="trend-bar-track"><div class="trend-bar-fill" style="width:${(totalMins/maxBar)*100}%;"></div></div>
    </div>
    <div class="trend-row">
      <div class="trend-row-label">Previous period <span style="color:#9ca3af;">${prevMins} M</span></div>
      <div class="trend-bar-track"><div class="trend-bar-fill" style="width:${(prevMins/maxBar)*100}%;background:#bbf7d0;"></div></div>
    </div>`;
}

// ===== DONUT CHART =====
function renderDonut(logs){
  const svg=document.getElementById('donutSvg');
  const legend=document.getElementById('donutLegend');
  const ns='http://www.w3.org/2000/svg';
  svg.innerHTML=''; legend.innerHTML='';

  const subMap={};
  logs.forEach(l=>{const s=l.subject||'General';subMap[s]=(subMap[s]||0)+l.totalMins;});
  const sorted=Object.entries(subMap).sort((a,b)=>b[1]-a[1]);
  const total=sorted.reduce((a,v)=>a+v[1],0);

  if(!sorted.length){
    svg.innerHTML='<circle cx="60" cy="60" r="40" fill="none" stroke="#f0fdf4" stroke-width="20"/>';
    legend.innerHTML='<p style="color:#9ca3af;font-size:11px;">No data yet</p>';
    document.getElementById('donutTopPct').textContent='0%';
    return;
  }

  document.getElementById('donutTopPct').textContent=total>0?Math.round((sorted[0][1]/total)*100)+'%':'0%';

  let startAngle=-Math.PI/2;
  const cx=60,cy=60,r=45,inner=28;
  sorted.slice(0,6).forEach(([sub,mins],i)=>{
    const pct=mins/total;
    const angle=pct*Math.PI*2;
    const end=startAngle+angle;
    const x1=cx+r*Math.cos(startAngle);const y1=cy+r*Math.sin(startAngle);
    const x2=cx+r*Math.cos(end);const y2=cy+r*Math.sin(end);
    const ix1=cx+inner*Math.cos(startAngle);const iy1=cy+inner*Math.sin(startAngle);
    const ix2=cx+inner*Math.cos(end);const iy2=cy+inner*Math.sin(end);
    const largeArc=angle>Math.PI?1:0;
    const col=SUBJECT_COLORS[i%SUBJECT_COLORS.length];
    const path=document.createElementNS(ns,'path');
    path.setAttribute('d',`M${ix1},${iy1} L${x1},${y1} A${r},${r} 0 ${largeArc},1 ${x2},${y2} L${ix2},${iy2} A${inner},${inner} 0 ${largeArc},0 ${ix1},${iy1} Z`);
    path.setAttribute('fill',col);path.setAttribute('stroke','#fff');path.setAttribute('stroke-width','1');
    svg.appendChild(path);
    startAngle=end;

    // Legend
    const row=document.createElement('div');
    row.className='donut-leg-row';
    row.innerHTML=`<div class="donut-dot" style="background:${col}"></div>
      <div class="donut-leg-name">${sub}</div>
      <div class="donut-leg-pct">${Math.round(pct*100)}%</div>
      <div class="donut-leg-mins">&nbsp;${Math.floor(mins/60)}h${mins%60}m</div>`;
    legend.appendChild(row);
  });
}

function renderStudyLogList(){
  const el=document.getElementById('studyLogList');
  el.innerHTML='';
  // Show ALL logs, newest first ‚Äî never auto-delete
  const logs=[...S.studylogs].reverse();
  if(!logs.length){el.innerHTML='<p style="color:#9ca3af;font-size:12px;text-align:center;padding:10px;">No study logs yet ‚Äî start your first session!</p>';return;}

  // Add header note about linked deletion
  const note=document.createElement('div');
  note.style.cssText='font-family:"Bebas Neue",sans-serif;font-size:9px;color:#9ca3af;letter-spacing:1px;padding:6px 0 10px;text-align:center;';
  note.textContent='üîó Deleting a session removes its journal entry & reverses streak if applicable';
  el.appendChild(note);

  // Group by date for readability
  let lastDay='';
  logs.forEach(l=>{
    const dayStr=new Date(l.date).toLocaleDateString('en-US',{weekday:'long',month:'short',day:'numeric',year:'numeric'});
    if(dayStr!==lastDay){
      const sep=document.createElement('div');
      sep.style.cssText="font-family:'Bebas Neue',sans-serif;font-size:9px;color:#9ca3af;letter-spacing:2px;padding:8px 0 4px;margin-top:4px;border-bottom:1px dashed #e5e7eb;";
      sep.textContent=dayStr.toUpperCase();
      el.appendChild(sep);
      lastDay=dayStr;
    }
    const row=document.createElement('div');
    row.style.cssText='padding:10px 0;border-bottom:1px solid #f0fdf4;display:flex;align-items:center;gap:10px;';
    const col=SUBJECT_COLORS[getSubjectColor(l.subject)];
    const h=Math.floor(l.totalMins/60),m=l.totalMins%60;
    const streakBadge=l.gainedStreak?`<span style="font-family:'Bebas Neue',sans-serif;font-size:9px;background:#dcfce7;color:#16a34a;padding:2px 5px;border-radius:4px;margin-left:4px;">+1 STREAK</span>`:'';
    const linkedBadge=l.bundleId?`<span style="font-family:'Bebas Neue',sans-serif;font-size:8px;color:#9ca3af;margin-left:2px;" title="Linked to journal">üîó</span>`:'';
    row.innerHTML=`<div style="width:6px;height:36px;border-radius:3px;background:${col};flex-shrink:0;"></div>
      <div style="flex:1;">
        <div style="font-weight:700;font-size:13px;color:#14532d;">${l.subject||'General'}${linkedBadge}${streakBadge}</div>
        <div style="font-family:'Bebas Neue',sans-serif;font-size:10px;color:#6b7280;">${l.startTime?l.startTime+(l.endTime?'‚Äì'+l.endTime:''):''}</div>
        ${l.notes?`<div style="font-size:11px;color:#6b7280;margin-top:2px;">${(l.notes||'').substring(0,60)}${(l.notes||'').length>60?'‚Ä¶':''}</div>`:''}
      </div>
      <div style="display:flex;flex-direction:column;align-items:flex-end;gap:6px;">
        <span style="font-family:'Bebas Neue',sans-serif;font-size:12px;color:#16a34a;font-weight:700;">${h>0?h+'h ':''}${m}m</span>
        <button onclick="deleteStudyLog(${l.id||0})" style="background:none;border:none;color:#ef4444;cursor:pointer;font-size:15px;padding:0;" title="Delete session (also removes journal entry)">üóë</button>
      </div>`;
    el.appendChild(row);
  });

  // Show permanent total at the bottom
  const totalH=Math.floor((S.totalMins||0)/60),totalM=(S.totalMins||0)%60;
  const totalEl=document.createElement('div');
  totalEl.style.cssText='margin-top:14px;padding:12px;background:linear-gradient(135deg,#f0fdf4,#dcfce7);border-radius:10px;text-align:center;';
  totalEl.innerHTML=`<div style="font-family:'Bebas Neue',sans-serif;font-size:11px;color:#6b7280;letter-spacing:2px;">üèÜ ALL-TIME STUDY TOTAL (NEVER RESETS)</div>
    <div style="font-family:'Bebas Neue',sans-serif;font-size:28px;color:#14532d;margin-top:4px;">${totalH}h ${totalM>0?totalM+'m':''}</div>
    <div style="font-family:'Space Mono',monospace;font-size:9px;color:#9ca3af;margin-top:2px;">Your motivation never disappears, even if streak resets</div>`;
  el.appendChild(totalEl);
}

function deleteStudyLog(id){
  // Find by id, get bundleId if available, otherwise do legacy delete
  const log=S.studylogs.find(l=>l.id===id);
  if(!log){return;}
  if(log.bundleId){
    deleteBundleById(log.bundleId);
    return;
  }
  // Legacy fallback (old logs without bundleId)
  if(!confirm('Delete this study log? This action cannot be undone.'))return;
  S.studylogs=S.studylogs.filter(l=>l.id!==id);
  sv(K.STUDYLOGS,S.studylogs);idbSet(K.STUDYLOGS,S.studylogs);
  renderStudyLogList();showToast('üóë Log deleted');
}

function resetAnalytics(){
  if(!confirm('Reset ALL study log data? This permanently deletes every session you have ever logged.\n\nNote: Your all-time hour total will also reset.'))return;
  if(!confirm('‚ö†Ô∏è FINAL WARNING: This cannot be undone. Delete ALL analytics data forever?'))return;
  S.studylogs=[];sv(K.STUDYLOGS,[]);idbSet(K.STUDYLOGS,[]);
  // Also clear journal entries of type 'study' since logs are gone
  S.journal=S.journal.filter(e=>e.type!=='study');sv(K.JOURNAL,S.journal);idbSet(K.JOURNAL,S.journal);
  // Reset permanent total since all logs are gone
  S.totalMins=0;sv(K.TOTALMINS,0);idbSet(K.TOTALMINS,0);
  renderAnalytics();updateHero();showToast('üîÑ Analytics data cleared');
}

const subjectColorMap={};
let subColorIdx=0;
function getSubjectColor(sub){
  if(subjectColorMap[sub]===undefined){subjectColorMap[sub]=subColorIdx%SUBJECT_COLORS.length;subColorIdx++;}
  return subjectColorMap[sub];
}

// ===== GRID =====
let curGridSize = 90;

function setGridTab(size, btn) {
  curGridSize = size;
  document.querySelectorAll('.grid-tab').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  renderGrids();
  checkAchievedBanners();
}

function buildBorderMap(rows, cols, mask) {
  const map = {};
  const add = (r, c, side) => {
    const k = r + ',' + c;
    if (!map[k]) map[k] = '';
    if (!map[k].includes(side)) map[k] += side;
  };
  for (let r = 0; r < rows; r++) {
    for (let c = 0; c < cols; c++) {
      if (!mask[r] || !mask[r][c]) continue; // only process filled cells
      // Only add thick border where a filled cell meets a hollow cell (not at grid edge)
      if (r > 0      && mask[r-1] && !mask[r-1][c]) add(r, c, 'T');
      if (r < rows-1 && mask[r+1] && !mask[r+1][c]) add(r, c, 'B');
      if (c > 0      && mask[r]   && !mask[r][c-1]) add(r, c, 'L');
      if (c < cols-1 && mask[r]   && !mask[r][c+1]) add(r, c, 'R');
    }
  }
  return map;
}

function makeRectGrid(startDay, rows, cols, cellSize, fontSize, borderMap, maxDay, mask) {
  const table = document.createElement('table');
  table.className = 'grid-table';
  table.style.borderCollapse = 'collapse';

  // Sequential day counter ‚Äî only advances for mask=1 cells (like NoBeep app)
  let dayCounter = startDay;

  for (let r = 0; r < rows; r++) {
    const tr = document.createElement('tr');
    for (let c = 0; c < cols; c++) {
      const td = document.createElement('td');
      const isDigitCell = mask ? !!(mask[r] && mask[r][c]) : true;

      td.style.width  = cellSize + 'px';
      td.style.height = cellSize + 'px';
      td.style.fontSize = fontSize + 'px';
      td.style.textAlign = 'center';
      td.style.verticalAlign = 'middle';
      td.style.fontFamily = "'Bebas Neue', sans-serif";
      td.style.boxSizing = 'border-box';

      if (!isDigitCell) {
        // Completely invisible ‚Äî no background, no border
        td.style.background = 'transparent';
        td.style.border = 'none';
        td.style.color = 'transparent';
      } else {
        const dayNum = dayCounter++;
        td.style.border = '1px solid #ccc';
        td.style.background = '#fff';
        td.style.color = '#bbb';

        if (dayNum > maxDay) {
          td.style.background = '#f8fffe';
          td.style.borderColor = '#e8f5e9';
          td.style.color = 'transparent';
        } else {
          td.textContent = dayNum;
          if (dayNum <= S.streak) {
            td.style.background = '#22c55e';
            td.style.color = '#fff';
            td.style.fontWeight = '700';
            td.style.borderColor = '#16a34a';
          } else if (dayNum === S.streak + 1) {
            td.style.border = '2px solid #ef4444';
            td.style.color = '#ef4444';
            td.style.fontWeight = '700';
          }
        }

        // Thick digit-outline border on boundary edges
        const key = r + ',' + c;
        if (borderMap && borderMap[key]) {
          const sides = borderMap[key];
          if (sides.includes('T')) td.style.borderTop    = '3px solid #14532d';
          if (sides.includes('B')) td.style.borderBottom = '3px solid #14532d';
          if (sides.includes('L')) td.style.borderLeft   = '3px solid #14532d';
          if (sides.includes('R')) td.style.borderRight  = '3px solid #14532d';
        }
      }

      tr.appendChild(td);
    }
    table.appendChild(tr);
  }

  const block = document.createElement('div');
  block.className = 'grid-block';
  block.appendChild(table);
  return block;
}

function renderGrids() {
  const gw = document.getElementById('gridWrapper');
  gw.innerHTML = '';

  if (curGridSize === 90) {
    // Exactly matching NoBeep image:
    // Both digits are 6 cols √ó 9 rows, numbers interleave row-by-row:
    //   Row 0: "9"[1-6]   + "0"[7-12]
    //   Row 1: "9"[13-18] + "0"[19-24]
    //   Row 2: "9"[25,26,27,28] + "0"[29,30,31,32]
    //   Row 3: "9"[33-36] + "0"[37-40]
    //   Row 4: "9"[41-46] + "0"[47,48,49,50]
    //   Row 5: "9"[51-56] + "0"[57,58,59,60]
    //   Row 6: "9"[61,62] + "0"[63,64,65,66]
    //   (gap row in "9", "0" continues)
    //   Row 7: "9"[67-72] + "0"[73-78]
    //   Row 8: "9"[79-84] + "0"[85-90]
    // Total: "9"=6+6+4+4+6+6+2+6+6=46, "0"=6+6+4+4+4+4+4+6+6=44. 46+44=90 ‚úì

    const cs = 42, fs = 11;

    // NOBEEP EXACT CELL MAP (verified digit by digit):
    //
    // "9" shape ‚Äî 6 cols, split into top-block + bottom-block:
    //   Top block rows 0-6:
    //     r0: [1,1,1,1,1,1]  ‚Üí 1,2,3,4,5,6
    //     r1: [1,1,1,1,1,1]  ‚Üí 13,14,15,16,17,18
    //     r2: [1,1,0,0,1,1]  ‚Üí 25,26,_,_,27,28
    //     r3: [1,1,0,0,1,1]  ‚Üí 33,34,_,_,35,36
    //     r4: [1,1,1,1,1,1]  ‚Üí 41,42,43,44,45,46
    //     r5: [1,1,1,1,1,1]  ‚Üí 51,52,53,54,55,56
    //     r6: [0,0,0,0,1,1]  ‚Üí _,_,_,_,61,62
    //   Bottom block rows 7-8 (shifted left, only 4 cols wide):
    //     r7: [1,1,1,1,0,0]  ‚Üí 67,68,69,70,71,72  (NoBeep bottom box is 6 wide but LEFT-aligned under cols 0-3, and 71,72 align with 61,62)
    //     r8: [1,1,1,1,0,0]  ‚Üí 79,80,81,82,83,84
    //
    // "0" shape ‚Äî 6 cols, single block:
    //     r0: [1,1,1,1,1,1]  ‚Üí 7,8,9,10,11,12
    //     r1: [1,1,1,1,1,1]  ‚Üí 19,20,21,22,23,24
    //     r2: [1,1,0,0,1,1]  ‚Üí 29,30,_,_,31,32
    //     r3: [1,1,0,0,1,1]  ‚Üí 37,38,_,_,39,40
    //     r4: [1,1,0,0,1,1]  ‚Üí 47,48,_,_,49,50
    //     r5: [1,1,0,0,1,1]  ‚Üí 57,58,_,_,59,60
    //     r6: [1,1,0,0,1,1]  ‚Üí 63,64,_,_,65,66
    //     r7: [1,1,1,1,1,1]  ‚Üí 73,74,75,76,77,78
    //     r8: [1,1,1,1,1,1]  ‚Üí 85,86,87,88,89,90
    //
    // Numbering is INTERLEAVED row by row: all "9" row cells first, then all "0" row cells
    // "9" total = 6+6+4+4+6+6+2+6+6 = 46, "0" total = 6+6+4+4+4+4+4+6+6 = 44. Sum = 90 ‚úì

    const mask9a = [ // top block rows 0-6
      [1,1,1,1,1,1],
      [1,1,1,1,1,1],
      [1,1,0,0,1,1],
      [1,1,0,0,1,1],
      [1,1,1,1,1,1],
      [1,1,1,1,1,1],
      [0,0,0,0,1,1],
    ];
    const mask9b = [ // bottom block rows 7-8 (full 6 cols)
      [1,1,1,1,1,1],
      [1,1,1,1,1,1],
    ];
    const m0_90 = [
      [1,1,1,1,1,1],
      [1,1,1,1,1,1],
      [1,1,0,0,1,1],
      [1,1,0,0,1,1],
      [1,1,0,0,1,1],
      [1,1,0,0,1,1],
      [1,1,0,0,1,1],
      [1,1,1,1,1,1],
      [1,1,1,1,1,1],
    ];

    function makeCell90(dayNum, r, c, borderMap) {
      const td = document.createElement('td');
      td.style.width = cs+'px'; td.style.height = cs+'px';
      td.style.fontSize = fs+'px'; td.style.textAlign = 'center';
      td.style.verticalAlign = 'middle';
      td.style.fontFamily = "'Bebas Neue',sans-serif";
      td.style.boxSizing = 'border-box';
      if (dayNum === null) {
        td.style.background = 'transparent';
        td.style.border = 'none';
      } else {
        td.style.border = '1px solid #ccc';
        td.style.background = '#fff';
        td.style.color = '#bbb';
        td.textContent = dayNum;
        if (dayNum <= S.streak) {
          td.style.background='#22c55e'; td.style.color='#fff';
          td.style.fontWeight='700'; td.style.borderColor='#16a34a';
        } else if (dayNum === S.streak+1) {
          td.style.border='2px solid #ef4444';
          td.style.color='#ef4444'; td.style.fontWeight='700';
        }
        const key = r+','+c;
        if (borderMap && borderMap[key]) {
          const s = borderMap[key];
          if (s.includes('T')) td.style.borderTop='3px solid #14532d';
          if (s.includes('B')) td.style.borderBottom='3px solid #14532d';
          if (s.includes('L')) td.style.borderLeft='3px solid #14532d';
          if (s.includes('R')) td.style.borderRight='3px solid #14532d';
        }
      }
      return td;
    }

    const bm9a = buildBorderMap(7, 6, mask9a);
    const bm9b = buildBorderMap(2, 6, mask9b);
    const bm0  = buildBorderMap(9, 6, m0_90);

    const tbl9a = document.createElement('table');
    const tbl9b = document.createElement('table');
    const tbl0  = document.createElement('table');
    [tbl9a,tbl9b,tbl0].forEach(t=>{t.style.borderCollapse='collapse';});

    let day = 1;

    // Rows 0-6: "9a" and "0" interleaved
    for (let r = 0; r < 7; r++) {
      const tr9 = document.createElement('tr');
      const tr0 = document.createElement('tr');
      for (let c=0;c<6;c++) tr9.appendChild(makeCell90(mask9a[r][c]?day++:null, r, c, bm9a));
      for (let c=0;c<6;c++) tr0.appendChild(makeCell90(m0_90[r][c]?day++:null, r, c, bm0));
      tbl9a.appendChild(tr9);
      tbl0.appendChild(tr0);
    }
    // day=67

    // Rows 7-8: "9b" and "0" interleaved
    for (let r = 0; r < 2; r++) {
      const tr9 = document.createElement('tr');
      const tr0 = document.createElement('tr');
      for (let c=0;c<6;c++) tr9.appendChild(makeCell90(mask9b[r][c]?day++:null, r, c, null));
      for (let c=0;c<6;c++) tr0.appendChild(makeCell90(m0_90[7+r][c]?day++:null, 7+r, c, bm0));
      tbl9b.appendChild(tr9);
      tbl0.appendChild(tr0);
    }
    // day=91

    // "9" = two separate bordered boxes, gap = one cell height between them
    const div9 = document.createElement('div');
    div9.style.cssText = `display:inline-flex;flex-direction:column;vertical-align:top;margin-right:8px;`;
    // Apply borders: tbl9a has outer border except bottom
    // tbl9b has outer border except top, PLUS partial top border only on cols 0-3 row 0
    tbl9a.style.cssText = 'border-collapse:collapse;';
    tbl9b.style.cssText = 'border-collapse:collapse;';

    // Manually add outer borders to each cell of tbl9a
    const rows9a = tbl9a.querySelectorAll('tr');
    rows9a.forEach((tr, r) => {
      tr.querySelectorAll('td').forEach((td, c) => {
        if (r === 0) td.style.borderTop = '3px solid #14532d';
        // Left border: only on rows 0-5 (full rows), and row 6 only on col 4 (first filled cell)
        if (c === 0 && r < 6) td.style.borderLeft = '3px solid #14532d';
        if (c === 4 && r === 6) td.style.borderLeft = '3px solid #14532d';
        if (c === 5) td.style.borderRight = '3px solid #14532d';
      });
    });

    // Manually add outer borders to each cell of tbl9b
    const rows9b = tbl9b.querySelectorAll('tr');
    rows9b.forEach((tr, r) => {
      tr.querySelectorAll('td').forEach((td, c) => {
        if (r === rows9b.length - 1) td.style.borderBottom = '3px solid #14532d';
        if (c === 0) td.style.borderLeft = '3px solid #14532d';
        if (c === 5) td.style.borderRight = '3px solid #14532d';
        // top border only on cols 0-3 of row 0 (above 67-70, not above 71-72)
        if (r === 0 && c <= 3) td.style.borderTop = '3px solid #14532d';
      });
    });
    div9.appendChild(tbl9a);
    div9.appendChild(tbl9b);

    // "0" = single continuous box, same height as "9" top block (rows 0-8 = 9 rows)
    const div0 = document.createElement('div');
    div0.style.cssText = 'display:inline-block;vertical-align:top;border:3px solid #14532d;line-height:0;';
    tbl0.style.cssText = 'border-collapse:collapse;';
    div0.appendChild(tbl0);

    gw.appendChild(div9);
    gw.appendChild(div0);

  } else if (curGridSize === 180) {
    // NOBEEP 180 exact ‚Äî interleaved row by row across "1", "8", "0"
    //
    // "1" = 5 cols wide:
    //   Row 0:  [0,1,1,1,0]  ‚Üí 1,2,3          (3 cells ‚Äî top serif, cols 1-3)
    //   Row 1:  [1,1,1,1,0]  ‚Üí 20,21,22,23    (4 cells ‚Äî left bump + stem)
    //   Rows 2-8: [0,1,1,1,0] ‚Üí 3 cells each  (stem only, cols 1-3)
    //   Row 9:  [0,1,1,1,0]  ‚Üí 3 cells
    //   Row 10: [0,1,1,1,0]  ‚Üí 3 cells
    //   Bottom box (detached):
    //   Row 11: [1,1,1,1,1]  ‚Üí 5 cells (139-143 area)
    //   Row 12: [1,1,1,1,1]  ‚Üí 5 cells (160-164 area)
    //
    // "8" = 8 cols wide:
    //   Row 0:  [1,1,1,1,1,1,1,1]  ‚Üí 8 cells (top bar)
    //   Row 1:  [1,1,0,0,0,0,1,1]  ‚Üí 4 cells
    //   Rows 2-3: [1,1,0,0,0,0,1,1] ‚Üí 4 cells each
    //   Row 4:  [1,1,1,1,1,1,1,1]  ‚Üí 8 cells (middle bar)
    //   Row 5:  [1,1,0,0,0,0,1,1]  ‚Üí 4 cells
    //   Rows 6-9: [1,1,0,0,0,0,1,1] ‚Üí 4 cells each
    //   Row 10: [1,1,1,1,1,1,1,1]  ‚Üí 8 cells (bottom bar)
    //   Row 11-12: same as "0" alignment rows
    //
    // "0" = 8 cols wide:
    //   Row 0:  [1,1,1,1,1,1,1,1]  ‚Üí 8 cells (top bar)
    //   Rows 1-9: [1,1,0,0,0,0,1,1] ‚Üí 4 cells each
    //   Row 10: [1,1,1,1,1,1,1,1]  ‚Üí 8 cells (bottom bar)
    //
    // Counting from image:
    // "1" row0=3, row1=4, rows2-10=3√ó9=27 ‚Üí top=34 + bottom box=10 = 44... need to recount
    //
    // ACTUAL count from image numbers:
    // "1": 1-3(row0=3) + 20-23(row1=4) + 40-43(row2=4? no, "1" has only cols 1-3 in rows 2+)
    //
    // Let me retrace exactly:
    // Row 0: "1"=[_,1,2,3,_]=3, "8"=[4..11]=8, "0"=[12..19]=8  ‚Üí total 19
    // Row 1: "1"=[20,21,22,23,_]=4, "8"=[24..31]=8, "0"=[32..39]=8 ‚Üí total 20
    // Row 2: "1"=[40,41,42,43,_]=4, "8"=[44,45,_,_,_,_,46,47]=4, "0"=[48,49,_,_,_,_,50,51]=4 ‚Üí 12
    // Row 3: "1"=[52,53,54,55,_]=4, "8"=[56,57,_,_,_,_,58,59]=4, "0"=[60,61,_,_,_,_,62,63]=4 ‚Üí 12
    // Row 4: "1"=[64,65,66,67,_]=4, "8"=[68,69,_,_,_,_,70,71]=4, "0"=[72,73,_,_,_,_,74,75]=4 ‚Üí 12
    // Row 5: "1"=[_,76,77,78,_]=3, "8"=[79,80,81,82,83,84,85,86]=8, "0"=[87,88,_,_,_,_,89,90]=4 ‚Üí 15
    // Row 6: "1"=[_,91,92,93,_]=3, "8"=[94,95,96,97,98,99,100,101]=8, "0"=[102,103,_,_,_,_,104,105]=4 ‚Üí 15
    // Row 7: "1"=[_,106,107,108,_]=3, "8"=[109,110,_,_,_,_,111,112]=4, "0"=[113,114,_,_,_,_,115,116]=4 ‚Üí 11
    // Row 8: "1"=[_,117,118,119,_]=3, "8"=[120,121,_,_,_,_,122,123]=4, "0"=[124,125,_,_,_,_,126,127]=4 ‚Üí 11
    // Row 9: "1"=[_,128,129,130,_]=3, "8"=[131,132,_,_,_,_,133,134]=4, "0"=[135,136,_,_,_,_,137,138]=4 ‚Üí 11
    // Row 10: "1"=[_,_,_,_,_]=0(gap), "8"=[144,145,146,147,148,149,150,151]=8, "0"=[152,153,154,155,156,157,158,159]=8 ‚Üí 16
    // Row 11: "1"=[_,_,_,_,_]=0(gap), "8"=[165,166,167,168,169,170,171,172]=8, "0"=[173,174,175,176,177,178,179,180]=8 ‚Üí 16
    // "1" bottom box (detached, rows 10-11):
    //   Row 10: [139,140,141,142,143]=5
    //   Row 11: [160,161,162,163,164]=5
    //
    // "1" total: 3+4+4+4+4+3+3+3+3+3+5+5 = 48... let me recheck
    // From image: "1" last cell = 164, "8" last = 172, "0" last = 180
    // "1" cells: rows0-9 + bottom box
    //   row0=3, row1=4, rows2-4=4√ó3=12, rows5-9=3√ó5=15, bottom=5+5=10 ‚Üí 3+4+12+15+10=44
    // "8" cells: row0=8, rows1-4(hollow)=4√ó4=16, row5(mid bar, wait...)
    //   Actually "8" middle bar is at row 5: [79-86]=8 cells
    //   rows1-4 = 4√ó4=16 (hollow sides), row5=8(mid), rows6-9=4√ó4=16(hollow), rows10-11=8+8=16(bottom)
    //   = 8+16+8+16+8+8 = 64... 
    // Need to verify: "8" starts at 4, ends at 172. Count=172-4+1=169... no that includes gaps
    //
    // FINAL APPROACH: Just use the masks and let the counter work
    // "1" mask (13 rows √ó 5 cols), with rows 10-11 as detached bottom
    // "8" mask (12 rows √ó 8 cols)  
    // "0" mask (12 rows √ó 8 cols)
    // All three interleaved row by row

    const cs = 24, fs = 8;

    // "1" mask: 12 rows √ó 5 cols
    // Row 0:  cols 1,2,3 filled (top)
    // Row 1:  cols 0,1,2,3 filled (left notch)
    // Rows 2-4: cols 0,1,2,3 filled
    // Row 5-9:  cols 1,2,3 filled (stem only)
    // Rows 10-11: all 5 cols (bottom box ‚Äî detached)
    const mask1_180 = [
      [0,1,1,1,0], // r0: 1,2,3
      [1,1,1,1,0], // r1: 20,21,22,23
      [1,1,1,1,0], // r2: 40,41,42,43
      [1,1,1,1,0], // r3: 52,53,54,55
      [1,1,1,1,0], // r4: 64,65,66,67
      [0,1,1,1,0], // r5: 76,77,78
      [0,1,1,1,0], // r6: 91,92,93
      [0,1,1,1,0], // r7: 106,107,108
      [0,1,1,1,0], // r8: 117,118,119
      [0,1,1,1,0], // r9: 128,129,130
      [1,1,1,1,1], // r10: 139,140,141,142,143 (bottom box)
      [1,1,1,1,1], // r11: 160,161,162,163,164
    ];

    // "8" mask: 12 rows √ó 8 cols
    const mask8_180 = [
      [1,1,1,1,1,1,1,1], // r0: top bar
      [1,1,0,0,0,0,1,1], // r1: sides
      [1,1,0,0,0,0,1,1], // r2
      [1,1,0,0,0,0,1,1], // r3
      [1,1,0,0,0,0,1,1], // r4
      [1,1,1,1,1,1,1,1], // r5: middle bar
      [1,1,1,1,1,1,1,1], // r6: middle bar (2 rows thick)
      [1,1,0,0,0,0,1,1], // r7
      [1,1,0,0,0,0,1,1], // r8
      [1,1,0,0,0,0,1,1], // r9
      [1,1,1,1,1,1,1,1], // r10: bottom bar
      [1,1,1,1,1,1,1,1], // r11: bottom bar (2 rows thick)
    ];

    // "0" mask: 12 rows √ó 8 cols
    const mask0_180 = [
      [1,1,1,1,1,1,1,1], // r0: top bar
      [1,1,0,0,0,0,1,1], // r1
      [1,1,0,0,0,0,1,1], // r2
      [1,1,0,0,0,0,1,1], // r3
      [1,1,0,0,0,0,1,1], // r4
      [1,1,0,0,0,0,1,1], // r5
      [1,1,0,0,0,0,1,1], // r6
      [1,1,0,0,0,0,1,1], // r7
      [1,1,0,0,0,0,1,1], // r8
      [1,1,0,0,0,0,1,1], // r9
      [1,1,1,1,1,1,1,1], // r10: bottom bar
      [1,1,1,1,1,1,1,1], // r11: bottom bar (2 rows thick)
    ];

    // Verify counts:
    // "1": 3+4+4+4+4+3+3+3+3+3+5+5 = 48
    // "8": 8+4+4+4+4+8+8+4+4+4+8+8 = 68
    // "0": 8+4+4+4+4+4+4+4+4+4+8+8 = 64
    // Total: 48+68+64 = 180 ‚úì

    function makeCell180(dayNum, r, c, borderMap) {
      const td = document.createElement('td');
      td.style.cssText = `width:${cs}px;height:${cs}px;font-size:${fs}px;text-align:center;vertical-align:middle;font-family:'Bebas Neue',sans-serif;box-sizing:border-box;`;
      if (dayNum === null) {
        td.style.background = 'transparent';
        td.style.border = 'none';
      } else {
        td.style.border = '1px solid #ccc';
        td.style.background = '#fff';
        td.style.color = '#bbb';
        td.textContent = dayNum;
        if (dayNum <= S.streak) {
          td.style.background='#22c55e'; td.style.color='#fff';
          td.style.fontWeight='700'; td.style.borderColor='#16a34a';
        } else if (dayNum === S.streak+1) {
          td.style.border='2px solid #ef4444';
          td.style.color='#ef4444'; td.style.fontWeight='700';
        }
        const key = r+','+c;
        if (borderMap && borderMap[key]) {
          const s = borderMap[key];
          if (s.includes('T')) td.style.borderTop='3px solid #14532d';
          if (s.includes('B')) td.style.borderBottom='3px solid #14532d';
          if (s.includes('L')) td.style.borderLeft='3px solid #14532d';
          if (s.includes('R')) td.style.borderRight='3px solid #14532d';
        }
      }
      return td;
    }

    const bm1 = buildBorderMap(12, 5, mask1_180);
    const bm8 = buildBorderMap(12, 8, mask8_180);
    const bm0_180 = buildBorderMap(12, 8, mask0_180);

    // "1" is split: tbl1a (rows 0-9, top section) + tbl1b (rows 10-11, bottom box)
    // "8" and "0" are single tables (rows 0-11)
    const tbl1a = document.createElement('table');
    const tbl1b = document.createElement('table');
    const tbl8  = document.createElement('table');
    const tbl0_180 = document.createElement('table');
    [tbl1a,tbl1b,tbl8,tbl0_180].forEach(t=>t.style.borderCollapse='collapse');

    let day180 = 1;

    // Rows 0-9: interleave "1"top + "8" + "0"
    for (let r = 0; r < 10; r++) {
      const tr1 = document.createElement('tr');
      const tr8 = document.createElement('tr');
      const tr0 = document.createElement('tr');
      for (let c=0;c<5;c++) tr1.appendChild(makeCell180(mask1_180[r][c]?day180++:null, r, c, bm1));
      for (let c=0;c<8;c++) tr8.appendChild(makeCell180(mask8_180[r][c]?day180++:null, r, c, bm8));
      for (let c=0;c<8;c++) tr0.appendChild(makeCell180(mask0_180[r][c]?day180++:null, r, c, bm0_180));
      tbl1a.appendChild(tr1);
      tbl8.appendChild(tr8);
      tbl0_180.appendChild(tr0);
    }

    // Rows 10-11: interleave "1"bottom + "8" + "0"
    for (let r = 0; r < 2; r++) {
      const tr1 = document.createElement('tr');
      const tr8 = document.createElement('tr');
      const tr0 = document.createElement('tr');
      for (let c=0;c<5;c++) tr1.appendChild(makeCell180(mask1_180[10+r][c]?day180++:null, 10+r, c, bm1));
      for (let c=0;c<8;c++) tr8.appendChild(makeCell180(mask8_180[10+r][c]?day180++:null, 10+r, c, bm8));
      for (let c=0;c<8;c++) tr0.appendChild(makeCell180(mask0_180[10+r][c]?day180++:null, 10+r, c, bm0_180));
      tbl1b.appendChild(tr1);
      tbl8.appendChild(tr8);
      tbl0_180.appendChild(tr0);
    }

    // Assemble "1": top + gap + bottom box (same pattern as "9" in 90-grid)
    const div1 = document.createElement('div');
    div1.style.cssText = 'display:inline-flex;flex-direction:column;vertical-align:top;margin-right:8px;';
    tbl1a.style.cssText = 'border-collapse:collapse;';
    tbl1b.style.cssText = 'border-collapse:collapse;';

    // Apply outer borders cell-by-cell for tbl1a
    tbl1a.querySelectorAll('tr').forEach((tr, r) => {
      tr.querySelectorAll('td').forEach((td, c) => {
        if (!mask1_180[r][c]) {
          td.style.border = 'none';
          return;
        }
        if (r === 0) td.style.borderTop = '3px solid #14532d';
        // NO bottom border on row 9 ‚Äî hollow space below
        if (c === 0 || !mask1_180[r][c-1]) td.style.borderLeft = '3px solid #14532d';
        if (c === 4 || !mask1_180[r][c+1]) td.style.borderRight = '3px solid #14532d';
      });
    });

    // Apply outer borders for tbl1b ‚Äî NO top border (hollow space above)
    tbl1b.querySelectorAll('tr').forEach((tr, r) => {
      tr.querySelectorAll('td').forEach((td, c) => {
        // NO top border on row 0 ‚Äî hollow space above
        if (r === 1) td.style.borderBottom = '3px solid #14532d';
        if (c === 0) td.style.borderLeft = '3px solid #14532d';
        if (c === 4) td.style.borderRight = '3px solid #14532d';
      });
    });

    div1.appendChild(tbl1a);
    div1.appendChild(tbl1b);

    const div8 = document.createElement('div');
    div8.style.cssText = 'display:inline-block;vertical-align:top;border:3px solid #14532d;margin-right:8px;';
    tbl8.style.cssText = 'border-collapse:collapse;';
    div8.appendChild(tbl8);

    const div0_180 = document.createElement('div');
    div0_180.style.cssText = 'display:inline-block;vertical-align:top;border:3px solid #14532d;';
    tbl0_180.style.cssText = 'border-collapse:collapse;';
    div0_180.appendChild(tbl0_180);

    gw.appendChild(div1);
    gw.appendChild(div8);
    gw.appendChild(div0_180);

  } else {
    // NOBEEP 365 ‚Äî exact replica, interleaved row by row across "3", "6", "5"
    // Each digit is 9 cols wide, 17 rows tall
    //
    // Row-by-row cell count (verified from image):
    // r0:  3=[9] 6=[9] 5=[9]  ‚Üí 27  (1-27)
    // r1:  3=[9] 6=[9] 5=[9]  ‚Üí 27  (28-54)
    // r2:  3=[9] 6=[9] 5=[9]  ‚Üí 27  (55-81)
    // r3:  3=[6] 6=[6] 5=[3]  ‚Üí 15  (82-96)
    // r4:  3=[3] 6=[3] 5=[3]  ‚Üí  9  (97-105)
    // r5:  3=[3] 6=[3] 5=[3]  ‚Üí  9  (106-114)
    // r6:  3=[3] 6=[3] 5=[3]  ‚Üí  9  (115-123)
    // r7:  3=[8] 6=[9] 5=[9]  ‚Üí 26  (124-149)
    // r8:  3=[8] 6=[9] 5=[9]  ‚Üí 26  (150-175)
    // r9:  3=[8] 6=[9] 5=[9]  ‚Üí 26  (176-201)
    // r10: 3=[8] 6=[9] 5=[9]  ‚Üí 26  (202-227)
    // r11: 3=[3] 6=[6] 5=[3]  ‚Üí 12  (228-239)
    // r12: 3=[3] 6=[6] 5=[3]  ‚Üí 12  (240-251)
    // r13: 3=[3] 6=[6] 5=[3]  ‚Üí 12  (252-263) ‚Äî "5" right cols only
    // r14: 3=[6] 6=[9] 5=[9]  ‚Üí 24  (264-287) ‚Äî "3" detached left(267-269)+right(270-272)... 
    //      actually r14: "3"left=[267,268,269]=3 + "3"right=[270,271,272]=3=6, "6"=[9], "5"=[9]
    // r15: 3=[9] 6=[9] 5=[9]  ‚Üí 27  (285+...)
    // r16: 3=[9] 6=[9] 5=[9]  ‚Üí 27
    // r17: 3=[9] 6=[9] 5=[9]  ‚Üí 27  (last = 365)
    //
    // MASKS (9 cols each, 18 rows):
    // "3":
    //   r0-2:  full [1,1,1,1,1,1,1,1,1]
    //   r3:    [1,1,1,0,0,0,1,1,1]  left3+right3
    //   r4-6:  [0,0,0,0,0,0,1,1,1]  right3 only
    //   r7-10: [0,1,1,1,1,1,1,1,1]  8 (col0 empty)
    //   r11-13:[0,0,0,0,0,0,1,1,1]  right3
    //   r14:   [1,1,1,0,0,0,1,1,1]  detached left3 + right3 = 6
    //   r15-17:[1,1,1,1,1,1,1,1,1]  full 9
    //
    // "6":
    //   r0-2:  full [1,1,1,1,1,1,1,1,1]
    //   r3:    [1,1,1,0,0,0,1,1,1]
    //   r4-6:  [1,1,1,0,0,0,0,0,0]  left3 only
    //   r7-10: full [1,1,1,1,1,1,1,1,1]
    //   r11-13:[1,1,1,0,0,0,1,1,1]
    //   r14-17:[1,1,1,1,1,1,1,1,1]  full
    //
    // "5":
    //   r0-2:  full [1,1,1,1,1,1,1,1,1]
    //   r3:    [1,1,1,0,0,0,0,0,0]  left3 only
    //   r4-6:  [1,1,1,0,0,0,0,0,0]  left3 only
    //   r7-10: full [1,1,1,1,1,1,1,1,1]
    //   r11-13:[0,0,0,0,0,0,1,1,1]  right3 only
    //   r14:   detached: "5" left box [1,1,1,0,0,0,0,0,0] + right [0,0,0,0,0,0,1,1,1]
    //          = [1,1,1,0,0,0,1,1,1]
    //   r15-17:[1,1,1,1,1,1,1,1,1]  full

    const cs = 30, fs = 10;

    const mask3_365 = [
      [1,1,1,1,1,1,1,1,1], // r0
      [1,1,1,1,1,1,1,1,1], // r1
      [1,1,1,1,1,1,1,1,1], // r2
      [1,1,1,0,0,0,1,1,1], // r3
      [0,0,0,0,0,0,1,1,1], // r4
      [0,0,0,0,0,0,1,1,1], // r5
      [0,0,0,0,0,0,1,1,1], // r6
      [0,1,1,1,1,1,1,1,1], // r7
      [0,1,1,1,1,1,1,1,1], // r8
      [0,1,1,1,1,1,1,1,1], // r9
      [0,1,1,1,1,1,1,1,1], // r10
      [0,0,0,0,0,0,1,1,1], // r11
      [0,0,0,0,0,0,1,1,1], // r12
      [0,0,0,0,0,0,1,1,1], // r13
      [1,1,1,0,0,0,1,1,1], // r14 detached left box + right
      [1,1,1,1,1,1,1,1,1], // r15
      [1,1,1,1,1,1,1,1,1], // r16
      [1,1,1,1,1,1,1,1,1], // r17
    ];

    const mask6_365 = [
      [1,1,1,1,1,1,1,1,1], // r0
      [1,1,1,1,1,1,1,1,1], // r1
      [1,1,1,1,1,1,1,1,1], // r2
      [1,1,1,0,0,0,1,1,1], // r3
      [1,1,1,0,0,0,0,0,0], // r4
      [1,1,1,0,0,0,0,0,0], // r5
      [1,1,1,0,0,0,0,0,0], // r6
      [1,1,1,1,1,1,1,1,1], // r7
      [1,1,1,1,1,1,1,1,1], // r8
      [1,1,1,1,1,1,1,1,1], // r9
      [1,1,1,1,1,1,1,1,1], // r10
      [1,1,1,0,0,0,1,1,1], // r11
      [1,1,1,0,0,0,1,1,1], // r12
      [1,1,1,0,0,0,1,1,1], // r13
      [1,1,1,1,1,1,1,1,1], // r14
      [1,1,1,1,1,1,1,1,1], // r15
      [1,1,1,1,1,1,1,1,1], // r16
      [1,1,1,1,1,1,1,1,1], // r17
    ];

    const mask5_365 = [
      [1,1,1,1,1,1,1,1,1], // r0
      [1,1,1,1,1,1,1,1,1], // r1
      [1,1,1,1,1,1,1,1,1], // r2
      [1,1,1,0,0,0,0,0,0], // r3
      [1,1,1,0,0,0,0,0,0], // r4
      [1,1,1,0,0,0,0,0,0], // r5
      [1,1,1,0,0,0,0,0,0], // r6
      [1,1,1,1,1,1,1,1,1], // r7
      [1,1,1,1,1,1,1,1,1], // r8
      [1,1,1,1,1,1,1,1,1], // r9
      [1,1,1,1,1,1,1,1,1], // r10
      [0,0,0,0,0,0,1,1,1], // r11
      [0,0,0,0,0,0,1,1,1], // r12
      [0,0,0,0,0,0,1,1,1], // r13
      [1,1,1,0,0,0,1,1,1], // r14 detached left box + right
      [1,1,1,1,1,1,1,1,1], // r15
      [1,1,1,1,1,1,1,1,1], // r16
      [1,1,1,1,1,1,1,1,1], // r17
    ];

    // Verify counts:
    // "3": 9+9+9+6+3+3+3+8+8+8+8+3+3+3+6+9+9+9 = 117
    // "6": 9+9+9+6+3+3+3+9+9+9+9+6+6+6+9+9+9+9 = 138
    // "5": 9+9+9+3+3+3+3+9+9+9+9+3+3+3+6+9+9+9 = 117
    //       Wait: 117+138+117 = 372... too many
    // Need to recount from image: last cell = 365
    // "3" ends at 347, "6" ends at 356, "5" ends at 365
    // Total filled = 365 ‚úì (interleaved counter stops at 365)

    function makeCell365(dayNum, r, c, borderMap) {
      const td = document.createElement('td');
      td.style.cssText = `width:${cs}px;height:${cs}px;font-size:${fs}px;text-align:center;vertical-align:middle;font-family:'Bebas Neue',sans-serif;box-sizing:border-box;`;
      if (dayNum === null) {
        td.style.background = 'transparent';
        td.style.border = 'none';
      } else {
        td.style.border = '1px solid #ccc';
        td.style.background = '#fff';
        td.style.color = '#bbb';
        td.textContent = dayNum;
        if (dayNum <= S.streak) {
          td.style.background='#22c55e'; td.style.color='#fff';
          td.style.fontWeight='700'; td.style.borderColor='#16a34a';
        } else if (dayNum === S.streak+1) {
          td.style.border='2px solid #ef4444';
          td.style.color='#ef4444'; td.style.fontWeight='700';
        }
        const key = r+','+c;
        if (borderMap && borderMap[key]) {
          const s = borderMap[key];
          if (s.includes('T')) td.style.borderTop='3px solid #14532d';
          if (s.includes('B')) td.style.borderBottom='3px solid #14532d';
          if (s.includes('L')) td.style.borderLeft='3px solid #14532d';
          if (s.includes('R')) td.style.borderRight='3px solid #14532d';
        }
      }
      return td;
    }

    // Use single tables for all 3 digits ‚Äî no splitting, avoids gap line
    const bm3 = buildBorderMap(18, 9, mask3_365);
    const bm6 = buildBorderMap(18, 9, mask6_365);
    const bm5 = buildBorderMap(18, 9, mask5_365);

    const tbl3 = document.createElement('table');
    const tbl6 = document.createElement('table');
    const tbl5 = document.createElement('table');
    [tbl3,tbl6,tbl5].forEach(t=>{ t.style.borderCollapse='collapse'; t.style.borderSpacing='0'; });

    let day365 = 1;

    for (let r = 0; r < 18; r++) {
      const tr3 = document.createElement('tr');
      const tr6 = document.createElement('tr');
      const tr5 = document.createElement('tr');
      for (let c=0;c<9;c++) tr3.appendChild(makeCell365(mask3_365[r][c]?day365++:null, r, c, bm3));
      for (let c=0;c<9;c++) tr6.appendChild(makeCell365(mask6_365[r][c]?day365++:null, r, c, bm6));
      for (let c=0;c<9;c++) tr5.appendChild(makeCell365(mask5_365[r][c]?day365++:null, r, c, bm5));
      tbl3.appendChild(tr3);
      tbl6.appendChild(tr6);
      tbl5.appendChild(tr5);
    }

    // Apply outer borders for all filled cells on all 3 single tables
    function applyBorders365Single(tbl, mask) {
      tbl.querySelectorAll('tr').forEach((tr, r) => {
        tr.querySelectorAll('td').forEach((td, c) => {
          if (!mask[r][c]) return;
          // top outer: no filled cell above
          if (r === 0 || !mask[r-1][c]) td.style.borderTop = '3px solid #14532d';
          // bottom outer: no filled cell below
          if (r === 17 || !mask[r+1][c]) td.style.borderBottom = '3px solid #14532d';
          // left outer: no filled cell to the left
          if (c === 0 || !mask[r][c-1]) td.style.borderLeft = '3px solid #14532d';
          // right outer: no filled cell to the right
          if (c === 8 || !mask[r][c+1]) td.style.borderRight = '3px solid #14532d';
        });
      });
    }

    applyBorders365Single(tbl3, mask3_365);
    applyBorders365Single(tbl6, mask6_365);
    applyBorders365Single(tbl5, mask5_365);

    // "6" gets full border via div wrapper
    const div6 = document.createElement('div');
    div6.style.cssText = 'display:inline-block;vertical-align:top;border:3px solid #14532d;margin-right:4px;';
    tbl6.style.cssText = 'border-collapse:collapse;border-spacing:0;';
    div6.appendChild(tbl6);

    // "3" assembled ‚Äî single table, no split
    const div3 = document.createElement('div');
    div3.style.cssText = 'display:inline-block;vertical-align:top;margin-right:4px;';
    tbl3.style.cssText = 'border-collapse:collapse;border-spacing:0;';
    div3.appendChild(tbl3);

    // "5" assembled ‚Äî single table, no split
    const div5 = document.createElement('div');
    div5.style.cssText = 'display:inline-block;vertical-align:top;';
    tbl5.style.cssText = 'border-collapse:collapse;border-spacing:0;';
    div5.appendChild(tbl5);

    gw.appendChild(div3);
    gw.appendChild(div6);
    gw.appendChild(div5);
  }
}

function checkAchievedBanners(){
  document.getElementById('banner90').className='achieved-banner'+(S.streak>=90?' show':'');
  document.getElementById('banner180').className='achieved-banner'+(S.streak>=180?' show':'');
  document.getElementById('banner365').className='achieved-banner'+(S.streak>=365?' show':'');
}

// ===== SUCCESS CARD =====
function showSuccessCard(){
  const b=getCurBadge();
  const todayMins=getTodayLoggedMins();
  const th=Math.floor(todayMins/60),tm=todayMins%60;
  const o=document.createElement('div');
  o.className='success-overlay';
  o.innerHTML=`<div class="success-card">
    <div class="success-emoji-big">${b.emoji}</div>
    <div class="success-title">4H GOAL HIT! üî•</div>
    <div class="success-big-num">${S.streak}</div>
    <div class="success-sub">DAYS STRONG</div>
    <div class="success-badge">${b.name}</div>
    <div style="font-family:'Bebas Neue',sans-serif;font-size:10px;color:#6b7280;margin-top:6px;">${th}h${tm>0?tm+'m':''} studied today</div>
    <button class="success-close-btn" onclick="this.parentElement.parentElement.remove()">KEEP GOING! üîó</button>
  </div>`;
  document.body.appendChild(o);
}

// ===== JOURNAL =====
function renderJournal(){
  const list=document.getElementById('journalList');
  list.innerHTML='';

  const sortVal=document.getElementById('journalSort')?.value||'newest';
  const dateFilter=document.getElementById('journalDateFilter')?.value||'';

  let entries=[...S.journal];
  if(dateFilter){
    entries=entries.filter(e=>{
      const d=e.dateISO||(e.ts?new Date(e.ts).toISOString().split('T')[0]:'');
      return d===dateFilter;
    });
  }
  entries.sort((a,b)=>sortVal==='newest'?(b.ts||0)-(a.ts||0):(a.ts||0)-(b.ts||0));

  if(!entries.length){
    list.innerHTML='<p style="text-align:center;color:#9ca3af;padding:20px;font-size:13px;">'+(dateFilter?'No entries on this date.':'No entries yet. Start writing!')+'</p>';
    return;
  }

  entries.forEach((e,i)=>{
    const isStudy=e.type==='study';
    const isBreak=e.type==='break';
    const isEntry=!isStudy&&!isBreak;

    const dotColor=isBreak?'#ef4444':isStudy?'var(--green)':'#3b82f6';
    const typeLabel=isStudy?'STUDY':isBreak?'CHAIN BROKEN':'JOURNAL';

    // Build a clean one-line preview ‚Äî strip the [subject ¬∑ time] prefix for study logs
    let preview=e.text||'';
    if(isStudy) preview=preview.replace(/^\[.*?\]\s*/,'').trim();
    if(isBreak){
      // For break entries, show compact: "Lost X days ¬∑ missed: date"
      preview=`Lost ${e.lostStreak||0} days ¬∑ ${e.missedDates&&e.missedDates.length?e.missedDates.slice(0,2).join(', '):''}`;
    }

    // Time display for study logs
    let timeStr='';
    if(isStudy&&e.startTime&&e.endTime) timeStr=e.startTime+'‚Äì'+e.endTime;

    // Short date: "Feb 21" 
    let shortDate='';
    try{
      const d=new Date(e.ts||e.dateISO);
      shortDate=d.toLocaleDateString('en-US',{month:'short',day:'numeric'});
    }catch(err){}

    const el=document.createElement('div');
    el.className='journal-entry-card'+(isBreak?' type-break':isStudy?' type-study':' type-entry');
    el.innerHTML=`
      <div class="jec-left">
        <div class="jec-top">
          <div class="jec-type-dot" style="background:${dotColor}"></div>
          <span class="jec-type-label">${typeLabel}</span>
          ${e.subject?`<span class="jec-subject">¬∑ ${e.subject}</span>`:''}
        </div>
        <div class="jec-preview">${preview||'(no text)'}</div>
        <div class="jec-bottom">
          <span class="jec-date">${shortDate} ¬∑ ${e.streak||0}d üî•</span>
          ${timeStr?`<span class="jec-time">${timeStr}</span>`:''}
        </div>
      </div>
      <div class="jec-right">
        <button class="jec-del" onclick="event.stopPropagation();deleteJournalLinked(${e.id||e.ts||i},${isStudy?'true':'false'})" title="Delete">üóë</button>
        ${isBreak?`<button onclick="event.stopPropagation();editBreakEntry(${e.id||e.ts||0})" style="background:none;border:none;font-size:11px;color:var(--dark-green);cursor:pointer;font-family:'Bebas Neue',sans-serif;" title="Add note">‚úèÔ∏è</button>`:''}
      </div>`;
    el.onclick=()=>openJournalDetail(e);
    list.appendChild(el);
  });
}

function openJournalDetail(e){
  const isStudy=e.type==='study';
  const isBreak=e.type==='break';
  const typeLabel=isStudy?'üìö STUDY LOG':isBreak?'üíî CHAIN BROKEN':'‚úèÔ∏è JOURNAL';
  document.getElementById('journalDetailTitle').textContent=typeLabel;
  // Short date only ‚Äî no repetition
  let shortDate='';
  try{const d=new Date(e.ts||e.dateISO);shortDate=d.toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric',year:'numeric'});}catch(err){}
  document.getElementById('journalDetailDate').textContent=shortDate.toUpperCase();
  // Render meta as styled chips
  const metaEl=document.getElementById('journalDetailStreak');
  const chip=(txt,bg,color)=>`<span style="display:inline-flex;align-items:center;padding:4px 10px;border-radius:20px;background:${bg};font-family:'Nunito',sans-serif;font-size:11px;font-weight:800;color:${color};letter-spacing:.3px;">${txt}</span>`;
  let chips='';
  if(e.streak||e.streak===0) chips+=chip(`${e.streak} days üî•`,'#f0fdf4','#14532d');
  if(e.subject) chips+=chip(e.subject,'#eff6ff','#1d4ed8');
  if(e.startTime) chips+=chip(e.startTime+(e.endTime?' ‚Äì '+e.endTime:''),'#fafafa','#6b7280');
  metaEl.innerHTML=chips||'';

  // For break entries: show compact info + user note if any
  let displayText=e.text||'';
  if(isBreak){
    displayText=`Lost ${e.lostStreak||0} days at badge: ${e.badgeName||'‚Äî'}\nMissed: ${e.missedStr||''}\n\nThe streak was reset to 0. What got in the way? What can you do differently?`;
    if(e.userNote) displayText+='\n\nüìù YOUR NOTE:\n'+e.userNote;
  } else if(isStudy){
    // Strip the [prefix] from display text
    displayText=displayText.replace(/^\[.*?\]\s*/,'');
  }
  document.getElementById('journalDetailText').textContent=displayText;
  document.getElementById('journalDetailModal').style.display='flex';
}
function closeJournalDetail(){
  document.getElementById('journalDetailModal').style.display='none';
}

function deleteJournalLinked(idOrTs, isStudyLinked){
  const entry=S.journal.find(e=>(e.id||e.ts)===idOrTs);
  if(!entry){showToast('‚ùå Entry not found');return;}

  // If it has a bundleId, use the atomic bundle delete
  if(entry.bundleId && isStudyLinked){
    deleteBundleById(entry.bundleId);
    return;
  }

  // Non-bundled or manual journal entries
  if(!confirm('Delete this journal entry? This cannot be undone.'))return;
  S.journal=S.journal.filter(e=>(e.id||e.ts)!==idOrTs);
  sv(K.JOURNAL,S.journal);
  renderJournal();showToast('üóë Deleted');
}

function editBreakEntry(idOrTs){
  const entry=S.journal.find(e=>(e.id||e.ts)===idOrTs);
  if(!entry)return;
  const note=prompt('Add a reason / reflection for this missed day:',entry.userNote||'');
  if(note===null)return;
  entry.userNote=note;
  sv(K.JOURNAL,S.journal);
  renderJournal();
  showToast('‚úèÔ∏è Note saved');
}

function saveJournal(){
  const text=document.getElementById('journalInput').value.trim();
  if(!text){showToast('‚úèÔ∏è Write something first!');return;}
  const now=new Date();
  S.journal.push({
    id:Date.now(),
    date:now.toLocaleDateString('en-US',{weekday:'long',year:'numeric',month:'long',day:'numeric'}),
    dateISO:now.toISOString().split('T')[0],
    text,streak:S.streak,ts:Date.now(),type:'entry'
  });
  sv(K.JOURNAL,S.journal);
  document.getElementById('journalInput').value='';
  renderJournal();
  showToast('üìì Entry saved!');
}

// ===== SETTINGS =====
function exportData(){
  const d={...S,exportDate:new Date().toISOString(),v:8};
  const b=new Blob([JSON.stringify(d,null,2)],{type:'application/json'});
  const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download='chain-backup-'+new Date().toISOString().split('T')[0]+'.json';a.click();
  markExported();
  showToast('‚úÖ Exported!');
}
function importData(ev){
  const f=ev.target.files[0];if(!f)return;
  if(!confirm('Import will replace all data. Continue?')){ev.target.value='';return;}
  const r=new FileReader();
  r.onload=e=>{
    try{
      const d=JSON.parse(e.target.result);
      S.streak=d.streak||0;S.last=d.last||null;S.dates=d.dates||[];
      S.journal=d.journal||[];S.gifs=d.gifs||{};S.cquotes=d.cquotes||[];
      S.notif=d.notif||false;S.rtimes=d.rtimes||[];S.revealed=d.revealed||{};
      S.studylogs=d.studylogs||[];S.breaks=d.breaks||[];
      S.totalMins=d.totalMins||S.studylogs.reduce((a,l)=>a+(l.totalMins||0),0);
      sv(K.STREAK,S.streak);sv(K.LAST,S.last);sv(K.DATES,S.dates);
      sv(K.JOURNAL,S.journal);sv(K.GIFS,S.gifs);sv(K.CQUOTES,S.cquotes);
      sv(K.NOTIF,S.notif);sv(K.RTIMES,S.rtimes);sv(K.REVEALED,S.revealed);sv(K.STUDYLOGS,S.studylogs);sv(K.BREAKS,S.breaks);sv(K.TOTALMINS,S.totalMins);
      syncToIDB();markExported();
      updateAll();renderJournal();renderGifSettings();renderCustomQuotes();
      showToast('‚úÖ Imported!');
    }catch{showToast('‚ùå Import failed');}
  };
  r.readAsText(f);ev.target.value='';
}
function resetStreak(){
  if(!confirm('Reset your streak? This cannot be undone!'))return;
  if(!confirm('REALLY? You will lose '+S.streak+' days!'))return;
  S.streak=0;S.last=null;S.dates=[];
  sv(K.STREAK,0);sv(K.LAST,null);sv(K.DATES,[]);
  updateAll();showToast('üîÑ Streak reset');
}

// ===== NOTIFICATIONS =====
async function toggleNotifications(){
  const t=document.getElementById('notifToggle');
  if(!S.notif){
    if(!('Notification' in window)){showToast('‚ùå Not supported');return;}
    const p=await Notification.requestPermission();
    if(p!=='granted'){showToast('‚ùå Enable notifications in browser settings');return;}
    S.notif=true;
  }else{S.notif=false;}
  sv(K.NOTIF,S.notif);
  t.className='toggle'+(S.notif?' on':'');
  document.getElementById('reminderSection').style.display=S.notif?'block':'none';
  showToast(S.notif?'üîî Notifications ON':'üîï Notifications OFF');
  if(S.notif)scheduleNotifs();
}
function scheduleNotifs(){
  if(!S.notif||Notification.permission!=='granted')return;
  S.rtimes.forEach(time=>{
    const[h,m]=time.split(':').map(Number);
    const now=new Date(),t=new Date();t.setHours(h,m,0,0);
    if(t<=now)t.setDate(t.getDate()+1);
    setTimeout(()=>{new Notification('CHAIN Reminder üîó',{body:`Keep the chain! Streak: ${S.streak} days üî•`});},t-now);
  });
}
function addReminder(){
  const v=document.getElementById('newReminderTime').value;if(!v)return;
  if(!S.rtimes.includes(v)){S.rtimes.push(v);S.rtimes.sort();sv(K.RTIMES,S.rtimes);}
  renderReminderTags();showToast('‚è∞ Added: '+v);if(S.notif)scheduleNotifs();
}
function removeReminder(t){S.rtimes=S.rtimes.filter(x=>x!==t);sv(K.RTIMES,S.rtimes);renderReminderTags();}
function renderReminderTags(){document.getElementById('reminderTags').innerHTML=S.rtimes.map(t=>`<span class="reminder-tag"><span>${t}</span><button onclick="removeReminder('${t}')">√ó</button></span>`).join('');}

// ===== CUSTOM QUOTES =====
function addCustomQuote(){
  const text=document.getElementById('quoteTextInput').value.trim();
  if(!text){showToast('üí¨ Enter quote text');return;}
  S.cquotes.push({text});
  sv(K.CQUOTES,S.cquotes);
  document.getElementById('quoteTextInput').value='';
  renderCustomQuotes();
  showToast('‚úÖ Quote added to daily inspiration!');
}
function removeCustomQuote(i){S.cquotes.splice(i,1);sv(K.CQUOTES,S.cquotes);renderCustomQuotes();}
function renderCustomQuotes(){
  document.getElementById('customQuotesList').innerHTML=S.cquotes.map((q,i)=>
    `<div class="custom-q-item"><div class="custom-q-text">"${q.text}"</div><button class="custom-q-del" onclick="removeCustomQuote(${i})">üóëÔ∏è</button></div>`
  ).join('')||'<p style="color:#9ca3af;font-size:12px;text-align:center;padding:10px;">No custom quotes yet</p>';
}

// ===== GIF SETTINGS =====
function renderGifSettings(){
  document.getElementById('gifSettings').innerHTML=BADGES.map(b=>
    `<div class="gif-item"><div class="gif-label">${b.emoji} DAY ${b.day}: ${b.name}</div>
    <input type="text" class="gif-input" placeholder="Paste GIF URL..."
      value="${S.gifs[b.day]||''}"
      onchange="S.gifs[${b.day}]=this.value;sv(K.GIFS,S.gifs);renderBadges();renderHeroGif();">
    </div>`
  ).join('');
}

// ===== SHARE =====
function shareApp(){
  if(navigator.share){navigator.share({title:'CHAIN',text:`I'm on a ${S.streak}-day chain! üîó`,url:window.location.href}).catch(()=>{});}
  else{navigator.clipboard&&navigator.clipboard.writeText(window.location.href).then(()=>showToast('üîó Link copied!'));}
}

// ===== PAGE NAV =====
function switchPage(pg,btn){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('page-'+pg).classList.add('active');
  btn.classList.add('active');
  window.scrollTo({top:0, behavior:'smooth'});
  if(navigator.vibrate) navigator.vibrate(8);
  if(pg==='journal'){ renderJournal(); renderDailyQuote(); }
  if(pg==='analytics') renderAnalytics();
}

// ===== TOAST =====
function showToast(msg){
  document.querySelector('.toast')?.remove();
  const t=document.createElement('div');t.className='toast';t.textContent=msg;
  document.body.appendChild(t);setTimeout(()=>{if(t.parentElement)t.remove();},2800);
}

// ===== SOUND + HAPTIC =====
function playSuccess(){
  // Haptic celebration pattern
  if(navigator.vibrate) navigator.vibrate([50,30,80,30,120]);
  try{
    const ctx=new(window.AudioContext||window.webkitAudioContext)();
    const g=ctx.createGain();g.connect(ctx.destination);
    [[523,.0],[659,.12],[784,.24],[1047,.38]].forEach(([freq,t])=>{
      const o=ctx.createOscillator();o.connect(g);
      o.frequency.value=freq;
      o.start(ctx.currentTime+t);o.stop(ctx.currentTime+t+.15);
    });
    g.gain.setValueAtTime(.18,ctx.currentTime);
    g.gain.exponentialRampToValueAtTime(.001,ctx.currentTime+.6);
  }catch(e){}
}

// ===== FIRE =====
function buildFire(){
  const c=document.getElementById('fireContainer');
  [[`3%`,70,190,'#ff3d00','1.3s',8,-3,3,.85,1.1,.7,.9],[`14%`,90,230,'#ff6b00','1.1s',6,-2,4,.9,1.1,.8,1],[`28%`,110,270,'#ff8c00','0.9s',4,-4,2,.88,1.2,.9,1],[`44%`,130,290,'#ff5722','1.0s',3,-2,3,.92,1.1,.85,1],[`59%`,100,250,'#ff6b00','1.2s',5,-3,5,.87,1.15,.8,.95],[`74%`,80,210,'#ff3d00','0.8s',7,-5,2,.9,1.1,.75,.9],[`22%`,55,160,'#ffb300','0.7s',1,-1,2,.95,1.05,.9,1],[`50%`,65,180,'#ffcc00','0.6s',0,-2,2,.96,1.08,.95,1],[`70%`,50,140,'#ff9800','0.75s',1,-1,3,.93,1.06,.88,1]].forEach(([l,w,h,col,dur,bl,r1,r2,sx,sy,o1,o2])=>{
    const el=document.createElement('div');el.className='flame';
    el.style.cssText=`left:${l};width:${w}px;height:${h}px;background:${col};--dur:${dur};--blur:${bl}px;--r1:${r1}deg;--r2:${r2}deg;--sx:${sx};--sy:${sy};--o1:${o1};--o2:${o2};`;
    c.appendChild(el);
  });
}

// ===== AUTO-RESET STREAK ON MISSED DAY =====
// Streak resets at 00:01 if:
//  a) User didn't log in at all yesterday (missed day), OR
//  b) User logged in but didn't reach 4h (failed the goal)
// Study HOURS are NEVER reset ‚Äî only the streak counter.
function checkAutoReset(){
  const now=new Date();
  const todayStr=now.toDateString();

  // Check if yesterday's goal was met
  const yesterday=new Date(now);
  yesterday.setDate(now.getDate()-1);
  const yStr=yesterday.toDateString();

  // If we have a streak, verify the chain is intact
  if(S.streak>0 && S.last){
    const lastDate=new Date(S.last);
    const lastStr=lastDate.toDateString();

    // If last check-in was today ‚Äî chain is live, nothing to reset
    if(lastStr===todayStr) return null;

    // If last check-in was yesterday ‚Äî still fine (we haven't missed today yet unless it's past midnight)
    if(lastStr===yStr) return null;

    // Last check-in was before yesterday ‚Äî chain is broken
    const msPerDay=86400000;
    const daysSinceLast=Math.floor((now-lastDate)/msPerDay);
    const missedDays=daysSinceLast-1;
    const lostStreak=S.streak;
    const badgeName=getCurBadge().name;

    const missedDates=[];
    for(let i=1;i<=Math.min(missedDays,7);i++){
      const d=new Date(lastDate.getTime()+i*msPerDay);
      missedDates.push(d.toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric'}));
    }
    const missedStr=missedDates.join(', ')+(missedDays>7?` ‚Ä¶+${missedDays-7} more`:'');

    const breakEntry={
      id:Date.now(),
      date:now.toLocaleDateString('en-US',{weekday:'long',year:'numeric',month:'long',day:'numeric'}),
      dateISO:now.toISOString().split('T')[0],
      text:`üíî CHAIN BROKEN after ${lostStreak} days (${badgeName})\n\nMissed: ${missedStr}\n\nThe streak was reset to 0. Study hours are preserved ‚Äî you studied hard. What got in the way? What can you do differently?`,
      streak:lostStreak,ts:Date.now(),type:'break',missedDays,
      missedDates,lostStreak,badgeName,reason:'missed_days'
    };
    S.journal.unshift(breakEntry);sv(K.JOURNAL,S.journal);

    const breakRecord={id:Date.now(),date:now.toISOString(),lostStreak,missedDays,missedStr,badgeName,reason:'missed_days'};
    S.breaks.push(breakRecord);sv(K.BREAKS,S.breaks);

    S.streak=0;S.last=null;S.dates=[];
    sv(K.STREAK,0);sv(K.LAST,null);sv(K.DATES,[]);
    syncToIDB();
    return{prevStreak:lostStreak,missedStr,missedDates,breakEntry,reason:'missed_days'};
  }

  return null;
}

// Check if yesterday the 4h goal was attempted but not met (failed streak)
// Called once at startup. If last activity was yesterday but <4h, show a motivational fail note.
function checkYesterdayFailed(){
  const now=new Date();
  const yesterday=new Date(now);yesterday.setDate(now.getDate()-1);
  const yStr=yesterday.toDateString();

  // Find yesterday's logs
  const yLogs=S.studylogs.filter(l=>new Date(l.date).toDateString()===yStr);
  if(!yLogs.length) return null;

  const yMins=yLogs.reduce((a,l)=>a+l.totalMins,0);
  // They studied but didn't hit 4h, and no streak was gained yesterday
  const yStreakGained=yLogs.some(l=>l.gainedStreak);
  if(yMins>0&&yMins<DAILY_GOAL_MINS&&!yStreakGained){
    return{yMins,yHours:Math.floor(yMins/60),yRem:yMins%60};
  }
  return null;
}

let pendingBreakInfo = null; // hold break info until intro animation finishes

function showBrokenModal(info){
  document.getElementById('brokenStreakNum').textContent = info.prevStreak;
  const missedLabel = info.missedDates.length === 1
    ? `Missed: ${info.missedDates[0]}`
    : `Missed ${info.missedDates.length > 1 ? info.missedDates.length + ' days: ' : ''}${info.missedDates.slice(0,3).join(', ')}${info.missedDates.length > 3 ? '‚Ä¶' : ''}`;
  document.getElementById('brokenMissedDate').textContent = missedLabel;
  document.getElementById('brokenChainModal').style.display = 'flex';
}

function closeBrokenModal(){
  document.getElementById('brokenChainModal').style.display = 'none';
}


async function init(){
  await restoreFromIDBIfNeeded();
  // Re-load state after potential IDB restore
  S.streak=ld(K.STREAK,0);S.last=ld(K.LAST,null);S.dates=ld(K.DATES,[]);
  S.journal=ld(K.JOURNAL,[]);S.gifs=ld(K.GIFS,{});S.cquotes=ld(K.CQUOTES,[]);
  S.notif=ld(K.NOTIF,false);S.rtimes=ld(K.RTIMES,['15:00','20:00','22:00']);
  S.revealed=ld(K.REVEALED,{});S.studylogs=ld(K.STUDYLOGS,[]);
  S.breaks=ld(K.BREAKS,[]);
  S.totalMins=ld(K.TOTALMINS,0);

  // --- Migrate old logs: compute totalMins from existing logs if missing ---
  if(!S.totalMins && S.studylogs.length){
    S.totalMins=S.studylogs.reduce((a,l)=>a+(l.totalMins||0),0);
    sv(K.TOTALMINS,S.totalMins);
  }

  // Initial IDB sync
  syncToIDB();
  // Check for missed day BEFORE showing app UI (so streak is reset when UI renders)
  pendingBreakInfo = checkAutoReset();
  const pendingYestFail = !pendingBreakInfo ? checkYesterdayFailed() : null;
  buildFire();
  setTimeout(()=>{
    const intro=document.getElementById('fire-intro');
    intro.classList.add('fade-out');
    setTimeout(()=>{
      intro.classList.add('gone');
      document.getElementById('app').classList.add('visible');
      updateAll();
      renderGifSettings();renderCustomQuotes();renderReminderTags();renderDailyQuote();
      if(S.notif){document.getElementById('notifToggle').classList.add('on');document.getElementById('reminderSection').style.display='block';scheduleNotifs();}
      checkExportReminder();
      // Show broken chain modal if a reset happened today
      if(pendingBreakInfo) setTimeout(()=>showBrokenModal(pendingBreakInfo), 400);
      // Show yesterday-failed toast if applicable
      else if(pendingYestFail) setTimeout(()=>{
        const{yHours,yRem}=pendingYestFail;
        showToast(`üìö Yesterday: ${yHours}h${yRem>0?yRem+'m':''} studied ‚Äî ${DAILY_GOAL_MINS/60-yHours}h short of streak. Hours saved üí™`);
      },600);
    },600);
  },3200);
  setInterval(updateTimer,1000);updateTimer();
  // Also re-check every minute in case app is left open past midnight
  setInterval(()=>{
    const info=checkAutoReset();
    if(info){updateAll();setTimeout(()=>showBrokenModal(info),200);}
    // Also update today's study status every minute
    renderTodayStudyStatus();
  },60000);
}

// ===== PWA =====
window.addEventListener('beforeinstallprompt',e=>{
  e.preventDefault();
  const b=document.createElement('div');
  b.style.cssText='position:fixed;bottom:85px;left:16px;right:16px;background:#14532d;color:#86efac;padding:14px;border-radius:14px;display:flex;align-items:center;gap:12px;z-index:500;box-shadow:0 4px 20px rgba(0,0,0,.15);';
  b.innerHTML=`<div style="flex:1"><div style="font-weight:700;font-size:14px;">üîó Install CHAIN</div><div style="font-size:11px;opacity:.7;margin-top:2px;">Add to home screen</div></div>
    <button onclick="e.prompt();this.parentElement.remove();" style="background:var(--green);color:#fff;border:none;border-radius:8px;padding:8px 14px;cursor:pointer;font-family:'Bebas Neue',sans-serif;font-weight:600;font-size:12px;letter-spacing:1px;">INSTALL</button>
    <button onclick="this.parentElement.remove();" style="background:none;border:none;color:#86efac;cursor:pointer;font-size:20px;">√ó</button>`;
  document.body.appendChild(b);
  setTimeout(()=>{if(b.parentElement)b.remove();},12000);
});

// ===== PWA MANIFEST (dynamic) =====
function injectManifest(){
  const manifest={
    name:'CHAIN ‚Äî Don\'t Break The Chain',
    short_name:'CHAIN',
    description:'Daily streak tracker. Log 4h of study, build your chain.',
    start_url:'.',
    display:'standalone',
    background_color:'#f0fdf4',
    theme_color:'#14532d',
    orientation:'portrait',
    icons:[
      {src:"data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'><rect width='192' height='192' rx='32' fill='%2314532d'/><text y='140' x='36' font-size='130'>üîó</text></svg>",sizes:'192x192',type:'image/svg+xml'},
      {src:"data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'><rect width='512' height='512' rx='80' fill='%2314532d'/><text y='380' x='80' font-size='350'>üîó</text></svg>",sizes:'512x512',type:'image/svg+xml'}
    ]
  };
  const blob=new Blob([JSON.stringify(manifest)],{type:'application/json'});
  const url=URL.createObjectURL(blob);
  document.getElementById('pwa-manifest').href=url;
}

if('serviceWorker' in navigator){
  const sw=`
const C='chain-v7';
const ASSETS=[self.location.href];
self.addEventListener('install',e=>{
  e.waitUntil(caches.open(C).then(c=>c.addAll(ASSETS)).then(()=>self.skipWaiting()));
});
self.addEventListener('activate',e=>{
  e.waitUntil(caches.keys().then(keys=>Promise.all(keys.filter(k=>k!==C).map(k=>caches.delete(k)))).then(()=>self.clients.claim()));
});
self.addEventListener('fetch',e=>{
  if(e.request.method!=='GET')return;
  if(e.request.url.includes('fonts.googleapis.com')||e.request.url.includes('fonts.gstatic.com')){
    e.respondWith(caches.open(C).then(c=>c.match(e.request).then(r=>r||(fetch(e.request).then(resp=>{c.put(e.request,resp.clone());return resp;})))));
    return;
  }
  e.respondWith(caches.match(e.request).then(r=>r||fetch(e.request).catch(()=>caches.match(self.location.href))));
});`;
  navigator.serviceWorker.register(URL.createObjectURL(new Blob([sw],{type:'application/javascript'}))).catch(()=>{});
}

window.addEventListener('DOMContentLoaded',()=>{injectManifest();init();});
</script>
</body>
</html>
